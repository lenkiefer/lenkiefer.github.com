<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="generator" content="Hugo 0.81.0" />

  <title>Analyzing mortgage data with R &middot; Len Kiefer</title>

  
  
  <link rel="stylesheet" href="https://cdn.bootcss.com/pure/0.6.2/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://cdn.bootcss.com/pure/0.6.2/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="/css/blackburn.css">

  
  <script async src="https://use.fontawesome.com/32c3d13def.js"></script>

  
  

  
  <link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/9.11.0/styles/androidstudio.min.css">
  <script src="//cdn.bootcss.com/highlight.js/9.11.0/highlight.min.js"></script>
  <script src="//cdn.bootcss.com/highlight.js/9.11.0/languages/r.min.js"></script>
  <script>hljs.configure({languages: []}); hljs.initHighlightingOnLoad();</script>
  

  <link rel="shortcut icon" href="http://lenkiefer.com/img/favicon.PNG" type="image/x-icon" />

  
  

</head>

<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  
  <a class="pure-menu-heading brand" href="/">Len Kiefer</a>


  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="/"><i class='fa fa-home fa-fw'></i>Home</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="/post/"><i class='fa fa-list fa-fw'></i>Archive</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="/about/"><i class='fa fa-user fa-fw'></i>About</a>
      
        </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://twitter.com/@lenkiefer" target="_blank"><i class="fa fa-twitter-square fa-fw"></i>Twitter</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://linkedin.com/in/leonard-kiefer-51175331" target="_blank"><i class="fa fa-linkedin-square fa-fw"></i>LinkedIn</a>
    </li>
    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://github.com/lenkiefer" target="_blank"><i class="fa fa-github-square fa-fw"></i>GitHub</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

  </ul>
</div>


  <div>
  <div class="small-print">
    <small>&copy; 2015-2018. All rights reserved.</small>
  </div>
  <div class="small-print">
    <small>Built with&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>


  <div id="main">


       <meta name="twitter:card" content="summary">
       <meta name="twitter:image" content="http://lenkiefer.com/img/logo/logo.png" >
    
    <meta property="og:title" content="Analyzing mortgage data with R">
    <meta property="og:description" content="TIME FOR ANOTHER DATA WRANGLING AND VISUALIZATION EXTRAVAGANZA. This time we are going to work hard to turn some big data into little data. That is, we’re going to work hard to aggregate several million loan level records into useful summary graphics to tell us about the U.S. mortgage market in 2016.
I’ve been working on a lot of different ways to visualize trends in the mortgage market (see here and here for examples).">

<div class="header">
  <h1>Analyzing mortgage data with R</h1>
  <h2></h2>
</div>
<div class="content">

  <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>2017/10/08</time>
  </div>

  

  

  
  
  
  <div>
    <i class="fa fa-tags fa-fw"></i>
    
      <a class="post-taxonomy-tag" href="http://lenkiefer.com/tags/mortgage">mortgage</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="http://lenkiefer.com/tags/housing">housing</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="http://lenkiefer.com/tags/dataviz">dataviz</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="http://lenkiefer.com/tags/r">R</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="http://lenkiefer.com/tags/data-wrangling">data wrangling</a>
    
  </div>
  
  

</div>

  


<p>TIME FOR ANOTHER DATA WRANGLING AND VISUALIZATION EXTRAVAGANZA. This time we are going to work hard to turn some big data into little data. That is, we’re going to work hard to aggregate several million loan level records into useful summary graphics to tell us about the U.S. mortgage market in 2016.</p>
<p>I’ve been working on a lot of different ways to visualize trends in the mortgage market (see <a href="../../../../2017/09/29/mortgage-origination-trends">here</a> and <a href="../../../../2017/10/05/mortgage-loan-size-distributions">here</a> for examples). Let’s add some more visualizations and some <a href="https://www.r-project.org/">R</a> code.</p>
<div id="the-data" class="section level1">
<h1>The data</h1>
<p>We’ll use the <a href="https://www.ffiec.gov/hmda/">Home Mortgage Disclosure (HMDA)</a> data.</p>
<p>These data provide the closest thing to a publicly-available comprehensive summary of U.S. mortgage market activity that we’ll get (for right now). The recently released data is for 2016 and provides a detailed view of mortgage market activity across the country.</p>
<p>We can load our data from a .csv file we get from U.S. Consumer Financial Protection Bureau’s <a href="https://www.consumerfinance.gov/data-research/hmda/">website</a>. Using their filters, I restricted my data to first-lien mortgage loans originated in 2016 for home purchase and refinance of 1-4 family properties. That should give you just over 7.5 million records. This <a href="https://www.consumerfinance.gov/data-research/hmda/explore#!/as_of_year=2016&amp;property_type=1&amp;action_taken=1&amp;loan_purpose=1,3&amp;section=filters">link</a> will take you to the CFPB webpage page with the filters I used. If you go to that page and click download (could take a while) you’ll end up with a file called <code>hmda_lar.csv</code>, which I have saved in a data directory.</p>
<p>Then, if you run this code you can prepare the data for our analysis.</p>
<div id="load-libraries" class="section level3">
<h3>Load libraries</h3>
<pre class="r"><code>#####################################################################################
## Load Libraries ##
#####################################################################################
library(tidyverse)
library(cowplot)
library(data.table)
library(ggridges)
library(viridis)
library(ggbeeswarm)
library(geofacet)
library(ggthemes)
library(scales)</code></pre>
</div>
<div id="prepare-the-data" class="section level3">
<h3>Prepare the data</h3>
<p>As these data are somewhat lage, we’ll use the <a href="https://github.com/Rdatatable/data.table/wiki">data.table()</a> package to wrangle our data.</p>
<pre class="r"><code>#####################################################################################
## prepare data ##
#####################################################################################
# Read in csv
mydata&lt;-fread(&quot;data/hmda_lar.csv&quot;)

# drop unused columns (keep the useful ones)
mydata&lt;-mydata[,list(state_name,state_abbr,county_name,owner_occupancy_name,
                     loan_amount_000s,loan_purpose_name,loan_type_name, 
                     agency_abbr,respondent_id,population, 
                     applicant_income_000s,msamd_name)]

# create some numeric variables
mydata &lt;- mydata[,&quot;:=&quot;(upb=as.numeric(loan_amount_000s),
                       inc=as.numeric(applicant_income_000s))]
mydata&lt;- mydata[, ratio:=upb/inc]

# create conventional flag
mydata &lt;- mydata[, conv:=ifelse(loan_type_name==&quot;Conventional&quot;,&quot;Conventional&quot;,&quot;Nonconventional&quot;)]
# create state flag for large states 
mydata &lt;- mydata[, st2:=ifelse(state_abbr %in% 
                       c(&quot;CA&quot;,&quot;TX&quot;,&quot;FL&quot;,&quot;NY&quot;,&quot;IL&quot;,&quot;CO&quot;,
                         &quot;GA&quot;,&quot;NC&quot;,&quot;OH&quot;,&quot;WA&quot;,&quot;MI&quot;, &quot;VA&quot;), 
                     state_abbr,&quot;other&quot;)][
                       ,.(upb=sum(upb),loans=.N), by=.(st2,loan_purpose_name)
                       ]

# create summary data

# state totals
sdata&lt;- mydata[ # drop missing income
                .(loans=.N,
                   upb=sum(upb),
                   inc=sum(inc,na.rm=T),
                   medinc=median(inc,na.rm=T),
                   medupb=median(upb,na.rm=T),
                   medrat=median(ratio, na.rm=T)),
               by=state_abbr]

sdata2&lt;-mydata[, # drop missing income, 
               .(loans=.N,
                   upb=sum(upb),
                   inc=sum(inc,na.rm=T),
                   medinc=median(inc,na.rm=T),
                   medupb=median(upb,na.rm=T),
                   medrat=median(ratio, na.rm=T)),
               by=.(state_abbr,loan_purpose_name)
               ]</code></pre>
</div>
<div id="examine-data" class="section level3">
<h3>Examine data</h3>
<p>Let’s take a look at the data.</p>
<pre class="r"><code># Header of mydata (large panel of HMDA loan level data)
knitr::kable(head(mydata))</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">state_name</th>
<th align="left">state_abbr</th>
<th align="left">county_name</th>
<th align="left">owner_occupancy_name</th>
<th align="left">loan_amount_000s</th>
<th align="left">loan_purpose_name</th>
<th align="left">loan_type_name</th>
<th align="left">agency_abbr</th>
<th align="left">respondent_id</th>
<th align="left">population</th>
<th align="left">applicant_income_000s</th>
<th align="left">msamd_name</th>
<th align="right">upb</th>
<th align="right">inc</th>
<th align="right">ratio</th>
<th align="left">conv</th>
<th align="left">st2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Texas</td>
<td align="left">TX</td>
<td align="left">Collin County</td>
<td align="left">Owner-occupied as a principal dwelling</td>
<td align="left">251</td>
<td align="left">Home purchase</td>
<td align="left">Conventional</td>
<td align="left">HUD</td>
<td align="left">0542409990</td>
<td align="left">7724</td>
<td align="left">110</td>
<td align="left">Dallas, Plano, Irving - TX</td>
<td align="right">251</td>
<td align="right">110</td>
<td align="right">2.281818</td>
<td align="left">Conventional</td>
<td align="left">TX</td>
</tr>
<tr class="even">
<td align="left">California</td>
<td align="left">CA</td>
<td align="left">Los Angeles County</td>
<td align="left">Owner-occupied as a principal dwelling</td>
<td align="left">542</td>
<td align="left">Refinancing</td>
<td align="left">Conventional</td>
<td align="left">HUD</td>
<td align="left">13-3654244</td>
<td align="left">2397</td>
<td align="left">85</td>
<td align="left">Los Angeles, Long Beach, Glendale - CA</td>
<td align="right">542</td>
<td align="right">85</td>
<td align="right">6.376471</td>
<td align="left">Conventional</td>
<td align="left">CA</td>
</tr>
<tr class="odd">
<td align="left">Georgia</td>
<td align="left">GA</td>
<td align="left">Forsyth County</td>
<td align="left">Owner-occupied as a principal dwelling</td>
<td align="left">65</td>
<td align="left">Refinancing</td>
<td align="left">Conventional</td>
<td align="left">CFPB</td>
<td align="left">0000480228</td>
<td align="left">2524</td>
<td align="left">38</td>
<td align="left">Atlanta, Sandy Springs, Roswell - GA</td>
<td align="right">65</td>
<td align="right">38</td>
<td align="right">1.710526</td>
<td align="left">Conventional</td>
<td align="left">GA</td>
</tr>
<tr class="even">
<td align="left">Florida</td>
<td align="left">FL</td>
<td align="left">Miami-Dade County</td>
<td align="left">Owner-occupied as a principal dwelling</td>
<td align="left">340</td>
<td align="left">Refinancing</td>
<td align="left">Conventional</td>
<td align="left">HUD</td>
<td align="left">7197000003</td>
<td align="left">6252</td>
<td align="left">138</td>
<td align="left">Miami, Miami Beach, Kendall - FL</td>
<td align="right">340</td>
<td align="right">138</td>
<td align="right">2.463768</td>
<td align="left">Conventional</td>
<td align="left">FL</td>
</tr>
<tr class="odd">
<td align="left">Pennsylvania</td>
<td align="left">PA</td>
<td align="left">Philadelphia County</td>
<td align="left">Owner-occupied as a principal dwelling</td>
<td align="left">221</td>
<td align="left">Refinancing</td>
<td align="left">FHA-insured</td>
<td align="left">HUD</td>
<td align="left">75-2921540</td>
<td align="left">2326</td>
<td align="left"></td>
<td align="left">Philadelphia - PA</td>
<td align="right">221</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="left">Nonconventional</td>
<td align="left">other</td>
</tr>
<tr class="even">
<td align="left">New York</td>
<td align="left">NY</td>
<td align="left">Monroe County</td>
<td align="left">Owner-occupied as a principal dwelling</td>
<td align="left">128</td>
<td align="left">Home purchase</td>
<td align="left">Conventional</td>
<td align="left">HUD</td>
<td align="left">16-1566654</td>
<td align="left">4501</td>
<td align="left">71</td>
<td align="left">Rochester - NY</td>
<td align="right">128</td>
<td align="right">71</td>
<td align="right">1.802817</td>
<td align="left">Conventional</td>
<td align="left">NY</td>
</tr>
</tbody>
</table>
<p>The data are read in as character variables, so I created some numeric versions and dropped some of the columns that we won’t be using here. The CFPB’s data file contains column headers and variable values that are pretty easy to work with.</p>
<p>We also created some summary data sets that will be useful later. Let’s take a look at one of them, <code>sdata</code>.</p>
<pre class="r"><code># state level summary)
knitr::kable(head(sdata[order(-loans)],5))</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">state_abbr</th>
<th align="right">loans</th>
<th align="right">upb</th>
<th align="right">inc</th>
<th align="right">medinc</th>
<th align="right">medupb</th>
<th align="right">medrat</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">CA</td>
<td align="right">1079884</td>
<td align="right">445349475</td>
<td align="right">150196718</td>
<td align="right">111</td>
<td align="right">350</td>
<td align="right">3.224138</td>
</tr>
<tr class="even">
<td align="left">TX</td>
<td align="right">554140</td>
<td align="right">122835110</td>
<td align="right">60301853</td>
<td align="right">93</td>
<td align="right">187</td>
<td align="right">2.156863</td>
</tr>
<tr class="odd">
<td align="left">FL</td>
<td align="right">466932</td>
<td align="right">107319889</td>
<td align="right">49193894</td>
<td align="right">79</td>
<td align="right">191</td>
<td align="right">2.484663</td>
</tr>
<tr class="even">
<td align="left">IL</td>
<td align="right">293000</td>
<td align="right">67423713</td>
<td align="right">33548109</td>
<td align="right">91</td>
<td align="right">187</td>
<td align="right">2.120690</td>
</tr>
<tr class="odd">
<td align="left">CO</td>
<td align="right">246136</td>
<td align="right">70200047</td>
<td align="right">25976865</td>
<td align="right">88</td>
<td align="right">255</td>
<td align="right">2.939024</td>
</tr>
</tbody>
</table>
<p>These data show some useful summary state level data. The variable <code>loans</code> is the total number of first lien purchase and refinance loans in the 2016 HMDA data for that state. <code>upb</code> is the sum of all loan amounts (in $1000s), while <code>inc</code> is the sum of all borrower income (in $1000s). The variables <code>medinc</code> and <code>medupb</code> are the median borrower income and median loan amounts, respectively. The variable <code>medrat</code> is the median loan amount-to-income ratio across first-lien home purchase and refinance borrowers in 2016.</p>
</div>
</div>
<div id="little-data" class="section level1">
<h1>Little data</h1>
<p>These are largish data, big for me, but small in comparison to some of the other datasets that are out there these days. We’re going to explore these data in detail. Let’s start with a <a href="https://twitter.com/EdwardTufte/status/495253350347460608">Little Data display</a> showing loan counts.</p>
<pre class="r"><code>#####################################################################################
## Plot summary data ##
#####################################################################################
g1&lt;-
  ggplot(data=mydata[ ,.(loans=.N),loan_purpose_name], 
       aes(y=loans,x=loan_purpose_name,fill=loan_purpose_name,
           label=paste0(comma(round(loans/1000000,1)),&quot;M&quot;)))+
  geom_col()+
  geom_col(data=mydata[,.(loans=.N,
                          loan_purpose_name=&quot;All&quot;),], fill=&quot;darkgray&quot;)+
  geom_text(data=mydata[,.(loans=.N,
                          loan_purpose_name=&quot;All&quot;),],
            vjust=1,size=6,color=&quot;white&quot;)+
  
  geom_text(vjust=1,size=6,color=&quot;white&quot;)+
  
  scale_fill_manual(name=&quot;  &quot;,values=c(&quot;darkgray&quot;,&quot;royalblue&quot;,&quot;forestgreen&quot;))+
  theme_minimal()+
  labs(x=&quot;loan purpose&quot;,y=&quot;&quot;,
       title=&quot;U.S. mortgage loans in 2016&quot;,
       subtitle=&quot;first-lien home purchase and refinance loans on 1-4 unit properties&quot;,
       caption=&quot;@lenkiefer Source: FFIEC, CFPB HMDA data (not adjusted for coverage)&quot;)+
  theme(plot.caption=element_text(hjust=0),
        legend.position=&quot;none&quot;,
        axis.text.y=element_blank(),
        plot.subtitle=element_text(size=14,face=&quot;italic&quot;,color=&quot;darkgray&quot;),
        plot.title=element_text(size=14,face=&quot;bold&quot;,color=&quot;black&quot;))

g1</code></pre>
<p><img src="/post/2017-10-08-analyzing-mortgage-data-with-r_files/figure-html/10-08-2017-plot-1-1.png" width="672" /></p>
<p>In 2016 HMDA data there were about 7.6 million first-lien home purchase and refinance loans on 1-4 unit properties. <em>NOTE: these numbers are not adjusted for coverage. HMDA does not cover all of the U.S. mortgage market, but the coverage is likely quite high (90% or more) in recent years.</em></p>
<p>About 3.9 million were home purchase and about 3.7 million were refinance loans. In the U.S. mortgage market it’s common to distinguish between conventional and nonconventional loans. Nonconventional loans are loans insured by the Federal Housing Administration (FHA), guaranteed by the Department of Veterans Affairs (VA) and loans backed by the Farm Service Agency (FSA) or Rural Housing Service (RHS).</p>
<pre class="r"><code># g2
g2&lt;-
  ggplot(data=mydata[ ,.(loans=.N), .(loan_purpose_name,conv)],
         aes(y=loans,x=loan_purpose_name,fill=loan_purpose_name,
             label=comma(round(loans/1000,0))))+
  geom_col()+
  geom_text(vjust=1,color=&quot;white&quot;)+
  scale_fill_manual(name=&quot;  &quot;,values=c(&quot;royalblue&quot;,&quot;forestgreen&quot;))+
  theme_minimal()+
  labs(x=&quot;loan purpose&quot;,y=&quot;loans (in 1000s)&quot;,
       title=&quot;U.S. mortgage loans in 2016&quot;,
       subtitle=&quot;first-lien home purchase and refinance loans on 1-4 unit properties&quot;,
       caption=&quot;@lenkiefer Source: FFIEC, CFPB HMDA data (not adjusted for coverage)&quot;)+
  theme(plot.caption=element_text(hjust=0),
        legend.position=&quot;none&quot;,
        axis.text.y=element_blank(),
        plot.subtitle=element_text(size=14,face=&quot;italic&quot;,color=&quot;darkgray&quot;),
        plot.title=element_text(size=14,face=&quot;bold&quot;,color=&quot;black&quot;))+
  facet_wrap(~conv)
g2</code></pre>
<p><img src="/post/2017-10-08-analyzing-mortgage-data-with-r_files/figure-html/10-08-2017-plot-2-1.png" width="672" /> We see here that while the total mortgage market had slightly more home purchase than refinance loans, conventional mortgages were skewed toward refiance loans.</p>
<p>Let’s look at these same data, but weighted by the size of loans. The chart below shows the aggregate dollar volume of home purchase and refinance loans brokend out by coventional and nonconventional loans.</p>
<pre class="r"><code>g3&lt;-
  ggplot(data=mydata[ ,.(upb=sum(upb)), .(loan_purpose_name,conv)],
         aes(y=upb,x=loan_purpose_name,fill=loan_purpose_name,
               label=comma(round(upb/1000000,0))))+
  geom_col()+
  geom_text(vjust=1,color=&quot;white&quot;)+
  scale_fill_manual(name=&quot;  &quot;,values=c(&quot;royalblue&quot;,&quot;forestgreen&quot;))+
  theme_minimal()+
  labs(x=&quot;loan purpose&quot;,y=&quot;$ in billions&quot;,
       title=&quot;U.S. mortgage loans in 2016&quot;,
       subtitle=&quot;first-lien home purchase and refinance loans on 1-4 unit properties&quot;,
       caption=&quot;@lenkiefer Source: FFIEC, CFPB HMDA data (not adjusted for coverage)&quot;)+
  theme(plot.caption=element_text(hjust=0),
        legend.position=&quot;none&quot;,
        axis.text.y=element_blank(),
        plot.subtitle=element_text(size=14,face=&quot;italic&quot;,color=&quot;darkgray&quot;),
        plot.title=element_text(size=14,face=&quot;bold&quot;,color=&quot;black&quot;))+
  facet_wrap(~conv)
  
g3</code></pre>
<p><img src="/post/2017-10-08-analyzing-mortgage-data-with-r_files/figure-html/10-08-2017-plot-3-1.png" width="672" /></p>
<div id="by-state" class="section level2">
<h2>By state</h2>
<p>It’s interesting to consider how mortgage activity varies by geography.</p>
<p>Let’s look at a breakdown by state. Get ready for a loooong plot.</p>
<pre class="r"><code>g4&lt;-
  ggplot(data=sdata2[order(loans),],
         aes(x=reorder(state_abbr,loans),
             y=loans,fill=loan_purpose_name))+
  geom_col()+coord_flip()+theme_minimal()+
  scale_y_continuous(expand=c(0,0),labels=comma)+
  labs(x=&quot;&quot;,y=&quot;loans&quot;,title=&quot;Single family mortgage loans by state in 2016&quot;,
       subtitle=&quot;first-lien home purchase and refinance loans (not adjusted for coverage)&quot;,
       caption=&quot;@lenkiefer Source: @lenkiefer Source: FFIEC, CFPB HMDA data&quot;)+
  scale_fill_manual(name=&quot;  &quot;,values=c(&quot;royalblue&quot;,&quot;forestgreen&quot;))+
  theme(plot.caption=element_text(hjust=0),
        legend.position=&quot;top&quot;,
        plot.subtitle=element_text(size=14,face=&quot;italic&quot;,color=&quot;darkgray&quot;),
        plot.title=element_text(size=14,face=&quot;bold&quot;,color=&quot;black&quot;))
g4</code></pre>
<p><img src="/post/2017-10-08-analyzing-mortgage-data-with-r_files/figure-html/10-08-2017-plot-4-1.png" width="672" /></p>
<p>Another way to look at state data is to use <a href="../../../../2017/05/22/geo-my-facet">geo_facets</a>. The plot below arranges the state data using geo faceting.</p>
<pre class="r"><code>g5&lt;-
  ggplot(data=sdata2[state_abbr !=&quot;PR&quot;], aes(x=loan_purpose_name,y=loans,
                        fill=loan_purpose_name,label=round(loans/1000,0)))+
  geom_col(position=&quot;dodge&quot;,alpha=0.75)+
  coord_flip()+
  geom_text(hjust=0,size=2)+
  scale_fill_manual(name=&quot;  &quot;,values=c(&quot;royalblue&quot;,&quot;forestgreen&quot;))+
  scale_y_continuous(expand=c(0,0),labels=comma,limits=c(0,9e5))+
  labs(x=&quot;&quot;,y=&quot;loans in thousands&quot;,title=&quot;Single family mortgage loans by state in 2016&quot;,
       subtitle=&quot;first-lien home purchase and refinance loans (1000s, not adjusted for coverage)&quot;,
       caption=&quot;@lenkiefer Source: FFIEC, CFPB HMDA data&quot; )+
  theme(legend.position=&quot;top&quot;,
        plot.subtitle=element_text(size=14,face=&quot;italic&quot;,color=&quot;darkgray&quot;),
        plot.title=element_text(size=16,face=&quot;bold&quot;,color=&quot;black&quot;,hjust=0),
        plot.caption=element_text(hjust=0))+
  facet_geo(~state_abbr)+theme_minimal()+
  theme(axis.text=element_blank(),
        legend.position=&quot;top&quot;)
g5</code></pre>
<p><img src="/post/2017-10-08-analyzing-mortgage-data-with-r_files/figure-html/10-08-2017-plot-5-1.png" width="864" /></p>
<p>The U.S. mortgage market is dominated by several large states, California in particular. Let’s just look at the top 12 states and group the smaller states into an other category. We’ll also use <code>cowplot::plot_grid()</code> to arrange the plots.</p>
<pre class="r"><code>sdata4&lt;-mydata[, st2:=ifelse(state_abbr %in% 
                               c(&quot;CA&quot;,&quot;TX&quot;,&quot;FL&quot;,&quot;NY&quot;,&quot;IL&quot;,&quot;CO&quot;,
                                 &quot;GA&quot;,&quot;NC&quot;,&quot;OH&quot;,&quot;WA&quot;,&quot;MI&quot;, &quot;VA&quot;), 
                     state_abbr,&quot;other&quot;)][
                       ,.(upb=sum(upb),loans=.N), by=.(st2,loan_purpose_name)
                     ]


g6a&lt;-
  ggplot(data=sdata4[st2 !=&quot;other&quot;,], aes(x=loan_purpose_name,y=loans,
                        fill=paste(loan_purpose_name,&quot; &quot;),label=round(loans/1000,0)))+
  geom_col(position=&quot;dodge&quot;,alpha=0.75)+
  coord_flip()+
  geom_text(hjust=0,size=2.5)+
  scale_fill_manual(name=&quot;  &quot;,values=c(&quot;royalblue&quot;,&quot;forestgreen&quot;))+
  scale_y_continuous(expand=c(0,0),labels=comma,limit=c(0,9e5))+
  labs(x=&quot;&quot;,y=&quot;loans in thousands&quot;,title=&quot;Single family mortgage loans by state in 2016&quot;,
       subtitle=&quot;first-lien home purchase and refinance loans (1000s, not adjusted for coverage)&quot;)+
  facet_wrap(~st2)+theme_minimal()+
  theme(axis.text=element_blank(),
        legend.position=&quot;bottom&quot;)


g6b&lt;-
  ggplot(data=sdata4[st2 ==&quot;other&quot;,], aes(x=loan_purpose_name,y=loans,
                                        fill=loan_purpose_name,
                                        label=comma(round(loans/1000,0))))+
  geom_col(position=&quot;dodge&quot;,alpha=0.75)+
  coord_flip()+
  geom_text(hjust=0,size=2.5)+
  scale_fill_manual(name=&quot;  &quot;,values=c(&quot;royalblue&quot;,&quot;forestgreen&quot;))+
  scale_y_continuous(expand=c(0,0),labels=comma,limit=c(0,2e6))+
  labs(x=&quot;&quot;,y=&quot;loans in thousands&quot;,
       title=&quot;Single family mortgage loans by state in 2016&quot;,
       subtitle=&quot;first-lien home purchase and refinance loans (1000s, not adjusted for coverage)&quot;)+
  theme_minimal()+
  theme(axis.text=element_blank(),
        legend.position=&quot;top&quot;)

# use cowplot::plot_grid to arrange plots
plot_grid(g6a,g6b+theme(legend.position=&quot;none&quot;)+labs(title=&quot;All other states&quot;)+
            labs(caption=&quot;@lenkiefer Source: FFIEC, CFPB HMDA data&quot;)+
            theme(plot.caption=element_text(hjust=0)),
          ncol=1,rel_heights=c(3,1))</code></pre>
<p><img src="/post/2017-10-08-analyzing-mortgage-data-with-r_files/figure-html/10-08-2017-plot-6-1.png" width="672" /></p>
</div>
</div>
<div id="boxplots" class="section level1">
<h1>Boxplots</h1>
<p>Let’s try to move a litle beyond little data displays. Let’s use boxplots to look at the distribution of mortgage loan size by states.</p>
<pre class="r"><code>mydata&lt;-mydata[,st2:=ifelse(state_abbr %in% 
                               c(&quot;CA&quot;,&quot;TX&quot;,&quot;FL&quot;,&quot;NY&quot;,&quot;IL&quot;,&quot;CO&quot;,
                                 &quot;GA&quot;,&quot;NC&quot;,&quot;OH&quot;,&quot;WA&quot;,&quot;MI&quot;, &quot;VA&quot;), 
                     state_abbr,&quot;other&quot;)]

g7&lt;-
  ggplot(data=mydata[upb !=9999,], aes(y=upb,
                                    x=forcats::fct_reorder(st2,upb),
                                    fill=upb))+
  geom_boxplot(outlier.alpha=0)+coord_flip(ylim=c(0,1.25e3))+
  labs(y=&quot;Mortgage loan amount ($1000s)&quot;,
       x=&quot;&quot;,
       title=&quot;Distribution of mortgage loan amounts in 2016&quot;,
       subtitle=&quot;first-lien home purchase and refinance loans for 1-4 unit properties&quot;,
       caption=&quot;@lenkiefer Source: FFIEC, CFPB HMDA data&quot;)+
  theme(plot.subtitle=element_text(size=14,face=&quot;italic&quot;,color=&quot;darkgray&quot;),
        plot.title=element_text(size=16,face=&quot;bold&quot;,color=&quot;black&quot;,hjust=0),
        plot.caption=element_text(hjust=0))

g7</code></pre>
<p><img src="/post/2017-10-08-analyzing-mortgage-data-with-r_files/figure-html/10-08-2017-plot-7-1.png" width="672" /></p>
<pre class="r"><code>g8&lt;-
  ggplot(data=mydata[upb !=9999,], aes(y=upb,
                                    x=forcats::fct_reorder(st2,upb),
                                    fill=loan_purpose_name))+
  geom_boxplot(outlier.alpha=0)+coord_flip(ylim=c(0,1.2e3))+
  scale_fill_manual(name=&quot;  &quot;,values=c(&quot;royalblue&quot;,&quot;forestgreen&quot;))+
  labs(y=&quot;Mortgage loan amount ($1000s)&quot;,
       x=&quot;&quot;) +labs(title=&quot;Distribution of mortgage loan amounts in 2016&quot;,
            subtitle=&quot;first-lien home purchase and refinance loans for 1-4 unit properties&quot;,
            caption=&quot;@lenkiefer Source: FFIEC, CFPB HMDA data&quot;)+
            theme(plot.subtitle=element_text(size=14,face=&quot;italic&quot;,color=&quot;darkgray&quot;),
                  legend.position=&quot;top&quot;,
                  plot.title=element_text(size=16,face=&quot;bold&quot;,color=&quot;black&quot;,hjust=0),
                  plot.caption=element_text(hjust=0))
g8</code></pre>
<p><img src="/post/2017-10-08-analyzing-mortgage-data-with-r_files/figure-html/10-08-2017-plot-7-2.png" width="672" /></p>
<div id="maybe-the-boxplots-miss-something" class="section level2">
<h2>Maybe the boxplots miss something</h2>
<p>The boxplots are great, and in many cases work best. See for example this thread based on a question I asked on Twitter:</p>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">here seems boxplots are the better <a href="https://twitter.com/hashtag/dataviz?src=hash&amp;ref_src=twsrc%5Etfw">#dataviz</a>.<br>What do you think? <a href="https://t.co/X6xNZnzUHk">pic.twitter.com/X6xNZnzUHk</a></p>&mdash; 📈 Len Kiefer 📊 (@lenkiefer) <a href="https://twitter.com/lenkiefer/status/916823350726610946?ref_src=twsrc%5Etfw">October 8, 2017</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
 
<p>The example distributions in my tweet-mortgage loan amount-to-income ratios-were pretty smooth. In that case the consensus seemed to favor the boxplot. But what if the distributions aren’t so smooth? It’s not hard to find such an example.</p>
<pre class="r"><code>g.ridge&lt;-
    ggplot(data=mydata[upb !=9999 &amp; upb&lt;2e3,],  # leave off very large loan balances 
           aes(x=upb,
               y=forcats::fct_reorder(st2,upb),
               fill=log(..x..)))+
  geom_density_ridges_gradient(rel_min_height=.005)+
  scale_fill_viridis()+
  coord_cartesian(xlim=c(0,1.2e3))+
  labs(x=&quot;Mortgage loan amount ($1000s)&quot;,
       y=&quot;&quot;) +labs(title=&quot;Distribution of mortgage loan amounts in 2016&quot;,
            subtitle=&quot;first-lien home purchase and refinance loans for 1-4 unit properties&quot;)+
            theme(plot.subtitle=element_text(size=14,face=&quot;italic&quot;,color=&quot;darkgray&quot;),
                  legend.position=&quot;none&quot;,
                  plot.title=element_text(size=16,face=&quot;bold&quot;,color=&quot;black&quot;,hjust=0),
                  plot.caption=element_text(hjust=0))


plot_grid(g.ridge+labs(title=&quot;Distribution of mortgage loan amounts ($1000s) in 2016&quot;,
                       subtitle=&quot;home purchase and refinance loans for 1-4 unit properties&quot;)+
            theme(plot.subtitle=element_text(size=14,face=&quot;italic&quot;,color=&quot;darkgray&quot;),
                  plot.title=element_text(size=16,face=&quot;bold&quot;,color=&quot;black&quot;,hjust=0)),
          g7+labs(title=&quot;&quot;,subtitle=&quot;&quot;,caption=&quot;@lenkiefer Source: FFIEC, CFPB HMDA data&quot; )+
            theme(plot.caption=element_text(hjust=0)),
          ncol=1)</code></pre>
<p><img src="/post/2017-10-08-analyzing-mortgage-data-with-r_files/figure-html/10-08-2017-plot-9-1.png" width="672" /></p>
<p>In this case the density plot picks up on an important nonlinearity, the clustering of loan amounts around the conforming loan limits. Whether or not a boxplot is sufficient to summarize your data is going to depend. But explore your data, a <a href="http://www.thefunctionalart.com/2016/08/download-datasaurus-never-trust-summary.html">datasaurus</a> may lurk within.</p>
</div>
</div>
<div id="more-geo-facets" class="section level1">
<h1>More geo facets</h1>
<p>Let’s try out some more geofaceted plots.</p>
<pre class="r"><code>g10&lt;-
  ggplot(data=sdata2[state_abbr !=&quot;PR&quot;], 
         aes(x=loan_purpose_name,y=medupb,label=round(medupb,0),
                        fill=loan_purpose_name))+
  geom_col(position=&quot;dodge&quot;,alpha=0.75)+
  geom_text(vjust=1,size=2.5)+
  scale_fill_manual(name=&quot;  &quot;,values=c(&quot;royalblue&quot;,&quot;forestgreen&quot;))+
  scale_y_continuous(expand=c(0,0),labels=comma)+
  labs(x=&quot;&quot;,y=&quot;median upb ($1000s)&quot;,title=&quot;Median loan size ($1000s) by state in 2016&quot;,
       subtitle=&quot;first-lien home purchase and refinance loans&quot;,
       caption=&quot;@lenkiefer Source: FFIEC, CFPB HMDA data&quot; )+
  facet_geo(~state_abbr)+theme_minimal()+
  theme(axis.text=element_blank(),
        legend.position=&quot;top&quot;)
g10</code></pre>
<p><img src="/post/2017-10-08-analyzing-mortgage-data-with-r_files/figure-html/10-08-2017-plot-10-1.png" width="864" /> This plot shows the median loan size by state and loan purpose. Loans tend to be larger on the coasts where home prices also tend to be higher.</p>
<p>We can also look at how the median income for borrowers varies by state.</p>
<pre class="r"><code>g11&lt;-
  ggplot(data=sdata2, 
       aes(x=loan_purpose_name,y=medinc,label=round(medinc,0),
                        fill=loan_purpose_name))+
  geom_col(position=&quot;dodge&quot;,alpha=0.75)+
  geom_text(vjust=1,size=2.5)+
  scale_fill_manual(name=&quot;  &quot;,values=c(&quot;royalblue&quot;,&quot;forestgreen&quot;))+
  scale_y_continuous(expand=c(0,0),labels=comma)+
  labs(x=&quot;&quot;,y=&quot;median income ($1000s)&quot;,title=&quot;Median income ($1000s) by state in 2016&quot;,
       subtitle=&quot;first-lien home purchase and refinance borrowers&quot;,
       caption=&quot;@lenkiefer Source: FFIEC, CFPB HMDA data&quot; )+
  facet_geo(~state_abbr)+theme_minimal()+
  theme(axis.text=element_blank(),
        legend.position=&quot;top&quot;)
g11</code></pre>
<p><img src="/post/2017-10-08-analyzing-mortgage-data-with-r_files/figure-html/10-08-2017-plot-11-1.png" width="864" /></p>
<p>This shows a similar, but less pronounced pattern than the loan amount plot. What if we compared the income of borrowers to their loan size?</p>
<p>The next plot shows the median loan amount-to-income ratio by state and loan purpose.</p>
<pre class="r"><code>g12&lt;-
  ggplot(data=sdata2,
               aes(x=loan_purpose_name,y=medrat,label=round(medrat,1),
                        fill=loan_purpose_name))+
  geom_col(position=&quot;dodge&quot;,alpha=0.75)+#coord_flip()+
  geom_text(vjust=1,size=2)+
  scale_fill_manual(name=&quot;  &quot;,values=c(&quot;royalblue&quot;,&quot;forestgreen&quot;))+
  scale_y_continuous(expand=c(0,0),labels=comma)+
  labs(x=&quot;&quot;,y=&quot;loan size-to-income ratio&quot;,
       title=&quot;Median loan size-to-income ratio by state in 2016&quot;,
       subtitle=&quot;first-lien home purchase and refinance loans&quot;,
       caption=&quot;@lenkiefer Source: FFIEC, CFPB HMDA data&quot;)+
  facet_geo(~state_abbr)+theme_minimal()+
  theme(axis.text=element_blank(),
        legend.position=&quot;top&quot;)
g12</code></pre>
<p><img src="/post/2017-10-08-analyzing-mortgage-data-with-r_files/figure-html/10-08-2017-plot-12-1.png" width="864" /></p>
<p>Two clear patterns emerge here. First, home purchase loans tend to be a larger percent of borrower income than refinance loans. We also see a tendency for coastal areas to have higher loan amount-to-income ratios. So despite higher average incomes in higher cost markets, borrowers tend to borrow more as a percent of income in those markets. A scatterplot might express our point.</p>
<pre class="r"><code>g13&lt;-
  ggplot(data=sdata2[state_abbr !=&quot;PR&quot;],
       aes(y=medupb,x=medinc,label=state_abbr,
           color=loan_purpose_name))+
  geom_text(size=4)+
  stat_smooth(fill=NA,method=&quot;lm&quot;,alpha=0.5,linetype=2,size=0.75)+
  scale_color_manual(name=&quot;  &quot;,values=c(&quot;royalblue&quot;,&quot;forestgreen&quot;))+
  labs(x=&quot;median income ($1000)&quot;,
       y=&quot;median loan amount ($1000)&quot;,
       title=&quot;Median loan size-to-income ratio by state in 2016&quot;,
       subtitle=&quot;first-lien home purchase and refinance loans&quot;,
       caption=&quot;@lenkiefer Source: FFIEC, CFPB HMDA data&quot;)+
  facet_wrap(~loan_purpose_name)+theme_minimal()+
  theme(legend.position=&quot;none&quot;,plot.caption=element_text(hjust=0))
g13</code></pre>
<p><img src="/post/2017-10-08-analyzing-mortgage-data-with-r_files/figure-html/10-08-2017-plot-13-1.png" width="672" /></p>
</div>
<div id="more" class="section level1">
<h1>More?</h1>
<p>Oh yeah, there’s a bunch more. But that’s enough for today.</p>
<p>We can explore these data in greater detail. There’s much finer geographic detail in these data (down to the county and even Census Tract). Also, in a separate file that Federal Reserve researchers released we have an aggregated state/county time series going back to 1994. I’ve been exploring those data too, and will have more to say about them in a future post. Check back later.</p>
<p>We gotta eventually get to this business:</p>
<p><img src="../../../../img/charts_oct_08_2017/kandinsky_img.gif"></p>
</div>


  
<div class="prev-next-post pure-g">
  <div class="pure-u-1-24" style="text-align: left;">
    
    <a href="http://lenkiefer.com/2017/10/05/arizona-housing-market-trends/"><i class="fa fa-chevron-left"></i></a>
    
  </div>
  <div class="pure-u-10-24">
    
    <nav class="prev">
      <a href="http://lenkiefer.com/2017/10/05/arizona-housing-market-trends/">Arizona housing market trends</a>
    </nav>
    
  </div>
  <div class="pure-u-2-24">
    &nbsp;
  </div>
  <div class="pure-u-10-24">
    
    <nav class="next">
      <a href="http://lenkiefer.com/2017/10/09/what-time-is-it-time-for-tibbletime/">What time is it? Time for tibbletime!</a>
    </nav>
    
  </div>
  <div class="pure-u-1-24" style="text-align: right;">
    
    <a href="http://lenkiefer.com/2017/10/09/what-time-is-it-time-for-tibbletime/"><i class="fa fa-chevron-right"></i></a>
    
  </div>
</div>



  

</div>
<footer class="post-footer clearfix">
    
        <p class="post-tags">
            <span>Tagged:</span>
            
            
                <a href="/tags/mortgage/">mortgage</a>, 
            
                <a href="/tags/housing/">housing</a>, 
            
                <a href="/tags/dataviz/">dataviz</a>, 
            
                <a href="/tags/r/">R</a>, 
            
                <a href="/tags/data-wrangling/">data wrangling</a>
            
        </p>
    

    <div class="share">
        
            <a class="icon-twitter" href="https://twitter.com/share?url=http://lenkiefer.comhttp%3a%2f%2flenkiefer.com%2f2017%2f10%2f08%2fanalyzing-mortgage-data-with-r%2f&text=Analyzing%20mortgage%20data%20with%20R via %40lenkiefer"
                onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                <i class="fa fa-twitter"></i>
                <span class="hidden">Twitter</span>
            </a>
        

        
            <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://lenkiefer.comhttp%3a%2f%2flenkiefer.com%2f2017%2f10%2f08%2fanalyzing-mortgage-data-with-r%2f"
                onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                <i class="fa fa-facebook"></i>
                <span class="hidden">Facebook</span>
            </a>
        


        
    </div>
</footer>
</div>
</div>
<script src="http://lenkiefer.com/js/ui.js"></script>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-66905937-1', 'auto');
  ga('send', 'pageview');

</script>






</body>
</html>

