
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Maps, mortgages and me</title>
    
    <meta name="author" content="Len Kiefer">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Bootstrap styles -->
    <link href="/assets/themes/lentheme/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <!-- Optional theme -->
    <link href="/assets/themes/lentheme/bootstrap/css/bootstrap-theme.min.css" rel="stylesheet">
    <!-- Sticky Footer -->
    <link href="/assets/themes/lentheme/bootstrap/css/bs-sticky-footer.css" rel="stylesheet">
    
    <!-- Custom styles -->
    <link href="/assets/themes/lentheme/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!-- Update these with your own images
      <link rel="shortcut icon" href="images/favicon.ico">
      <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
      <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
      <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
    -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

  </head>

  <body>
    <div id="wrap">
      <nav class="navbar navbar-default" role="navigation">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#jb-navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/"><span class="icon-home3" style="font-size:24px"> Len Kiefer</a></span>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="jb-navbar-collapse" style="font-size:24px">
          <ul class="nav navbar-nav" >
        <li><a href="/archive.html"><span class="icon-newspaper"> Posts</a></span></li>
            <!-- li><a href="/chartbook/index.html"><span class="icon-display"> Chartbook</a></span></li-->
         <li><a href="/resume.html"><span class="icon-profile"> Resume</span></a></li>
        <li><a href="/about.html"><span class="icon-user-tie"> About</span></a></li>
          </ul>
        </div><!-- /.navbar-collapse -->
      </nav>

      <div class="container">
        
<div class="page-header">
  <h1>Maps, mortgages and me </h1>
</div>

<div class="row post-full">
  <div class="col-xs-12">
    <div class="date">
      <span>21 August 2016</span>
    </div>
    <div class="content">
      <p>IN THIS POST I WANT TO DOCUMENT some <a href="https://www.r-project.org/">R</a> code I’ve recently been working on combining maps and distribution plots. As I <a href="/2016/08/18/data-swarm">discussed earlier</a> lots of interesting data will be released in the fall and I want to be ready for it.</p>

<p>Some of these snippets can be recycled when the new data is available.</p>

<h1 id="maps">Maps</h1>

<p>One area of data visualization with R I haven’t explored much is mapping. Part of this reason is because I’ve had other tools to use, but usually it’s because I’m in a hurry. Maybe because of prior experience with <a href="https://en.wikipedia.org/wiki/S-PLUS">SPlus</a> and the way ggplot is structured I’ve found making other statistical graphs (line charts, scatters, etc.) relatively easy in R. But maps have been a different story.</p>

<p>Because my mapping interests are relatively simple (I’m usually just looking for a choropleth), I’ve been able to get by with other tools like <a href="http://www.tableau.com/">Tableau</a> or even <a href="http://www.sas.com/en_us/home.html">SAS</a>.  For examples, see <a href="/2016/05/22/population-growth-housing-supply-and-house-prices">this post</a>, <a href="/2016/03/30/real-house-prices-and-population-growth">this post</a>, <a href="/2016/02/28/house-price-trends">this post</a> or my <a href="http://public.tableau.com/profile/leonard.kiefer#!/">Tableau profile</a>.</p>

<p>But there is a lot of cool stuff being done in R with maps. I have found recent posts by <a href="http://personal.tcu.edu/kylewalker/">Kyle Walker</a> and <a href="http://juliasilge.com/">Julia Silge</a> to be very helpful to get me started.  For example this <a href="http://personal.tcu.edu/kylewalker/housing-price-maps-ggplot2.html">post</a> by Kyle and this <a href="http://juliasilge.com/blog/Evenly-Distributed/">one</a> by Julia have been my launching points for this analysis. I’m sure there are lots of other people doing interesting stuff–<a href="https://twitter.com/lenkiefer">please tell me about it</a>–but those two articles were useful for relative beginners such as myself.</p>

<p>For this post I’m going to return to the 2014 Home Mortgage Disclosure Act Data (HMDA) that you can get from the Consumer Financial Protection Bureau (CFPB) <a href="http://www.consumerfinance.gov/data-research/hmda/explore">webpage</a> and I <a href="/2016/08/18/data-swarm">discussed earlier</a>.</p>

<p>The goal will be to create a <a href="https://en.wikipedia.org/wiki/Choropleth_map">choropleth map</a> showing some summary statistics of the HMDA data and to integrate it with some other statistical analysis.  One example we’ll try to build is this graph I posted on Twitter last night:</p>

<blockquote class="twitter-tweet" data-lang="en"><p lang="en" dir="ltr">working on combining maps &amp; graphs with <a href="https://twitter.com/hashtag/rstats?src=hash">#rstats</a>, lots of data coming in the fall and gotta be ready for it. <a href="https://t.co/xMJfGiq7xQ">pic.twitter.com/xMJfGiq7xQ</a></p>&mdash; Leonard Kiefer (@lenkiefer) <a href="https://twitter.com/lenkiefer/status/767193986356371456">August 21, 2016</a></blockquote>
<script async="" src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

<p>If you haven’t already go ahead and click on the follow button.</p>

<p>The map in the upper left corner is a choropleth map showing the median loan size by county for mortgage loans originated in California in 2014. The other charts are beeswarm plots showing the distribution of loan size for California as a whole (upper right corner) and for each of the metro areas (and a non-metro residual) located in California.</p>

<h2 id="building-the-maps">Building the maps</h2>

<p>I’m going to be adapting the code from <a href="http://juliasilge.com/blog/Evenly-Distributed/">Julia’s post</a> to make this map.</p>

<h3 id="load-data">Load data</h3>

<p>First let’s get the data we need.  I’m going to be using the same HMDA <a href="/2016/08/18/data-swarm">data from before</a> that you can download from the CFPB via <a href="http://www.consumerfinance.gov/data-research/hmda/explore#!/as_of_year=2014&amp;property_type=1,3&amp;action_taken=1&amp;loan_purpose=1,3&amp;loan_type=1&amp;section=filters">this link</a>.</p>

<p>The HMDA data in the .csv file includes state and county names, but not <a href="https://www.census.gov/geo/reference/gtc/gtc_codes.html#fips">Federal Information Processing Series (FIPS) codes</a>. FIPS codes are convenient for working with geographic data. Names are sometimes formatted differently (do they include the word “county” for example) so having FIPS codes would make our life easier.  Fortunately the <a href="https://www.census.gov/geo/reference/codes/cou.html">Census</a> has a convenient lookup file we can use.  <em>This or a related file might well be included somewhere in some R package, even one I use, but didn’t see it.</em></p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1">#load libraries
</span><span class="n">library</span><span class="p">(</span><span class="s1">'ggbeeswarm'</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">data.table</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">scales</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">ggthemes</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">acs</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">reshape2</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">stringr</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">ggthemes</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">ggalt</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">rgeos</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">maptools</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">albersusa</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">broom</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">tweenr</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">purrr</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">animation</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">viridis</span><span class="p">)</span>

<span class="c1">#load data and scripts
</span><span class="n">mydata</span> <span class="o">&lt;-</span> <span class="n">fread</span><span class="p">(</span><span class="s2">"~/data/hmda_lar.csv"</span><span class="p">)</span>
<span class="n">source</span><span class="p">(</span><span class="s1">'~/code/multiplot.R'</span><span class="p">)</span>
<span class="c1"># function for combining graphs see: http://www.cookbook-r.com/Graphs/Multiple_graphs_on_one_page_(ggplot2)/
</span>
<span class="c1">#data stuff
</span>
<span class="c1">#trim columns off data
</span><span class="n">mydata</span><span class="o">&lt;-</span><span class="n">mydata</span><span class="p">[,</span><span class="n">list</span><span class="p">(</span><span class="n">state_name</span><span class="p">,</span><span class="n">state_abbr</span><span class="p">,</span><span class="n">county_name</span><span class="p">,</span><span class="n">loan_amount_000s</span><span class="p">,</span><span class="n">loan_purpose_name</span><span class="p">,</span><span class="n">loan_type_name</span><span class="p">,</span>
                     <span class="n">applicant_income_000s</span><span class="p">,</span><span class="n">lien_status_name</span><span class="p">,</span><span class="n">msamd_name</span><span class="p">)]</span>

<span class="c1">#create merged state + county variable
</span><span class="n">mydata</span><span class="o">&lt;-</span><span class="n">mydata</span><span class="p">[,</span> <span class="n">c.name</span><span class="o">:=</span><span class="n">str_c</span><span class="p">(</span><span class="n">state_abbr</span><span class="p">,</span><span class="s2">":"</span><span class="p">,</span><span class="n">county_name</span><span class="p">)]</span>

<span class="c1">#get fips lookup: from census
</span>
<span class="n">fips.look</span><span class="o">&lt;-</span><span class="n">fread</span><span class="p">(</span><span class="s2">"http://www2.census.gov/geo/docs/reference/codes/files/national_county.txt"</span><span class="p">,</span>
                 <span class="n">col.names</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="s2">"state_abbr"</span><span class="p">,</span><span class="s2">"st.fips"</span><span class="p">,</span><span class="s2">"county.fips"</span><span class="p">,</span><span class="s2">"county_name"</span><span class="p">,</span><span class="s2">"CLASSFP"</span><span class="p">),</span><span class="n">head</span><span class="o">=</span><span class="n">F</span><span class="p">)</span>

<span class="n">fips.look</span><span class="o">&lt;-</span><span class="n">fips.look</span><span class="p">[,</span><span class="n">fips</span> <span class="o">:=</span> <span class="n">str_c</span><span class="p">(</span><span class="n">str_pad</span><span class="p">(</span><span class="n">st.fips</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="s2">"left"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">),</span><span class="n">str_pad</span><span class="p">(</span><span class="n">county.fips</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="s2">"left"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">))]</span>
<span class="c1">#create merged state + county variable
</span><span class="n">fips.look</span><span class="o">&lt;-</span><span class="n">fips.look</span><span class="p">[,</span><span class="n">c.name</span><span class="o">:=</span><span class="n">str_c</span><span class="p">(</span><span class="n">state_abbr</span><span class="p">,</span><span class="s2">":"</span><span class="p">,</span><span class="n">county_name</span><span class="p">)]</span>
<span class="c1">#get rid of extra columns for merge
</span><span class="n">fips.look2</span><span class="o">&lt;-</span><span class="n">fips.look</span><span class="p">[,</span><span class="n">list</span><span class="p">(</span><span class="n">fips</span><span class="p">,</span><span class="n">c.name</span><span class="p">)]</span>

<span class="c1">#merge fips numbers back onto data
</span><span class="n">mydata</span><span class="o">&lt;-</span><span class="n">merge</span><span class="p">(</span><span class="n">mydata</span><span class="p">,</span><span class="n">fips.look2</span><span class="p">,</span><span class="n">by</span><span class="o">=</span><span class="s2">"c.name"</span><span class="p">)</span>

<span class="c1">#add state code, will be useful for labeling
</span><span class="n">mydata</span><span class="o">&lt;-</span><span class="n">mydata</span><span class="p">[,</span><span class="n">st.fips</span><span class="o">:=</span><span class="n">substr</span><span class="p">(</span><span class="n">fips</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">)]</span>
<span class="n">mydata</span><span class="o">&lt;-</span><span class="n">mydata</span><span class="p">[,</span><span class="n">county.fips</span><span class="o">:=</span><span class="n">substr</span><span class="p">(</span><span class="n">fips</span><span class="p">,</span><span class="m">3</span><span class="p">,</span><span class="m">5</span><span class="p">)]</span>

<span class="c1"># loan amounts read as character variable, scaled in $1000s, create upb variable in $s and numeric
</span><span class="n">mydata</span><span class="o">$</span><span class="n">upb</span><span class="o">&lt;-</span><span class="n">as.numeric</span><span class="p">(</span><span class="n">mydata</span><span class="o">$</span><span class="n">loan_amount_000s</span><span class="p">)</span><span class="o">*</span><span class="m">1000</span>

<span class="c1"># Create a summary file that has total UPB (upb), median loan amount (upb.med), and count of loans (count)
</span><span class="n">county.sum</span><span class="o">&lt;-</span><span class="n">mydata</span><span class="p">[,</span><span class="n">list</span><span class="p">(</span><span class="n">upb</span><span class="o">=</span><span class="n">sum</span><span class="p">(</span><span class="n">upb</span><span class="p">),</span><span class="n">upb.med</span><span class="o">=</span><span class="n">median</span><span class="p">(</span><span class="n">upb</span><span class="p">),</span><span class="n">count</span><span class="o">=</span><span class="n">.N</span><span class="p">),</span> <span class="n">by</span><span class="o">=</span><span class="n">list</span><span class="p">(</span><span class="n">fips</span><span class="p">,</span><span class="n">state_abbr</span><span class="p">,</span><span class="n">state_name</span><span class="p">,</span><span class="n">county_name</span><span class="p">,</span><span class="n">msamd_name</span><span class="p">)]</span></code></pre></figure>

<p>Now that we’ve loaded our data and summarized it, let’s load some maps.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># Let's load some maps:
</span>
<span class="n">states</span><span class="o">&lt;-</span><span class="n">usa_composite</span><span class="p">()</span>  <span class="c1">#create a state map thing
</span><span class="n">smap</span><span class="o">&lt;-</span><span class="n">fortify</span><span class="p">(</span><span class="n">states</span><span class="p">,</span><span class="n">region</span><span class="o">=</span><span class="s2">"fips_state"</span><span class="p">)</span>
<span class="n">smap.all</span><span class="o">&lt;-</span><span class="n">smap</span>           <span class="c1">#we're going to subset smap later, so copy full map
</span>
<span class="n">counties</span> <span class="o">&lt;-</span> <span class="n">counties_composite</span><span class="p">()</span>   <span class="c1">#create a county map thing
</span>
<span class="c1">#add on summary stats by county using FIPS code
</span><span class="n">counties</span><span class="o">@</span><span class="n">data</span> <span class="o">&lt;-</span> <span class="n">left_join</span><span class="p">(</span><span class="n">counties</span><span class="o">@</span><span class="n">data</span><span class="p">,</span> <span class="n">county.sum</span><span class="p">,</span> <span class="n">by</span> <span class="o">=</span> <span class="s2">"fips"</span><span class="p">)</span>   
<span class="n">cmap</span> <span class="o">&lt;-</span> <span class="n">fortify</span><span class="p">(</span><span class="n">counties_composite</span><span class="p">(),</span> <span class="n">region</span><span class="o">=</span><span class="s2">"fips"</span><span class="p">)</span>
<span class="c1">#create state and county FIPS codes 
</span><span class="n">cmap</span><span class="o">$</span><span class="n">state</span><span class="o">&lt;-</span><span class="n">substr</span><span class="p">(</span><span class="n">cmap</span><span class="o">$</span><span class="n">id</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">)</span>  
<span class="n">cmap</span><span class="o">$</span><span class="n">county</span><span class="o">&lt;-</span><span class="n">substr</span><span class="p">(</span><span class="n">cmap</span><span class="o">$</span><span class="n">id</span><span class="p">,</span><span class="m">3</span><span class="p">,</span><span class="m">5</span><span class="p">)</span>
<span class="n">cmap</span><span class="o">$</span><span class="n">fips</span><span class="o">&lt;-</span><span class="n">paste0</span><span class="p">(</span><span class="n">cmap</span><span class="o">$</span><span class="n">state</span><span class="p">,</span><span class="n">cmap</span><span class="o">$</span><span class="n">county</span><span class="p">)</span>
<span class="n">cmap.all</span><span class="o">&lt;-</span><span class="n">cmap</span>    <span class="err">#</span><span class="n">we</span><span class="err">'</span><span class="n">re</span> <span class="n">going</span> <span class="n">to</span> <span class="n">subset</span> <span class="n">cmap</span> <span class="n">later</span><span class="p">,</span> <span class="n">so</span> <span class="n">copy</span> <span class="n">full</span> <span class="n">map</span></code></pre></figure>

<p>Let’s test to see if our map is working.  We’re going to use geom_map() to make our maps.  Let’s try to make a state map first:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1">#test map 1:
</span><span class="n">ggplot</span><span class="p">()</span> <span class="o">+</span>
  <span class="n">geom_map</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">smap</span><span class="p">,</span> <span class="n">map</span> <span class="o">=</span> <span class="n">smap</span><span class="p">,</span>
           <span class="n">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">long</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">lat</span><span class="p">,</span> <span class="n">map_id</span> <span class="o">=</span> <span class="n">id</span><span class="p">),</span>
           <span class="n">color</span> <span class="o">=</span> <span class="s2">"#2b2b2b"</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="m">0.05</span><span class="p">,</span> <span class="n">fill</span> <span class="o">=</span> <span class="n">NA</span><span class="p">)</span> </code></pre></figure>

<p><img src="/img/Rfig/fig-map-1-1.svg" alt="plot of chunk fig-map-1" /></p>

<p>All right!  It’s alive. Now let’s try to make a more complicated map with some styling.  Let’s make a choropleth map of the United States with each county colored according to the median loans size of mortgage loans originated in 2014.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1">#test map 2:
</span>  <span class="n">ggplot</span><span class="p">()</span> <span class="o">+</span>
  <span class="n">geom_map</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">cmap.all</span><span class="p">,</span> <span class="n">map</span> <span class="o">=</span> <span class="n">cmap.all</span><span class="p">,</span>
           <span class="n">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">long</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">lat</span><span class="p">,</span> <span class="n">map_id</span> <span class="o">=</span> <span class="n">id</span><span class="p">),</span>
           <span class="n">color</span> <span class="o">=</span> <span class="s2">"#2b2b2b"</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="m">0.05</span><span class="p">,</span> <span class="n">fill</span> <span class="o">=</span> <span class="n">NA</span><span class="p">)</span> <span class="o">+</span>
  <span class="n">geom_map</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">counties</span><span class="o">@</span><span class="n">data</span><span class="p">,</span> <span class="n">map</span> <span class="o">=</span> <span class="n">cmap.all</span><span class="p">,</span>
           <span class="n">aes</span><span class="p">(</span><span class="n">fill</span> <span class="o">=</span><span class="n">log</span><span class="p">(</span><span class="n">upb.med</span><span class="p">),</span> <span class="n">map_id</span> <span class="o">=</span> <span class="n">fips</span><span class="p">),</span>
           <span class="n">color</span> <span class="o">=</span> <span class="n">NA</span><span class="p">)</span> <span class="o">+</span>
  <span class="c1">#add black state borders (just to see if things are working)
</span>  <span class="n">geom_map</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">smap.all</span><span class="p">,</span> <span class="n">map</span> <span class="o">=</span> <span class="n">smap.all</span><span class="p">,</span>
           <span class="n">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">long</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">lat</span><span class="p">,</span> <span class="n">map_id</span> <span class="o">=</span> <span class="n">id</span><span class="p">),</span>
           <span class="n">color</span> <span class="o">=</span> <span class="s2">"black"</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="m">.5</span><span class="p">,</span> <span class="n">fill</span> <span class="o">=</span> <span class="n">NA</span><span class="p">)</span> <span class="o">+</span>
  <span class="n">theme_map</span><span class="p">(</span><span class="n">base_size</span> <span class="o">=</span> <span class="m">12</span><span class="p">)</span> <span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">plot.title</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="m">16</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">(</span><span class="n">b</span><span class="o">=</span><span class="m">10</span><span class="p">)))</span> <span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">plot.subtitle</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="m">14</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">(</span><span class="n">b</span><span class="o">=</span><span class="m">-20</span><span class="p">)))</span> <span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">plot.caption</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="m">9</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="m">-15</span><span class="p">),</span><span class="n">hjust</span><span class="o">=</span><span class="m">0</span><span class="p">))</span> <span class="o">+</span>
  <span class="n">coord_proj</span><span class="p">(</span><span class="n">us_laea_proj</span><span class="p">)</span> <span class="o">+</span>
  <span class="n">labs</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">"Median loan amount by county in 2014"</span><span class="p">,</span>
       <span class="n">caption</span><span class="o">=</span><span class="s2">"\n@lenkiefer Source: CFPB, FFIEC, Home Mortgage Disclosure Act (HMDA) data\nIncludes all home purchase and refinance loans for 1-4 family dwellings and manufactured housing originated in 2014."</span><span class="p">)</span><span class="o">+</span>
  <span class="n">scale_fill_viridis</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"Median Loan Amount\n$, log scale\n"</span><span class="p">,</span>
                     <span class="n">discrete</span><span class="o">=</span><span class="n">F</span><span class="p">,</span><span class="n">option</span><span class="o">=</span><span class="s2">"D"</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="m">0.95</span><span class="p">,</span><span class="n">direction</span><span class="o">=</span><span class="m">-1</span><span class="p">,</span><span class="n">limits</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="m">10000</span><span class="p">),</span><span class="n">log</span><span class="p">(</span><span class="m">1.4e6</span><span class="p">)),</span>
                     <span class="n">breaks</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="m">10000</span><span class="p">),</span><span class="n">log</span><span class="p">(</span><span class="m">100000</span><span class="p">),</span><span class="n">log</span><span class="p">(</span><span class="m">1e6</span><span class="p">)),</span>
                     <span class="n">labels</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="s2">"$10,000"</span><span class="p">,</span><span class="s2">"$100,000"</span><span class="p">,</span><span class="s2">"$1,000,000"</span><span class="p">)</span>  <span class="p">)</span><span class="o">+</span>  <span class="n">theme</span><span class="p">(</span><span class="n">legend.position</span> <span class="o">=</span> <span class="s2">"right"</span><span class="p">)</span></code></pre></figure>

<p><img src="/img/Rfig/fig-map-2-1.svg" alt="plot of chunk fig-map-2" /></p>

<p>Excellent!  Now all we have to do is combine this map with our beeswarm plots and we’ll be good to go.</p>

<h2 id="subsetting-map-and-adding-distribution-plot">Subsetting map and adding distribution plot</h2>

<p>The composite map is interesting, but hard to see beyond some general patterns (the coasts have high median loans sizes, while loan sizes in the Midwest and (non-coastal) Southeast tend to be smaller).  Let’s zoom in on a particular state and add a plot showing the distribution of loan sizes.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># First step is to get a list of states (we'll exclude FIPS code 72: Puerto Rico)
</span>
<span class="n">st.list</span><span class="o">&lt;-</span><span class="n">unique</span><span class="p">(</span><span class="n">mydata</span><span class="p">[</span><span class="n">st.fips</span> <span class="o">!=</span><span class="s2">"72"</span><span class="p">,]</span><span class="o">$</span><span class="n">st.fips</span><span class="p">)</span>

<span class="c1"># The next step is to make a function that generates the composite plot based on a state FIPS number:
</span>
<span class="n">myplot</span><span class="o">&lt;-</span><span class="k">function</span><span class="p">(</span><span class="n">i</span><span class="p">){</span>
  
<span class="n">c.list</span><span class="o">&lt;-</span><span class="n">unique</span><span class="p">(</span><span class="n">mydata</span><span class="p">[</span><span class="n">st.fips</span> <span class="o">==</span><span class="n">st.list</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">$</span><span class="n">fips</span><span class="p">)</span>  <span class="c1"># all counties within selected state [i]
</span><span class="n">smap</span><span class="o">&lt;-</span><span class="n">subset</span><span class="p">(</span><span class="n">smap.all</span><span class="p">,</span> <span class="n">id</span> <span class="o">%</span><span class="k">in</span><span class="o">%</span> <span class="n">st.list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>         <span class="c1"># subset state map
</span><span class="n">cmap</span><span class="o">&lt;-</span><span class="n">subset</span><span class="p">(</span><span class="n">cmap.all</span><span class="p">,</span> <span class="n">fips</span> <span class="o">%</span><span class="k">in</span><span class="o">%</span> <span class="n">c.list</span><span class="p">)</span>           <span class="c1"># subset county map
</span>
<span class="c1">#state label
</span><span class="n">st.label</span><span class="o">&lt;-</span><span class="n">unique</span><span class="p">(</span><span class="n">fips.look</span><span class="p">[</span><span class="n">st.fips</span><span class="o">==</span><span class="n">as.numeric</span><span class="p">(</span><span class="n">st.list</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span><span class="o">$</span><span class="n">state_abbr</span><span class="p">)</span>

<span class="c1"># graph 1: map (as above, but only including subset)
</span><span class="n">g1</span><span class="o">&lt;-</span>
  <span class="n">ggplot</span><span class="p">()</span> <span class="o">+</span>
  <span class="n">geom_map</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">,</span> <span class="n">map</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">,</span>
           <span class="n">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">long</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">lat</span><span class="p">,</span> <span class="n">map_id</span> <span class="o">=</span> <span class="n">id</span><span class="p">),</span>
           <span class="n">color</span> <span class="o">=</span> <span class="s2">"#2b2b2b"</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="m">0.05</span><span class="p">,</span> <span class="n">fill</span> <span class="o">=</span> <span class="n">NA</span><span class="p">)</span> <span class="o">+</span>
  <span class="n">geom_map</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">counties</span><span class="o">@</span><span class="n">data</span><span class="p">,</span> <span class="n">map</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">,</span>
           <span class="n">aes</span><span class="p">(</span><span class="n">fill</span> <span class="o">=</span><span class="n">log</span><span class="p">(</span><span class="n">upb.med</span><span class="p">),</span> <span class="n">map_id</span> <span class="o">=</span> <span class="n">fips</span><span class="p">),</span>
           <span class="n">color</span> <span class="o">=</span> <span class="n">NA</span><span class="p">)</span> <span class="o">+</span>
  <span class="n">geom_map</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">smap</span><span class="p">,</span> <span class="n">map</span> <span class="o">=</span> <span class="n">smap</span><span class="p">,</span>
           <span class="n">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">long</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">lat</span><span class="p">,</span> <span class="n">map_id</span> <span class="o">=</span> <span class="n">id</span><span class="p">),</span>
           <span class="n">color</span> <span class="o">=</span> <span class="s2">"black"</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="m">1.05</span><span class="p">,</span> <span class="n">fill</span> <span class="o">=</span> <span class="n">NA</span><span class="p">)</span> <span class="o">+</span>
  <span class="n">theme_map</span><span class="p">(</span> <span class="n">base_size</span> <span class="o">=</span> <span class="m">12</span><span class="p">)</span> <span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">plot.title</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span> <span class="n">size</span> <span class="o">=</span> <span class="m">16</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">(</span><span class="n">b</span><span class="o">=</span><span class="m">10</span><span class="p">)))</span> <span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">plot.subtitle</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="m">14</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">(</span><span class="n">b</span><span class="o">=</span><span class="m">-20</span><span class="p">)))</span> <span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">plot.caption</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="m">9</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="m">-15</span><span class="p">),</span><span class="n">hjust</span><span class="o">=</span><span class="m">0</span><span class="p">))</span> <span class="o">+</span>
  <span class="n">coord_proj</span><span class="p">(</span><span class="n">us_laea_proj</span><span class="p">)</span> <span class="o">+</span>
  <span class="n">labs</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="s2">"Loan Amount, $"</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="s2">"Loan Purpose"</span><span class="p">,</span>
       <span class="n">title</span><span class="o">=</span><span class="n">paste</span><span class="p">(</span><span class="s2">"Median loan amount by county in"</span><span class="p">,</span>
                   <span class="n">unique</span><span class="p">(</span><span class="n">fips.look</span><span class="p">[</span><span class="n">st.fips</span><span class="o">==</span><span class="n">as.numeric</span><span class="p">(</span><span class="n">st.list</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span><span class="o">$</span><span class="n">state_abbr</span><span class="p">)))</span><span class="o">+</span>
  <span class="n">scale_fill_viridis</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"Median Loan Amount\n$, log scale\n"</span><span class="p">,</span>
                     <span class="n">discrete</span><span class="o">=</span><span class="n">F</span><span class="p">,</span><span class="n">option</span><span class="o">=</span><span class="s2">"D"</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="m">0.95</span><span class="p">,</span><span class="n">direction</span><span class="o">=</span><span class="m">-1</span><span class="p">,</span><span class="n">limits</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="m">10000</span><span class="p">),</span><span class="n">log</span><span class="p">(</span><span class="m">1.4e6</span><span class="p">)),</span>
                     <span class="n">breaks</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="m">10000</span><span class="p">),</span><span class="n">log</span><span class="p">(</span><span class="m">100000</span><span class="p">),</span><span class="n">log</span><span class="p">(</span><span class="m">1e6</span><span class="p">)),</span>
                     <span class="n">labels</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="s2">"$10,000"</span><span class="p">,</span><span class="s2">"$100,000"</span><span class="p">,</span><span class="s2">"$1,000,000"</span><span class="p">)</span>  <span class="p">)</span><span class="o">+</span>  <span class="n">theme</span><span class="p">(</span><span class="n">legend.position</span> <span class="o">=</span> <span class="s2">"right"</span><span class="p">)</span>

  
<span class="c1">#plot data:
</span>
<span class="c1"># Prepare data: select only data in the state (derived from c.list)
</span><span class="n">pdata</span><span class="o">&lt;-</span><span class="n">county.sum</span><span class="p">[</span><span class="n">fips</span> <span class="o">%</span><span class="k">in</span><span class="o">%</span> <span class="n">c.list</span><span class="p">]</span> 

<span class="n">pdata2</span><span class="o">&lt;-</span><span class="n">mydata</span><span class="p">[</span><span class="n">fips</span> <span class="o">%</span><span class="k">in</span><span class="o">%</span> <span class="n">c.list</span><span class="p">,</span><span class="n">.SD</span><span class="p">[</span><span class="n">sample</span><span class="p">(</span><span class="n">.N</span><span class="p">,</span><span class="n">min</span><span class="p">(</span><span class="n">.N</span><span class="p">,</span><span class="m">1000</span><span class="p">))],</span><span class="n">by</span> <span class="o">=</span> <span class="n">msamd_name</span> <span class="p">]</span>  <span class="c1">#subsample metro data
</span>
<span class="c1"># See note: sample by groups
# http://stackoverflow.com/questions/27325656/how-do-you-sample-groups-in-a-data-table-with-a-caveat
</span>
<span class="n">pdata2</span><span class="p">[</span><span class="n">msamd_name</span><span class="o">==</span><span class="s2">""</span><span class="p">,</span><span class="n">msamd_name</span><span class="o">:=</span><span class="s2">"Non-metro"</span><span class="p">]</span>  <span class="c1">#rename missing metros to "Non-Metro"
</span>
<span class="c1"># pdata2[,.N,by=msamd_name]    # Can run this to check how many obs we have per metro
</span>
<span class="n">pdata3</span><span class="o">&lt;-</span><span class="n">mydata</span><span class="p">[</span><span class="n">fips</span> <span class="o">%</span><span class="k">in</span><span class="o">%</span> <span class="n">c.list</span><span class="p">][</span><span class="n">sample</span><span class="p">(</span><span class="n">.N</span><span class="p">,</span><span class="m">1000</span><span class="p">)]</span>  <span class="c1">#subsample state data
</span>

<span class="c1"># graph 2: upb distribution for entire state
</span><span class="n">g2</span><span class="o">&lt;-</span>
  <span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">pdata2</span><span class="p">,</span><span class="n">aes</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="n">upb</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">log</span><span class="p">(</span><span class="n">upb</span><span class="p">)))</span><span class="o">+</span>
  <span class="n">geom_quasirandom</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="m">0.5</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="m">0.35</span><span class="p">)</span><span class="o">+</span>
  <span class="n">theme_minimal</span><span class="p">()</span><span class="o">+</span>
  <span class="n">scale_color_viridis</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"Loan Amount\n$,log scale\n"</span><span class="p">,</span><span class="n">discrete</span><span class="o">=</span><span class="n">F</span><span class="p">,</span><span class="n">option</span><span class="o">=</span><span class="s2">"D"</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="m">0.95</span><span class="p">,</span><span class="n">direction</span><span class="o">=</span><span class="m">-1</span><span class="p">,</span>
                        <span class="n">limits</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="m">10000</span><span class="p">),</span><span class="n">log</span><span class="p">(</span><span class="m">1.4e6</span><span class="p">)),</span>
                        <span class="n">breaks</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="m">10000</span><span class="p">),</span><span class="n">log</span><span class="p">(</span><span class="m">100000</span><span class="p">),</span><span class="n">log</span><span class="p">(</span><span class="m">1e6</span><span class="p">)),</span>
                        <span class="n">labels</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="s2">"$10k"</span><span class="p">,</span><span class="s2">"$100k"</span><span class="p">,</span><span class="s2">"$1,000k"</span><span class="p">)</span> <span class="p">)</span> <span class="o">+</span>
  <span class="n">scale_x_log10</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="m">10000</span><span class="p">,</span><span class="m">1.4e6</span><span class="p">),</span><span class="n">breaks</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="m">10000</span><span class="p">,</span><span class="m">100000</span><span class="p">,</span><span class="m">1000000</span><span class="p">),</span>
                  <span class="n">labels</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="s2">"$10k"</span><span class="p">,</span><span class="s2">"$100k"</span><span class="p">,</span><span class="s2">"$1,000k"</span><span class="p">)</span> <span class="p">)</span><span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">plot.title</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">14</span><span class="p">))</span><span class="o">+</span><span class="n">theme</span><span class="p">(</span><span class="n">plot.caption</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">hjust</span><span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="n">vjust</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="m">10</span><span class="p">)))</span><span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">plot.margin</span><span class="o">=</span><span class="n">unit</span><span class="p">(</span><span class="n">c</span><span class="p">(</span><span class="m">0.25</span><span class="p">,</span><span class="m">0.25</span><span class="p">,</span><span class="m">0.25</span><span class="p">,</span><span class="m">0.25</span><span class="p">),</span><span class="s2">"cm"</span><span class="p">))</span><span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">legend.position</span> <span class="o">=</span> <span class="s2">"none"</span><span class="p">)</span><span class="o">+</span>
  <span class="n">labs</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="s2">"Loan Amount ($, log scale)"</span><span class="p">,</span>
         <span class="n">caption</span><span class="o">=</span><span class="s2">"\n@lenkiefer Source: CFPB, FFIEC, Home Mortgage Disclosure Act (HMDA) data\nEach dot represents one originated loan in 2014 (1,000 loans randomly sampled for plot)"</span><span class="p">,</span>
       <span class="n">title</span><span class="o">=</span><span class="n">paste</span><span class="p">(</span><span class="s2">"Loan size distribution by Metro in"</span><span class="p">,</span>
                   <span class="n">unique</span><span class="p">(</span><span class="n">fips.look</span><span class="p">[</span><span class="n">st.fips</span><span class="o">==</span><span class="n">as.numeric</span><span class="p">(</span><span class="n">st.list</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span><span class="o">$</span><span class="n">state_abbr</span><span class="p">)))</span><span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">axis.text.x</span> <span class="o">=</span> <span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">4</span><span class="p">))</span><span class="o">+</span>
  <span class="n">facet_wrap</span><span class="p">(</span><span class="o">~</span><span class="n">msamd_name</span><span class="p">)</span><span class="o">+</span><span class="n">theme</span><span class="p">(</span><span class="n">strip.text.x</span> <span class="o">=</span> <span class="n">element_text</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="m">4</span><span class="p">))</span>


<span class="c1"># graph 3: upb distribution by county (using a subsample of 1000 obs)
</span><span class="n">g3</span><span class="o">&lt;-</span>
  <span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">pdata3</span><span class="p">,</span><span class="n">aes</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="n">upb</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">log</span><span class="p">(</span><span class="n">upb</span><span class="p">)))</span><span class="o">+</span><span class="n">geom_quasirandom</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="m">0.5</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="m">0.75</span><span class="p">)</span><span class="o">+</span>
  <span class="n">theme_minimal</span><span class="p">()</span><span class="o">+</span>
  <span class="n">scale_color_viridis</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"Loan Amount\n$,log scale\n"</span><span class="p">,</span><span class="n">discrete</span><span class="o">=</span><span class="n">F</span><span class="p">,</span><span class="n">option</span><span class="o">=</span><span class="s2">"D"</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="m">0.95</span><span class="p">,</span><span class="n">direction</span><span class="o">=</span><span class="m">-1</span><span class="p">,</span>
                      <span class="n">limits</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="m">10000</span><span class="p">),</span><span class="n">log</span><span class="p">(</span><span class="m">1.4e6</span><span class="p">)),</span>
                      <span class="n">breaks</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="m">10000</span><span class="p">),</span><span class="n">log</span><span class="p">(</span><span class="m">100000</span><span class="p">),</span><span class="n">log</span><span class="p">(</span><span class="m">1e6</span><span class="p">)),</span>
                      <span class="n">labels</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="s2">"$10k"</span><span class="p">,</span><span class="s2">"$100k"</span><span class="p">,</span><span class="s2">"$1,000k"</span><span class="p">)</span>                      <span class="p">)</span> <span class="o">+</span>
  <span class="n">scale_x_log10</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="m">10000</span><span class="p">,</span><span class="m">1.4e6</span><span class="p">),</span><span class="n">breaks</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="m">10000</span><span class="p">,</span><span class="m">100000</span><span class="p">,</span><span class="m">1000000</span><span class="p">),</span>
                <span class="n">labels</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="s2">"$10k"</span><span class="p">,</span><span class="s2">"$100k"</span><span class="p">,</span><span class="s2">"$1,000k"</span><span class="p">)</span> <span class="p">)</span><span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">plot.title</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">14</span><span class="p">))</span><span class="o">+</span><span class="n">theme</span><span class="p">(</span><span class="n">plot.caption</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">hjust</span><span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="n">vjust</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="m">10</span><span class="p">)))</span><span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">plot.margin</span><span class="o">=</span><span class="n">unit</span><span class="p">(</span><span class="n">c</span><span class="p">(</span><span class="m">0.25</span><span class="p">,</span><span class="m">0.25</span><span class="p">,</span><span class="m">0.25</span><span class="p">,</span><span class="m">0.25</span><span class="p">),</span><span class="s2">"cm"</span><span class="p">))</span><span class="o">+</span>  <span class="n">theme</span><span class="p">(</span><span class="n">legend.position</span> <span class="o">=</span> <span class="s2">"none"</span><span class="p">)</span><span class="o">+</span>
  <span class="n">labs</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="s2">"Loan Amount ($, log scale)"</span><span class="p">,</span>
       <span class="n">title</span><span class="o">=</span><span class="n">paste</span><span class="p">(</span><span class="s2">"Mortgage loan size distribution in"</span><span class="p">,</span>
                   <span class="n">unique</span><span class="p">(</span><span class="n">fips.look</span><span class="p">[</span><span class="n">st.fips</span><span class="o">==</span><span class="n">as.numeric</span><span class="p">(</span><span class="n">st.list</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span><span class="o">$</span><span class="n">state_abbr</span><span class="p">)))</span><span class="o">+</span>
  <span class="n">facet_wrap</span><span class="p">(</span><span class="o">~</span><span class="n">state_name</span><span class="p">)</span>

<span class="n">m</span><span class="o">&lt;-</span><span class="n">multiplot</span><span class="p">(</span><span class="n">g1</span><span class="p">,</span><span class="n">g2</span><span class="p">,</span><span class="n">g3</span><span class="p">,</span><span class="n">layout</span><span class="o">=</span><span class="n">matrix</span><span class="p">(</span><span class="n">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">3</span><span class="p">,</span><span class="m">2</span><span class="p">,</span><span class="m">2</span><span class="p">,</span><span class="m">2</span><span class="p">,</span><span class="m">2</span><span class="p">),</span> <span class="n">nrow</span><span class="o">=</span><span class="m">3</span><span class="p">,</span> <span class="n">byrow</span><span class="o">=</span><span class="n">TRUE</span><span class="p">))</span>
<span class="c1"># I've source the multiplot function above, and you can find it at:
# http://www.cookbook-r.com/Graphs/Multiple_graphs_on_one_page_(ggplot2)/  
</span><span class="p">}</span>

<span class="c1"># Try it out for California:
</span><span class="n">myplot</span><span class="p">(</span><span class="m">5</span><span class="p">)</span></code></pre></figure>

<p><img src="/img/Rfig/fig-map-3-1.svg" alt="plot of chunk fig-map-3" /></p>

<h2 id="animated-gif">Animated gif</h2>
<p>We can loop through all states and make a gif out of it:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">oopt</span> <span class="o">=</span> <span class="n">ani.options</span><span class="p">(</span><span class="n">interval</span> <span class="o">=</span> <span class="m">1</span><span class="p">)</span>
<span class="n">saveGIF</span><span class="p">({</span><span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="k">in</span> <span class="m">1</span><span class="o">:</span><span class="m">51</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">g</span><span class="o">&lt;-</span><span class="n">myplot</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
  <span class="n">print</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
  <span class="n">ani.pause</span><span class="p">()</span>
  <span class="n">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="p">}</span>
<span class="p">},</span><span class="n">movie.name</span><span class="o">=</span><span class="s2">"HMDA loan amounts v4.gif"</span><span class="p">,</span><span class="n">ani.width</span> <span class="o">=</span> <span class="m">1000</span><span class="p">,</span> <span class="n">ani.height</span> <span class="o">=</span> <span class="m">750</span><span class="p">)</span></code></pre></figure>

<p><img src="/img/charts_aug_21_2016/HMDA loan amounts v4.gif" alt="HMDA Swarm" /></p>

<h1 id="county-population-example">County Population Example</h1>

<p>I began figuring out make maps in R by replicating Julia Silge’s  <a href="http://juliasilge.com/blog/Evenly-Distributed/">excellent example</a>. Then I combined <a href="https://github.com/thomasp85/tweenr">tweenr</a> and <a href="https://github.com/eclarke/ggbeeswarm">beeswarm</a> plots to show how county population is distributed across states:</p>

<p><img src="/img/charts_aug_21_2016/map and dot v2.gif" alt="County map and dot" style="height: 550px;" /></p>

<h2 id="code-for-county-population-example">Code for county population example</h2>

<p>Once again we’ll use the R package tweenr and animate to make an animated gif. See my earlier <a href="/2016/05/29/improving-R-animated-gifs-with-tweenr">post about tweenr</a> for an introduction to tweenr, and more examples <a href="/2016/05/30/more-tweenr-animations">here</a> and <a href="/2016/06/26/week-in-review">here</a>.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># This comes straight from julia silge: http://juliasilge.com/blog/Evenly-Distributed/
# You'll need api key &amp; acs package (see julia's post)
</span>
<span class="n">countygeo</span> <span class="o">&lt;-</span> <span class="n">geo.make</span><span class="p">(</span><span class="n">state</span> <span class="o">=</span> <span class="s2">"*"</span><span class="p">,</span> <span class="n">county</span> <span class="o">=</span> <span class="s2">"*"</span><span class="p">)</span>
<span class="n">popfetch</span> <span class="o">&lt;-</span> <span class="n">acs.fetch</span><span class="p">(</span><span class="n">geography</span> <span class="o">=</span> <span class="n">countygeo</span><span class="p">,</span> 
                      <span class="n">endyear</span> <span class="o">=</span> <span class="m">2014</span><span class="p">,</span>
                      <span class="n">span</span> <span class="o">=</span> <span class="m">5</span><span class="p">,</span> 
                      <span class="n">table.number</span> <span class="o">=</span> <span class="s2">"B01003"</span><span class="p">,</span>
                      <span class="n">col.names</span> <span class="o">=</span> <span class="s2">"pretty"</span><span class="p">)</span>
<span class="n">myfips</span> <span class="o">&lt;-</span> <span class="n">geography</span><span class="p">(</span><span class="n">popfetch</span><span class="p">)</span> <span class="o">%&gt;%</span>  
  <span class="n">mutate</span><span class="p">(</span><span class="n">fips</span> <span class="o">=</span> <span class="n">str_c</span><span class="p">(</span><span class="n">str_pad</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="s2">"left"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">),</span>
                      <span class="n">str_pad</span><span class="p">(</span><span class="n">county</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="s2">"left"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">)))</span> <span class="o">%&gt;%</span>
  <span class="n">select</span><span class="p">(</span><span class="n">fips</span><span class="p">)</span>
<span class="n">geography</span><span class="p">(</span><span class="n">popfetch</span><span class="p">)</span><span class="o">=</span><span class="n">cbind</span><span class="p">(</span><span class="n">myfips</span><span class="p">,</span> <span class="n">geography</span><span class="p">(</span><span class="n">popfetch</span><span class="p">))</span>
<span class="n">popDF</span> <span class="o">&lt;-</span> <span class="n">melt</span><span class="p">(</span><span class="n">estimate</span><span class="p">(</span><span class="n">popfetch</span><span class="p">))</span> <span class="o">%&gt;%</span>
  <span class="n">mutate</span><span class="p">(</span><span class="n">fips</span> <span class="o">=</span> <span class="n">str_sub</span><span class="p">(</span><span class="n">str_c</span><span class="p">(</span><span class="s2">"00"</span><span class="p">,</span> <span class="n">Var1</span><span class="p">),</span> <span class="m">-5</span><span class="p">),</span>
         <span class="n">pop2014</span> <span class="o">=</span> <span class="n">value</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="n">select</span><span class="p">(</span><span class="n">fips</span><span class="p">,</span> <span class="n">pop2014</span><span class="p">)</span>
<span class="n">head</span><span class="p">(</span><span class="n">popDF</span><span class="p">)</span>


<span class="c1"># We use the sampe cmap, though we merge population data instead of mortgage data
</span><span class="n">counties</span> <span class="o">&lt;-</span> <span class="n">counties_composite</span><span class="p">()</span>
<span class="n">counties</span><span class="o">@</span><span class="n">data</span> <span class="o">&lt;-</span> <span class="n">left_join</span><span class="p">(</span><span class="n">counties</span><span class="o">@</span><span class="n">data</span><span class="p">,</span> <span class="n">popDF</span><span class="p">,</span> <span class="n">by</span> <span class="o">=</span> <span class="s2">"fips"</span><span class="p">)</span>
<span class="n">cmap</span> <span class="o">&lt;-</span> <span class="n">fortify</span><span class="p">(</span><span class="n">counties_composite</span><span class="p">(),</span> <span class="n">region</span><span class="o">=</span><span class="s2">"fips"</span><span class="p">)</span>
<span class="n">cmap</span><span class="o">$</span><span class="n">state</span><span class="o">&lt;-</span><span class="n">substr</span><span class="p">(</span><span class="n">cmap</span><span class="o">$</span><span class="n">id</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">)</span>
<span class="n">cmap.all</span><span class="o">&lt;-</span><span class="n">cmap</span>
<span class="n">cmap</span><span class="o">&lt;-</span><span class="n">subset</span><span class="p">(</span><span class="n">cmap.all</span><span class="p">,</span> <span class="n">state</span><span class="o">==</span><span class="n">st.list</span><span class="p">[</span><span class="m">1</span><span class="p">])</span>

<span class="n">popDF</span><span class="o">$</span><span class="n">state</span><span class="o">&lt;-</span><span class="n">substr</span><span class="p">(</span><span class="n">popDF</span><span class="o">$</span><span class="n">fips</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">)</span>
<span class="n">st.list</span><span class="o">&lt;-</span><span class="n">unique</span><span class="p">(</span><span class="n">popDF</span><span class="o">$</span><span class="n">state</span><span class="p">)</span>

<span class="n">popDF</span><span class="o">&lt;-</span><span class="n">data.table</span><span class="p">(</span><span class="n">popDF</span><span class="p">)</span>
<span class="n">all_states</span> <span class="o">&lt;-</span> <span class="n">map_data</span><span class="p">(</span><span class="s2">"state"</span><span class="p">)</span>

<span class="n">st.name</span><span class="o">&lt;-</span><span class="n">unique</span><span class="p">(</span><span class="n">all_states</span><span class="o">$</span><span class="n">region</span><span class="p">)</span>  <span class="c1">#get a list of states
</span>
<span class="n">popDF</span><span class="o">$</span><span class="n">fips</span><span class="o">&lt;-</span><span class="n">factor</span><span class="p">(</span><span class="n">popDF</span><span class="o">$</span><span class="n">fips</span><span class="p">)</span>
<span class="n">popDF</span><span class="o">$</span><span class="n">state</span><span class="o">&lt;-</span><span class="n">factor</span><span class="p">(</span><span class="n">popDF</span><span class="o">$</span><span class="n">state</span><span class="p">)</span>

<span class="err">#</span> <span class="n">pause</span> <span class="k">for</span> <span class="n">discussion</span> </code></pre></figure>

<p>In order to get the tweenr animation to work, I need to ensure that each data frame I feed to the tween_states() function has the same number of observations.  But states have different numbers of counties. Texas has the most with 254 counties.</p>

<p>We’ll set up a blank data frame based on Texas and index the county number.  We’ll merge each state to this data frame, which will give us missing values for county numbers less than 254.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">popDF</span><span class="o">&lt;-</span><span class="n">data.table</span><span class="p">(</span><span class="n">popDF</span><span class="p">)</span>
<span class="n">blank.df</span><span class="o">&lt;-</span><span class="n">popDF</span><span class="p">[</span><span class="n">state</span><span class="o">==</span><span class="s2">"48"</span><span class="p">,]</span> <span class="c1">#max number of counties is Texas at 254                
</span><span class="n">blank.df</span><span class="p">[,</span><span class="n">idn</span><span class="o">:=</span><span class="n">.I</span><span class="p">]</span>  <span class="c1">#create index
</span>

<span class="n">popDF</span><span class="o">&lt;-</span><span class="n">popDF</span><span class="p">[</span> <span class="p">,</span> <span class="n">idn</span> <span class="o">:=</span> <span class="m">1</span><span class="o">:</span><span class="n">.N</span> <span class="p">,</span> <span class="n">by</span> <span class="o">=</span> <span class="n">state</span> <span class="p">]</span>  <span class="c1">#now create index for each county by state 
</span>
<span class="c1"># function to create data set for animated swarm plot
</span>
<span class="n">myf</span><span class="o">&lt;-</span><span class="k">function</span><span class="p">(</span><span class="n">mystate</span><span class="p">){</span>
  <span class="n">temp</span><span class="o">&lt;-</span><span class="n">merge</span><span class="p">(</span><span class="n">blank.df</span><span class="p">[,</span><span class="n">list</span><span class="p">(</span><span class="n">idn</span><span class="p">)],</span>
              <span class="n">popDF</span><span class="p">[</span><span class="n">state</span><span class="o">==</span><span class="n">mystate</span><span class="p">,],</span>
              <span class="n">by</span><span class="o">=</span><span class="s2">"idn"</span><span class="p">,</span><span class="n">all.x</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
<span class="n">temp</span><span class="o">$</span><span class="n">fips</span><span class="o">&lt;-</span><span class="n">factor</span><span class="p">(</span><span class="n">temp</span><span class="o">$</span><span class="n">fips</span><span class="p">)</span>
<span class="n">temp</span><span class="o">$</span><span class="n">state</span><span class="o">&lt;-</span><span class="n">factor</span><span class="p">(</span><span class="n">temp</span><span class="o">$</span><span class="n">state</span><span class="p">)</span>
<span class="n">temp</span><span class="o">$</span><span class="n">idn</span><span class="o">&lt;-</span><span class="n">factor</span><span class="p">(</span><span class="n">temp</span><span class="o">$</span><span class="n">idn</span><span class="p">)</span>
<span class="n">temp</span><span class="o">&lt;-</span><span class="n">temp</span><span class="p">[</span><span class="n">order</span><span class="p">(</span><span class="n">idn</span><span class="p">)]</span>
<span class="k">return</span><span class="p">(</span><span class="n">data.frame</span><span class="p">(</span><span class="n">temp</span><span class="p">))</span>
<span class="p">}</span>

<span class="c1"># use lapply to generate the list of data sets:
</span>
<span class="n">st.list</span><span class="o">&lt;-</span><span class="n">unique</span><span class="p">(</span><span class="n">cmap.all</span><span class="o">$</span><span class="n">state</span><span class="p">)</span>  <span class="c1">#need to exclude PR
</span><span class="n">my.list2</span><span class="o">&lt;-</span><span class="n">lapply</span><span class="p">(</span><span class="n">c</span><span class="p">(</span><span class="n">st.list</span><span class="p">,</span><span class="n">st.list</span><span class="p">[</span><span class="m">1</span><span class="p">]),</span><span class="n">myf</span><span class="p">)</span>

<span class="c1"># Apply tweenr:
</span>
<span class="n">tf</span> <span class="o">&lt;-</span> <span class="n">tween_states</span><span class="p">(</span><span class="n">my.list2</span><span class="p">,</span> <span class="n">tweenlength</span><span class="o">=</span> <span class="m">2</span><span class="p">,</span> <span class="n">statelength</span><span class="o">=</span><span class="m">3</span><span class="p">,</span> <span class="n">ease</span><span class="o">=</span><span class="n">rep</span><span class="p">(</span><span class="s1">'cubic-in-out'</span><span class="p">,</span><span class="m">53</span><span class="p">),</span><span class="n">nframes</span><span class="o">=</span><span class="m">300</span><span class="p">)</span>
<span class="c1">#300 is the number of frames I chose, or about 6 frames per state. 
# Adding more frames will smooth transitions but made the file larger 
# Twitter has a 5 MB limit for gifs so I shoot for that if I'm planning on sharing with tweeps
</span>
<span class="n">dtf</span><span class="o">&lt;-</span><span class="n">data.table</span><span class="p">(</span><span class="n">tf</span><span class="p">)</span>


<span class="n">oopt</span> <span class="o">=</span> <span class="n">ani.options</span><span class="p">(</span><span class="n">interval</span> <span class="o">=</span> <span class="m">0.2</span><span class="p">)</span>
<span class="n">saveGIF</span><span class="p">({</span><span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="k">in</span> <span class="n">unique</span><span class="p">(</span><span class="n">dtf</span><span class="o">$</span><span class="n">.frame</span><span class="p">)){</span>
  


<span class="c1"># graph 1: set up animated beeswarm      
</span><span class="n">g1</span><span class="o">&lt;-</span>
  <span class="n">ggplot</span><span class="p">(</span><span class="n">dtf</span><span class="p">[</span><span class="n">.frame</span><span class="o">==</span><span class="n">i</span><span class="p">],</span>
       <span class="n">aes</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="n">pop2014</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">log</span><span class="p">(</span><span class="n">pop2014</span><span class="p">)))</span><span class="o">+</span>
  <span class="n">theme_minimal</span><span class="p">()</span><span class="o">+</span>    
  <span class="n">theme</span><span class="p">(</span><span class="n">plot.title</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">14</span><span class="p">))</span><span class="o">+</span><span class="n">theme</span><span class="p">(</span><span class="n">plot.caption</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">hjust</span><span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="n">vjust</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="m">10</span><span class="p">)))</span><span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">plot.margin</span><span class="o">=</span><span class="n">unit</span><span class="p">(</span><span class="n">c</span><span class="p">(</span><span class="m">0.25</span><span class="p">,</span><span class="m">0.25</span><span class="p">,</span><span class="m">0.25</span><span class="p">,</span><span class="m">0.25</span><span class="p">),</span><span class="s2">"cm"</span><span class="p">))</span><span class="o">+</span>  <span class="n">theme</span><span class="p">(</span><span class="n">legend.position</span> <span class="o">=</span> <span class="s2">"right"</span><span class="p">)</span><span class="o">+</span>
  <span class="n">geom_quasirandom</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="m">0.95</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="m">2</span><span class="p">)</span>  <span class="o">+</span>  <span class="c1">#I like the quasirandom beeswarm option
</span>  <span class="n">scale_color_viridis</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"Pop\nlog scale\n"</span><span class="p">,</span>
                      <span class="n">discrete</span><span class="o">=</span><span class="n">F</span><span class="p">,</span><span class="n">option</span><span class="o">=</span><span class="s2">"D"</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="m">0.95</span><span class="p">,</span><span class="n">direction</span><span class="o">=</span><span class="m">-1</span><span class="p">,</span><span class="n">limits</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="m">100</span><span class="p">),</span><span class="n">log</span><span class="p">(</span><span class="m">1e7</span><span class="p">)),</span>
                      <span class="n">breaks</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="m">100</span><span class="p">),</span><span class="n">log</span><span class="p">(</span><span class="m">10000</span><span class="p">),</span><span class="n">log</span><span class="p">(</span><span class="m">100000</span><span class="p">),</span><span class="n">log</span><span class="p">(</span><span class="m">1e7</span><span class="p">)),</span>
                      <span class="n">labels</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="s2">"100"</span><span class="p">,</span><span class="s2">"10,000"</span><span class="p">,</span><span class="s2">"100,000"</span><span class="p">,</span><span class="s2">"1,000,000"</span><span class="p">))</span> <span class="o">+</span>
  <span class="n">scale_x_log10</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">comma</span><span class="p">,</span><span class="n">limits</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="m">100</span><span class="p">,</span><span class="m">1e6</span><span class="p">),</span><span class="n">breaks</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="m">1000</span><span class="p">,</span><span class="m">10000</span><span class="p">,</span><span class="m">100000</span><span class="p">,</span><span class="m">1000000</span><span class="p">))</span><span class="o">+</span>
  <span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"Population in 2014 (log scale)"</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span>
       <span class="n">subtitle</span><span class="o">=</span><span class="s2">"Each dot represents 1 county"</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="n">paste</span><span class="p">(</span><span class="n">st.label</span><span class="p">,</span><span class="s2">"County Population Distributions"</span><span class="p">),</span>
       <span class="n">caption</span><span class="o">=</span><span class="s2">"@lenkiefer Source: ACS Five-Year Estimate 2010-2014"</span><span class="p">)</span>

<span class="c1"># graph 2: set up map
</span><span class="n">fips.c</span><span class="o">&lt;-</span><span class="n">as.character</span><span class="p">(</span><span class="n">head</span><span class="p">(</span><span class="n">dtf</span><span class="p">[</span><span class="n">.frame</span><span class="o">==</span><span class="n">i</span><span class="p">]</span><span class="o">$</span><span class="n">state</span><span class="p">,</span><span class="m">1</span><span class="p">))</span> <span class="c1">#get fips code for iteration i
</span><span class="n">cmap</span><span class="o">&lt;-</span><span class="n">subset</span><span class="p">(</span><span class="n">cmap.all</span><span class="p">,</span> <span class="n">state</span><span class="o">==</span><span class="n">fips.c</span><span class="p">)</span>

<span class="n">g2</span><span class="o">&lt;-</span>
  <span class="n">ggplot</span><span class="p">()</span> <span class="o">+</span>
  <span class="n">geom_map</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">,</span> <span class="n">map</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">,</span>
           <span class="n">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">long</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">lat</span><span class="p">,</span> <span class="n">map_id</span> <span class="o">=</span> <span class="n">id</span><span class="p">),</span>
           <span class="n">color</span> <span class="o">=</span> <span class="s2">"#2b2b2b"</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="m">0.05</span><span class="p">,</span> <span class="n">fill</span> <span class="o">=</span> <span class="n">NA</span><span class="p">)</span> <span class="o">+</span>
  <span class="n">geom_map</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">counties</span><span class="o">@</span><span class="n">data</span><span class="p">,</span> <span class="n">map</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">,</span>
           <span class="n">aes</span><span class="p">(</span><span class="n">fill</span> <span class="o">=</span> <span class="n">log</span><span class="p">(</span><span class="n">pop2014</span><span class="p">),</span> <span class="n">map_id</span> <span class="o">=</span> <span class="n">fips</span><span class="p">),</span>
           <span class="n">color</span> <span class="o">=</span> <span class="n">NA</span><span class="p">)</span> <span class="o">+</span>
  <span class="n">theme_map</span><span class="p">(</span> <span class="n">base_size</span> <span class="o">=</span> <span class="m">12</span><span class="p">)</span> <span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">plot.title</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span> <span class="n">size</span> <span class="o">=</span> <span class="m">16</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">(</span><span class="n">b</span><span class="o">=</span><span class="m">10</span><span class="p">)))</span> <span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">plot.subtitle</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="m">14</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">(</span><span class="n">b</span><span class="o">=</span><span class="m">-20</span><span class="p">)))</span> <span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">plot.caption</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="m">9</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="m">-15</span><span class="p">)))</span> <span class="o">+</span>
  <span class="n">coord_proj</span><span class="p">(</span><span class="n">us_laea_proj</span><span class="p">)</span> <span class="o">+</span>   <span class="n">labs</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span><span class="n">subtitle</span><span class="o">=</span><span class="s2">""</span> <span class="p">)</span> <span class="o">+</span>
  <span class="n">scale_fill_viridis</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s2">"Population"</span><span class="p">,</span> <span class="n">discrete</span><span class="o">=</span><span class="n">F</span><span class="p">,</span><span class="n">option</span><span class="o">=</span><span class="s2">"D"</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="m">0.95</span><span class="p">,</span><span class="n">direction</span><span class="o">=</span><span class="m">-1</span><span class="p">)</span><span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">legend.position</span> <span class="o">=</span> <span class="s2">"none"</span><span class="p">)</span> 

<span class="n">m</span><span class="o">&lt;-</span><span class="n">multiplot</span><span class="p">(</span><span class="n">g1</span><span class="p">,</span><span class="n">g2</span><span class="p">,</span><span class="n">layout</span><span class="o">=</span><span class="n">matrix</span><span class="p">(</span><span class="n">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">,</span><span class="m">2</span><span class="p">,</span><span class="m">2</span><span class="p">),</span> <span class="n">nrow</span><span class="o">=</span><span class="m">5</span><span class="p">,</span> <span class="n">byrow</span><span class="o">=</span><span class="n">TRUE</span><span class="p">))</span>
<span class="n">print</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
<span class="n">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="n">ani.pause</span><span class="p">()</span> <span class="p">}</span>
<span class="k">for</span> <span class="p">(</span><span class="n">i2</span> <span class="k">in</span> <span class="m">1</span><span class="o">:</span><span class="m">2</span><span class="p">)</span> <span class="p">{</span><span class="n">print</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
  <span class="n">ani.pause</span><span class="p">()</span>  <span class="p">}</span> <span class="p">},</span><span class="n">movie.name</span><span class="o">=</span><span class="s2">"map and dot v2.gif"</span><span class="p">,</span><span class="n">ani.width</span> <span class="o">=</span> <span class="m">400</span><span class="p">,</span> <span class="n">ani.height</span> <span class="o">=</span> <span class="m">500</span><span class="p">)</span></code></pre></figure>

<h1 id="what-hasnt-worked-out-so-well-yet">What hasn’t worked out so well (yet)</h1>

<p>I’ve got a few other ideas that haven’t quite worked out. You can learn a lot from failures (especially your own), so I’ll include an example.</p>

<p>I wanted to compare the distribution of county population across states to the U.S. as a whole.  So I thought I’d use a beeswarm plot (with geom_quasirandom). I wanted the state distribution to literally fall out of the national distribution using an animation.  I got this far:</p>

<p><img src="/img/charts_aug_21_2016/dot compare swarms.gif" alt="dot drops" style="width: 550px;" /></p>

<p>Technically I had some trouble getting the labels on the plot (which state is dropping), but I think there’s more wrong with it than that. Maybe we can fix it up for a later post.</p>

    </div>

    

    
  
    <hr>
    <ul class="pagination">
    
      <li class="prev"><a href="/2016/08/19/mortgage-gif-8-19-2016" title="Mortgage rate gifs: Week of Aug 19, 2016">&laquo; Previous</a></li>
    
      <li><a href="/archive.html">Archive</a></li>
    
      <li class="next"><a href="/2016/08/23/US-pop-map-1790-2010" title="U.S. county population: 1790-2010">Next &raquo;</a></li>
    
    </ul>
    <hr>
    
  </div>
</div>



      </div>

    </div>

    <div id="footer">
      <div class="container">
        <p>&copy; 2017 Len Kiefer
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>
       
    • <span vertical-align:bottom> <a href="https://twitter.com/lenkiefer" class="twitter-follow-button" data-show-count="false">•   Follow @lenkiefer</a>
  
 <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
</span>
• <script src="//platform.linkedin.com/in.js" type="text/javascript"></script>
<script type="IN/MemberProfile" data-id="https://www.linkedin.com/pub/leonard-kiefer/31/753/511" data-format="click" data-related="false" data-text="Leonard Kiefer"></script>
  • lenkiefer@hotmail.com
           </p>
      </div>
    </div>
    





<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-66905937-1', 'auto');
  ga('send', 'pageview');

</script>

    <!-- Latest compiled and minified JavaScript, requires jQuery 1.x (2.x not supported in IE8) -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="/assets/themes/lentheme/bootstrap/js/bootstrap.min.js"></script>
  </body>
</html>





