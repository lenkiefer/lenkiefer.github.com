
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Recent economic and housing market trends: August 2016</title>
    
    <meta name="author" content="Len Kiefer">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Bootstrap styles -->
    <link href="/assets/themes/lentheme/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <!-- Optional theme -->
    <link href="/assets/themes/lentheme/bootstrap/css/bootstrap-theme.min.css" rel="stylesheet">
    <!-- Sticky Footer -->
    <link href="/assets/themes/lentheme/bootstrap/css/bs-sticky-footer.css" rel="stylesheet">
    
    <!-- Custom styles -->
    <link href="/assets/themes/lentheme/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!-- Update these with your own images
      <link rel="shortcut icon" href="images/favicon.ico">
      <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
      <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
      <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
    -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

  </head>

  <body>
    <div id="wrap">
      <nav class="navbar navbar-default" role="navigation">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#jb-navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/"><span class="icon-home3" style="font-size:24px"> Len Kiefer</a></span>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="jb-navbar-collapse" style="font-size:24px">
          <ul class="nav navbar-nav" >
        <li><a href="/archive.html"><span class="icon-newspaper"> Posts</a></span></li>
            <!-- li><a href="/chartbook/index.html"><span class="icon-display"> Chartbook</a></span></li-->
         <li><a href="/resume.html"><span class="icon-profile"> Resume</span></a></li>
        <li><a href="/about.html"><span class="icon-user-tie"> About</span></a></li>
          </ul>
        </div><!-- /.navbar-collapse -->
      </nav>

      <div class="container">
        
<div class="page-header">
  <h1>Recent economic and housing market trends: August 2016 </h1>
</div>

<div class="row post-full">
  <div class="col-xs-12">
    <div class="date">
      <span>27 August 2016</span>
    </div>
    <div class="content">
      <style>
  .col2 {
    columns: 2 200px;         /* number of columns and width in pixels*/
    -webkit-columns: 2 200px; /* chrome, safari */
    -moz-columns: 2 200px;    /* firefox */
  }
  .col3 {
    columns: 3 100px;
    -webkit-columns: 3 100px;
    -moz-columns: 3 100px;
  }
</style>

<p>IN THIS POST WE’LL REVIEW some recent economic and housing market trends.  <em>R code for graphs posted below</em></p>

<h2 id="low-mortgage-rates">Low mortgage rates</h2>

<p>Mortgage rates remain low, with the 30-year fixed mortgage averaging 3.43 percent for the week of 8/25. That’s nine consecutive weeks with rates under 3.5 percent. Ever since <a href="/2016/06/26/week-in-review">Brexit</a>.</p>

<p>One way I like to look at rates is to compare the weekly rates by week of year (e.g. first week of 2016 compared to first week of 2015). The second chart below shows the weekly comparison for 2013, 2014, 2015 and 2016. By comparing the lines you can see where rates were 1-year, 2-year, and 3-years ago.</p>

<p><img src="/img/Rfig/fig-chartbk-1-aug-2016-1.svg" alt="plot of chunk fig-chartbk-1-aug-2016" /></p>

<table class="gmisc_table" style="border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;">
<thead>
<tr><td colspan="2" style="text-align: left;">
30-year fixed mortgage rates since Brexit</td></tr>
<tr>
<th style="border-bottom: 1px solid grey; border-top: 2px solid grey;"> </th>
<th style="border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;">30-year FRM</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">June 23, 2016</td>
<td style="text-align: center;">3.56</td>
</tr>
<tr style="background-color: #f7f7f7;">
<td style="background-color: #f7f7f7; text-align: left;">June 30, 2016</td>
<td style="background-color: #f7f7f7; text-align: center;">3.48</td>
</tr>
<tr>
<td style="text-align: left;">July 07, 2016</td>
<td style="text-align: center;">3.41</td>
</tr>
<tr style="background-color: #f7f7f7;">
<td style="background-color: #f7f7f7; text-align: left;">July 14, 2016</td>
<td style="background-color: #f7f7f7; text-align: center;">3.42</td>
</tr>
<tr>
<td style="text-align: left;">July 21, 2016</td>
<td style="text-align: center;">3.45</td>
</tr>
<tr style="background-color: #f7f7f7;">
<td style="background-color: #f7f7f7; text-align: left;">July 28, 2016</td>
<td style="background-color: #f7f7f7; text-align: center;">3.48</td>
</tr>
<tr>
<td style="text-align: left;">August 04, 2016</td>
<td style="text-align: center;">3.43</td>
</tr>
<tr style="background-color: #f7f7f7;">
<td style="background-color: #f7f7f7; text-align: left;">August 11, 2016</td>
<td style="background-color: #f7f7f7; text-align: center;">3.45</td>
</tr>
<tr>
<td style="text-align: left;">August 18, 2016</td>
<td style="text-align: center;">3.43</td>
</tr>
<tr style="background-color: #f7f7f7;">
<td style="background-color: #f7f7f7; border-bottom: 2px solid grey; text-align: left;">August 25, 2016</td>
<td style="background-color: #f7f7f7; border-bottom: 2px solid grey; text-align: center;">3.43</td>
</tr>
</tbody>
<tfoot><tr><td colspan="2">
Source: Freddie Mac Primary Mortgage Market Survey</td></tr></tfoot>
</table>

<h2 id="gdp-growth">GDP growth</h2>

<p>On Friday, the Bureau of Economic Analysis <a href="http://www.bea.gov/newsreleases/national/gdp/gdpnewsrelease.htm">released</a> “second” <a href="http://www.bea.gov/national/pdf/revision_information/relia.pdf">estimates</a> of Gross Domestic Product for the second quarter of 2016.</p>

<p>The growth estimates were revised down slightly, from the advance estimate of 1.2 percent growth to the second estimate of 1.1 percent. Outside of consumption, other expenditure categories remain subdued and are adding very little growth. The two charts below compare the contributions to growth across categories.</p>

<p><img src="/img/Rfig/fig-chartbk-3-aug-2016-1.svg" alt="plot of chunk fig-chartbk-3-aug-2016" /><img src="/img/Rfig/fig-chartbk-3-aug-2016-2.svg" alt="plot of chunk fig-chartbk-3-aug-2016" /></p>

<p>We also can include an animated gif of the bar chart to see how contributions to GDP growth from different components have varied over time. Outside of consumption not a lot of sources of growth in recent years.</p>

<p><img src="/img/charts_aug_27_2016/gdp_cont 2016Q2.gif" alt="GDP contributions gif" /></p>

<h2 id="home-sales-on-track-for-best-year-in-a-decade">Home sales on track for best year in a decade</h2>

<p>Home sales data were mixed, with <a href="https://www.census.gov/construction/nrs/pdf/newressales.pdf">new home sales</a> rising 12 percent from June at an annual rate, and <a href="http://www.realtor.org/news-releases/2016/08/existing-home-sales-lose-steam-in-july">existing home sales</a> declining 3.2 percent.</p>

<p><img src="/img/Rfig/fig-chartbk-sales-aug-2016-1.svg" alt="plot of chunk fig-chartbk-sales-aug-2016" /><img src="/img/Rfig/fig-chartbk-sales-aug-2016-2.svg" alt="plot of chunk fig-chartbk-sales-aug-2016" /></p>

<p>Despite the seasonally-adjusted month-over-month decline of 3.2 percent in July, year-to-date existing home sales in 2016 are at the highest level in decade.</p>

<p>And here’s an animated gif of home sales.</p>

<p><img src="/img/charts_aug_27_2016/ehs ytd july 2016.gif" alt="EHS gif" /></p>

<h2 id="housing-starts-trend-higher">Housing starts trend higher</h2>

<p>Housing starts also beat expectations <a href="https://www.census.gov/construction/nrc/pdf/newresconst.pdf">last week</a> rising to 1.21 Million units at a seasonally-adjusted annual rate.  Much of the movement was due to multifamily starts which can be noisy.  The chart below shows the monthly starts data and includes the confidence interval based on sampling uncertainty.</p>

<p><img src="/img/Rfig/fig-chartbk-starts-aug-2016-1.svg" alt="plot of chunk fig-chartbk-starts-aug-2016" /></p>

<h2 id="house-prices">House prices</h2>

<p>I’ve looked at house prices in a variety of ways. <a href="/2016/05/08/visual-meditations-on-house-prices"><em>(see my series of visual meditations)</em></a></p>

<p>Here let’s look at <a href="http://www.fhfa.gov/Media/PublicAffairs/Pages/US-House-Prices-Rise-1pt2-Percent-in-Second-Quarter-Some-Signs-of-Deceleration.aspx">recently released</a> FHFA house price index.</p>

<p><img src="/img/Rfig/fig-chartbk-fhfa-viz-aug-2016-1.svg" alt="plot of chunk fig-chartbk-fhfa-viz-aug-2016" /></p>

<p>This chart has a lot of information. The panel on the left shows both the level of house prices in the second quarter of 2016 and the past year’s history. The like segment displays the range of values the house price index has taken over the past four quarters. The longer the segment the more house prices have increased.</p>

<p>I’ve double encoded rate of increase in house prices with both segment length and color. The color which has the same scale in both panels, shows the rate at which prices have increased over the past 4 quarters. The darker purple the more price have increased (and also the longer the segment will tend to be).</p>

<p>But you can also get a sense of the long term pattern in house prices by the location of the dot on the chart. The further to the right, the more house prices have increased relative to their level in the first quarter of 2001. The District of Columbia has an index value of nearly 400, which means prices have risen almost 4 times (not inflation-adjusted) in the District since early 2001.</p>

<p>Animation is also useful for this chart. In the gif below I transition between each quarter from 2001 through the latest data for the second quarter of 2016. <em>Note: I’ve capped house price growth color scale at +/- 20%, so price growth either above or below that will be encoded with the darkest/lightest color in the graph/map. Some states experienced price increases or decreases of over 30 percent on a year-over-year basis in the FHFA Purchase-Only House Price Index data between 2001 and 2016.</em></p>

<p><img src="/img/charts_aug_27_2016/fhfa hpa3.gif" alt="FHFA HPI gif" /></p>

<h1 id="r-code">R code</h1>

<p>I made these charts using <a href="https://www.r-project.org/">R</a>.  Code for the creation of these charts can be found below.  Check back later for more!</p>

<h2 id="data">Data</h2>

<p>With the exception of the house price data, which I download directly from the FHFA <a href="http://www.fhfa.gov/DataTools/Downloads/Pages/House-Price-Index-Datasets.aspx">webpage</a>, I’ve kept the data in an <span class="icon-file-excel" style="color:green;"></span> Excel workbook.</p>

<p>You can search for code in the block beclow using the following:</p>

<table>
  <thead>
    <tr>
      <th>Graph</th>
      <th>Search for:</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Mortgage Rates</td>
      <td>@mrtg</td>
    </tr>
    <tr>
      <td>GDP</td>
      <td>@gdp</td>
    </tr>
    <tr>
      <td>Home Sales</td>
      <td>@sales</td>
    </tr>
    <tr>
      <td>Housing Starts</td>
      <td>@starts</td>
    </tr>
    <tr>
      <td>House Prices</td>
      <td>@price</td>
    </tr>
  </tbody>
</table>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1">## load required libraries ##
</span><span class="n">library</span><span class="p">(</span><span class="n">data.table</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">reshape2</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">stringr</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">scales</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">ggthemes</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">rgeos</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">maptools</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">albersusa</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">tidyr</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">ggalt</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">viridis</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">zoo</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">readxl</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">htmlTable</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">animation</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">tweenr</span><span class="p">)</span>

<span class="c1"># function for combining graphs see: http://www.cookbook-r.com/Graphs/Multiple_graphs_on_one_page_(ggplot2)/
</span><span class="n">source</span><span class="p">(</span><span class="s1">'code/multiplot.R'</span><span class="p">)</span>

<span class="c1"># source code for recession bars see: https://www.r-bloggers.com/use-geom_rect-to-add-recession-bars-to-your-time-series-plots-rstats-ggplot/
</span><span class="n">source</span><span class="p">(</span><span class="s2">"code/recessions.R"</span><span class="p">)</span>

<span class="c1">###### Mortgage rate charts @mrtg  ######
</span>
<span class="c1"># Read in data for mortgage rate charts:
</span><span class="n">mdata</span><span class="o">&lt;-</span><span class="n">read_excel</span><span class="p">(</span><span class="s2">"data/chartbook aug 2016.xlsx"</span><span class="p">,</span><span class="n">sheet</span><span class="o">=</span><span class="s2">"mrate"</span><span class="p">)</span>
<span class="n">mdata</span><span class="o">$</span><span class="n">date</span><span class="o">&lt;-</span><span class="n">as.Date</span><span class="p">(</span><span class="n">mdata</span><span class="o">$</span><span class="n">date</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s2">"%m/%d/%Y"</span><span class="p">)</span>
<span class="n">mdata</span><span class="o">&lt;-</span><span class="n">data.table</span><span class="p">(</span><span class="n">mdata</span><span class="p">)</span>

<span class="n">print.table</span><span class="o">&lt;-</span><span class="n">data.table</span><span class="p">(</span><span class="n">mdata</span><span class="p">)[</span><span class="n">date</span><span class="o">&gt;</span><span class="n">as.Date</span><span class="p">(</span><span class="s2">"2016-06-22"</span><span class="p">),</span>
                               <span class="n">list</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="n">as.character</span><span class="p">(</span><span class="n">date</span><span class="p">,</span><span class="n">format</span><span class="o">=</span><span class="s2">"%B %d, %Y"</span><span class="p">),</span>
                                    <span class="n">rate</span><span class="o">=</span><span class="n">format</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="n">nsmall</span> <span class="o">=</span> <span class="m">2</span><span class="p">))]</span>

<span class="n">rownames</span><span class="p">(</span><span class="n">print.table</span><span class="p">)</span><span class="o">&lt;-</span><span class="n">print.table</span><span class="o">$</span><span class="n">date</span>
<span class="n">print.table</span><span class="o">$</span><span class="n">date</span><span class="o">&lt;-</span><span class="n">NULL</span>
<span class="n">htmlTable</span><span class="p">(</span><span class="n">print.table</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="s2">"30-year FRM"</span><span class="p">),</span>
          <span class="n">row.names</span><span class="o">=</span><span class="n">print.table</span><span class="o">$</span><span class="n">date</span><span class="p">,</span><span class="n">row.label</span><span class="o">=</span><span class="s2">"Date"</span><span class="p">,</span>
          <span class="n">col.rgroup</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="s2">"none"</span><span class="p">,</span> <span class="s2">"#F7F7F7"</span><span class="p">),</span><span class="n">caption</span><span class="o">=</span><span class="s2">"30-year fixed mortgage rates since Brexit"</span><span class="p">,</span>
          <span class="n">tfoot</span><span class="o">=</span><span class="s2">"Source: Freddie Mac Primary Mortgage Market Survey"</span><span class="p">)</span>


<span class="n">pmms1</span><span class="o">&lt;-</span>
  <span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">mdata</span><span class="p">[</span><span class="n">year</span><span class="p">(</span><span class="n">date</span><span class="p">)</span><span class="o">&gt;=</span><span class="m">2013</span><span class="p">,</span> <span class="p">],</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">date</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">rate</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">rate</span><span class="p">))</span><span class="o">+</span><span class="n">geom_line</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">1.1</span><span class="p">)</span><span class="o">+</span><span class="n">theme_minimal</span><span class="p">()</span><span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">legend.position</span><span class="o">=</span><span class="s2">"none"</span><span class="p">)</span><span class="o">+</span>
  <span class="n">scale_x_date</span><span class="p">()</span><span class="o">+</span>
  <span class="n">scale_y_continuous</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="m">3</span><span class="p">,</span><span class="m">4.75</span><span class="p">),</span><span class="n">breaks</span><span class="o">=</span><span class="n">seq</span><span class="p">(</span><span class="m">3</span><span class="p">,</span><span class="m">4.75</span><span class="p">,</span><span class="m">.25</span><span class="p">))</span><span class="o">+</span>
  <span class="n">geom_text</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">mdata</span><span class="p">[</span><span class="n">date</span><span class="o">&gt;=</span><span class="s1">'2015-12-31'</span> <span class="o">&amp;</span> <span class="n">week</span><span class="o">==</span><span class="n">i</span><span class="p">],</span><span class="n">nudge_y</span><span class="o">=</span><span class="m">-.050</span><span class="p">,</span><span class="n">hjust</span><span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="m">3</span><span class="p">)</span><span class="o">+</span>
  <span class="n">geom_point</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">mdata</span><span class="p">[</span><span class="n">date</span><span class="o">&gt;=</span><span class="s1">'2015-12-31'</span> <span class="o">&amp;</span> <span class="n">week</span><span class="o">==</span><span class="n">i</span><span class="p">],</span><span class="n">size</span><span class="o">=</span><span class="m">2</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">"red"</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="m">0.75</span><span class="p">)</span><span class="o">+</span>
  <span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"Mortgage Rate (%)"</span><span class="p">,</span>
       <span class="n">title</span><span class="o">=</span><span class="s2">"30-year Fixed Mortgage Rate (%)"</span><span class="p">,</span>
       <span class="n">subtitle</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span>
       <span class="n">caption</span><span class="o">=</span><span class="s2">"@lenkiefer Source: Freddie Mac Primary Mortgage Market Survey"</span><span class="p">)</span><span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">plot.title</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">12</span><span class="p">))</span><span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">plot.subtitle</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">10</span><span class="p">))</span><span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">axis.title</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">8</span><span class="p">))</span><span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">axis.text</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">8</span><span class="p">))</span><span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">plot.caption</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">hjust</span><span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="n">vjust</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="m">10</span><span class="p">)))</span><span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">plot.margin</span><span class="o">=</span><span class="n">unit</span><span class="p">(</span><span class="n">c</span><span class="p">(</span><span class="m">0.25</span><span class="p">,</span><span class="m">0.25</span><span class="p">,</span><span class="m">0.25</span><span class="p">,</span><span class="m">0.25</span><span class="p">),</span><span class="s2">"cm"</span><span class="p">))</span><span class="o">+</span>
  <span class="n">coord_cartesian</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="n">as.Date</span><span class="p">(</span><span class="s2">"2012-12-31"</span><span class="p">),</span><span class="n">as.Date</span><span class="p">(</span><span class="s2">"2016-10-31"</span><span class="p">)),</span> <span class="n">y</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="m">3.25</span><span class="p">,</span><span class="m">4.75</span><span class="p">))</span>

<span class="n">pmms2</span><span class="o">&lt;-</span>  
  <span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">mdata</span><span class="p">[</span><span class="n">year</span><span class="o">&gt;</span><span class="m">2012</span> <span class="o">&amp;</span> <span class="n">week</span><span class="o">&lt;=</span><span class="n">i</span><span class="p">],</span> 
         <span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">week</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">rate</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">paste</span><span class="p">(</span><span class="s2">"   "</span><span class="p">,</span><span class="n">year</span><span class="p">),</span><span class="n">color</span><span class="o">=</span><span class="n">as.factor</span><span class="p">(</span><span class="n">year</span><span class="p">)))</span><span class="o">+</span>
  <span class="n">geom_line</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">1.1</span><span class="p">)</span><span class="o">+</span><span class="n">theme_minimal</span><span class="p">()</span><span class="o">+</span>
  <span class="n">scale_color_viridis</span><span class="p">(</span><span class="n">discrete</span><span class="o">=</span><span class="n">T</span><span class="p">,</span><span class="n">direction</span><span class="o">=</span><span class="m">-1</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="m">0.85</span><span class="p">)</span><span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">legend.position</span><span class="o">=</span><span class="s2">"none"</span><span class="p">)</span><span class="o">+</span>
  <span class="n">scale_x_continuous</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">38</span><span class="p">))</span><span class="o">+</span>
  <span class="n">scale_y_continuous</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="m">3.25</span><span class="p">,</span><span class="m">4.75</span><span class="p">),</span><span class="n">breaks</span><span class="o">=</span><span class="n">seq</span><span class="p">(</span><span class="m">3.25</span><span class="p">,</span><span class="m">4.5</span><span class="p">,</span><span class="m">0.25</span><span class="p">))</span><span class="o">+</span>
  <span class="n">geom_text</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">mdata</span><span class="p">[</span><span class="n">year</span><span class="o">&gt;</span><span class="m">2012</span> <span class="o">&amp;</span> <span class="n">week</span><span class="o">==</span><span class="n">i</span><span class="p">],</span><span class="n">size</span><span class="o">=</span><span class="m">3</span><span class="p">,</span><span class="n">hjust</span><span class="o">=</span><span class="m">0</span><span class="p">)</span><span class="o">+</span>
  <span class="n">geom_point</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">mdata</span><span class="p">[</span><span class="n">year</span><span class="o">&gt;</span><span class="m">2012</span> <span class="o">&amp;</span> <span class="n">week</span><span class="o">==</span><span class="n">i</span><span class="p">],</span><span class="n">size</span><span class="o">=</span><span class="m">3</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="m">0.75</span><span class="p">)</span><span class="o">+</span>
  <span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"Week of year"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"Mortgage Rate (%)"</span><span class="p">,</span>
       <span class="n">title</span><span class="o">=</span><span class="s2">"30-year Fixed Mortgage Rate by Week"</span><span class="p">,</span>
       <span class="n">subtitle</span><span class="o">=</span><span class="s2">"comparing 2013, 2014, 2015 and 2016"</span><span class="p">,</span>
       <span class="n">caption</span><span class="o">=</span><span class="s2">""</span><span class="p">)</span><span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">plot.title</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">12</span><span class="p">))</span><span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">plot.subtitle</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">10</span><span class="p">))</span><span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">axis.title</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">8</span><span class="p">))</span><span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">axis.text</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">8</span><span class="p">))</span><span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">plot.caption</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">hjust</span><span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="n">vjust</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="m">10</span><span class="p">)))</span><span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">plot.margin</span><span class="o">=</span><span class="n">unit</span><span class="p">(</span><span class="n">c</span><span class="p">(</span><span class="m">0.25</span><span class="p">,</span><span class="m">0.25</span><span class="p">,</span><span class="m">0.25</span><span class="p">,</span><span class="m">0.25</span><span class="p">),</span><span class="s2">"cm"</span><span class="p">))</span>

<span class="c1">#combine charts:
</span><span class="n">multiplot</span><span class="p">(</span><span class="n">pmms1</span><span class="p">,</span><span class="n">pmms2</span><span class="p">,</span><span class="n">cols</span><span class="o">=</span><span class="m">2</span><span class="p">)</span>  

<span class="c1">###### GDP contributions Charts @gdp ######
</span>
<span class="n">gdata</span><span class="o">&lt;-</span><span class="n">data.table</span><span class="p">(</span><span class="n">read_excel</span><span class="p">(</span><span class="s2">"data/chartbook aug 2016.xlsx"</span><span class="p">,</span><span class="n">sheet</span><span class="o">=</span><span class="s2">"gdpc"</span><span class="p">))</span>
<span class="n">gdata</span><span class="o">$</span><span class="n">date</span><span class="o">&lt;-</span><span class="n">as.Date</span><span class="p">(</span><span class="n">gdata</span><span class="o">$</span><span class="n">date</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s2">"%m/%d/%Y"</span><span class="p">)</span>

<span class="n">gdata</span><span class="p">[,</span> <span class="n">avgc</span><span class="o">:=</span><span class="n">mean</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">by</span><span class="o">=</span><span class="n">var</span><span class="p">]</span>
<span class="n">gdata</span><span class="o">&lt;-</span><span class="n">gdata</span><span class="p">[</span><span class="n">order</span><span class="p">(</span><span class="n">date</span><span class="p">,</span><span class="n">avgc</span><span class="p">),]</span>
<span class="n">gdata</span><span class="p">[</span><span class="n">Total</span> <span class="o">!=</span><span class="s2">"total"</span><span class="p">,</span> <span class="n">end</span><span class="o">:=</span><span class="n">cumsum</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">by</span><span class="o">=</span><span class="n">date</span><span class="p">]</span>
<span class="n">gdata</span><span class="p">[</span><span class="n">Total</span><span class="o">==</span><span class="s2">"total"</span><span class="p">,</span> <span class="n">end</span><span class="o">:=</span><span class="m">0</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="n">date</span><span class="p">]</span>
<span class="n">gdata</span><span class="p">[,</span><span class="n">start</span><span class="o">:=</span><span class="n">shift</span><span class="p">(</span><span class="n">end</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="n">fill</span><span class="o">=</span><span class="m">0</span><span class="p">),</span> <span class="n">by</span><span class="o">=</span><span class="n">date</span><span class="p">]</span>
<span class="n">gdata</span><span class="p">[,</span><span class="n">id</span><span class="o">:=</span><span class="n">.I</span><span class="p">]</span>
<span class="n">gdata</span><span class="p">[,</span><span class="n">id</span><span class="o">:=</span><span class="m">1</span><span class="o">:</span><span class="n">.N</span><span class="p">,,</span><span class="n">by</span><span class="o">=</span><span class="n">date</span><span class="p">]</span>
<span class="n">gdata</span><span class="p">[,</span> <span class="n">myjust</span><span class="o">:=</span><span class="n">ifelse</span><span class="p">(</span><span class="n">value</span><span class="o">&lt;</span><span class="m">0</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">0</span><span class="p">)]</span>
<span class="n">gdata</span><span class="p">[,</span> <span class="n">lp</span><span class="o">:=</span><span class="n">ifelse</span><span class="p">(</span><span class="n">Total</span><span class="o">==</span><span class="s2">"total"</span><span class="p">,</span><span class="n">start</span><span class="p">,</span><span class="n">end</span><span class="p">)]</span>
<span class="n">gdata</span><span class="p">[,</span><span class="n">dlabel</span><span class="o">:=</span><span class="n">factor</span><span class="p">(</span><span class="n">paste</span><span class="p">(</span><span class="n">year</span><span class="p">,</span><span class="s2">"Q"</span><span class="p">,</span><span class="n">quarter</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s2">""</span><span class="p">))]</span>
<span class="n">gdata</span><span class="p">[,</span><span class="n">cont</span><span class="o">:=</span><span class="n">factor</span><span class="p">(</span><span class="n">cont</span><span class="p">)]</span>
<span class="n">gdata</span><span class="p">[,</span><span class="n">var</span><span class="o">:=</span><span class="n">factor</span><span class="p">(</span><span class="n">var</span><span class="p">)]</span>

<span class="n">gdata</span><span class="o">$</span><span class="n">var</span><span class="o">&lt;-</span><span class="n">factor</span><span class="p">(</span><span class="n">gdata</span><span class="o">$</span><span class="n">var</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">gdata</span><span class="o">$</span><span class="n">var</span><span class="p">[</span><span class="n">order</span><span class="p">(</span><span class="n">gdata</span><span class="o">$</span><span class="n">avgc</span><span class="p">)])</span>

<span class="n">gdata.plot</span><span class="o">&lt;-</span><span class="n">gdata</span><span class="p">[</span><span class="n">year</span><span class="o">==</span><span class="m">2016</span><span class="p">]</span>
<span class="n">gdata.plot</span><span class="p">[,</span><span class="n">date.label</span><span class="o">:=</span><span class="n">paste0</span><span class="p">(</span><span class="n">year</span><span class="p">,</span><span class="s2">"Q"</span><span class="p">,</span><span class="n">quarter</span><span class="p">)]</span>

<span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">gdata.plot</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">var</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">lp</span><span class="p">,</span><span class="n">fill</span> <span class="o">=</span> <span class="n">cont</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">value</span><span class="p">))</span> <span class="o">+</span> 
  <span class="n">geom_rect</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">var</span><span class="p">,</span> <span class="n">xmin</span> <span class="o">=</span> <span class="n">id</span> <span class="o">-</span> <span class="m">0.45</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="n">id</span> <span class="o">+</span> <span class="m">0.45</span><span class="p">,</span> <span class="n">ymin</span> <span class="o">=</span> <span class="n">end</span><span class="p">,</span><span class="n">ymax</span> <span class="o">=</span> <span class="n">start</span><span class="p">))</span>  <span class="o">+</span>
  <span class="n">theme_minimal</span><span class="p">()</span><span class="o">+</span><span class="n">coord_flip</span><span class="p">()</span><span class="o">+</span>   
  <span class="n">geom_text</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">gdata.plot</span><span class="p">,</span><span class="n">aes</span><span class="p">(</span><span class="n">hjust</span><span class="o">=</span><span class="n">myjust</span><span class="p">)</span> <span class="p">)</span><span class="o">+</span>
  <span class="n">labs</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">"Contributions to Percent Change in Real Gross Domestic Product"</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span>
       <span class="n">subtitle</span><span class="o">=</span><span class="s2">"Seasonally adjusted at annual rates"</span><span class="p">,</span>
       <span class="n">caption</span><span class="o">=</span><span class="s2">"@lenkiefer Source: U.S. Bureau of Economic Analysis, Table 1.1.2, accessed 8/26/2016."</span><span class="p">)</span><span class="o">+</span>
  <span class="n">scale_fill_manual</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span><span class="n">values</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="s2">"red"</span><span class="p">,</span><span class="s2">"lightblue"</span><span class="p">,</span><span class="s2">"gray"</span><span class="p">))</span><span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">plot.title</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">12</span><span class="p">))</span><span class="o">+</span>
  <span class="n">scale_y_continuous</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="m">-3</span><span class="p">,</span><span class="m">3</span><span class="p">))</span><span class="o">+</span>
  <span class="c1">#geom_text(data=gdata.plot[cont=="total"] ,aes(y=0,x=7.25,label=dlabel),hjust=0,size=4,fontface="bold")  +
</span>  <span class="n">theme</span><span class="p">(</span><span class="n">plot.caption</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">hjust</span><span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="n">vjust</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="m">10</span><span class="p">),</span><span class="n">size</span><span class="o">=</span><span class="m">10</span><span class="p">))</span><span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">legend.justification</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">0</span><span class="p">),</span> <span class="n">legend.position</span><span class="o">=</span><span class="s2">"none"</span><span class="p">)</span><span class="o">+</span><span class="n">facet_wrap</span><span class="p">(</span><span class="o">~</span><span class="n">date.label</span><span class="p">)</span>

<span class="c1">## Make animated gif ##
</span><span class="n">myd</span><span class="o">&lt;-</span><span class="n">unique</span><span class="p">(</span><span class="n">gdata</span><span class="p">[</span><span class="n">year</span><span class="o">&gt;=</span><span class="m">2008</span><span class="p">]</span><span class="o">$</span><span class="n">date</span><span class="p">)</span>
<span class="n">myf</span><span class="o">&lt;-</span><span class="k">function</span><span class="p">(</span><span class="n">d</span><span class="p">){</span><span class="n">as.data.frame</span><span class="p">(</span><span class="n">gdata</span><span class="p">[</span><span class="n">date</span><span class="o">==</span><span class="n">d</span><span class="p">,</span> <span class="n">list</span><span class="p">(</span><span class="n">date</span><span class="p">,</span><span class="n">end</span><span class="p">,</span><span class="n">start</span><span class="p">,</span><span class="n">id</span><span class="p">,</span><span class="n">myjust</span><span class="p">,</span><span class="n">lp</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="n">cont</span><span class="p">,</span><span class="n">value</span><span class="p">,</span><span class="n">dlabel</span><span class="p">,</span><span class="n">year</span><span class="p">,</span><span class="n">avgc</span><span class="p">)])}</span>
<span class="n">pdatag</span><span class="o">&lt;-</span><span class="n">myf</span><span class="p">(</span><span class="n">myd</span><span class="p">[</span><span class="m">2</span><span class="p">])</span>
<span class="n">pdatag</span><span class="o">&lt;-</span><span class="n">data.table</span><span class="p">(</span><span class="n">pdatag</span><span class="p">)</span>

<span class="c1"># use lapply to generate the list of data sets:
</span><span class="n">my.list</span><span class="o">&lt;-</span><span class="n">lapply</span><span class="p">(</span><span class="n">c</span><span class="p">(</span><span class="n">myd</span><span class="p">,</span><span class="n">tail</span><span class="p">(</span><span class="n">myd</span><span class="p">,</span><span class="m">1</span><span class="p">),</span><span class="n">tail</span><span class="p">(</span><span class="n">myd</span><span class="p">,</span><span class="m">1</span><span class="p">),</span><span class="n">tail</span><span class="p">(</span><span class="n">myd</span><span class="p">,</span><span class="m">1</span><span class="p">),</span><span class="n">tail</span><span class="p">(</span><span class="n">myd</span><span class="p">,</span><span class="m">1</span><span class="p">)),</span><span class="n">myf</span><span class="p">)</span>

<span class="c1"># apply tweenr
</span><span class="n">tf</span> <span class="o">&lt;-</span> <span class="n">tween_states</span><span class="p">(</span><span class="n">my.list</span><span class="p">,</span> <span class="n">tweenlength</span><span class="o">=</span> <span class="m">2</span><span class="p">,</span> <span class="n">statelength</span><span class="o">=</span><span class="m">1</span><span class="p">,</span> <span class="n">ease</span><span class="o">=</span><span class="n">rep</span><span class="p">(</span><span class="s1">'cubic-in-out'</span><span class="p">,</span><span class="m">64</span><span class="p">),</span><span class="n">nframes</span><span class="o">=</span><span class="m">250</span><span class="p">)</span>

<span class="c1"># convert variable lables to factor, and order by average contribution so they go from big to small
</span><span class="n">tf</span><span class="o">$</span><span class="n">var</span><span class="o">&lt;-</span><span class="n">factor</span><span class="p">(</span><span class="n">tf</span><span class="o">$</span><span class="n">var</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">tf</span><span class="o">$</span><span class="n">var</span><span class="p">[</span><span class="n">order</span><span class="p">(</span><span class="n">tf</span><span class="o">$</span><span class="n">avgc</span><span class="p">)])</span>
<span class="c1">#conver to data table
</span><span class="n">tf</span><span class="o">&lt;-</span><span class="n">data.table</span><span class="p">(</span><span class="n">tf</span><span class="p">)</span>

<span class="n">p</span><span class="o">&lt;-</span>
  <span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">tf</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">var</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">lp</span><span class="p">,</span><span class="n">fill</span> <span class="o">=</span> <span class="n">cont</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">value</span><span class="p">,</span><span class="n">frame</span><span class="o">=</span><span class="n">.frame</span><span class="p">))</span> <span class="o">+</span> 
  <span class="n">geom_rect</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">var</span><span class="p">,</span> <span class="n">xmin</span> <span class="o">=</span> <span class="n">id</span> <span class="o">-</span> <span class="m">0.45</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="n">id</span> <span class="o">+</span> <span class="m">0.45</span><span class="p">,</span> <span class="n">ymin</span> <span class="o">=</span> <span class="n">end</span><span class="p">,</span><span class="n">ymax</span> <span class="o">=</span> <span class="n">start</span><span class="p">))</span>  <span class="o">+</span>
  <span class="n">theme_minimal</span><span class="p">()</span><span class="o">+</span><span class="n">coord_flip</span><span class="p">()</span><span class="o">+</span>   <span class="n">geom_text</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">tf</span><span class="p">[</span><span class="n">date</span> <span class="o">%</span><span class="k">in</span><span class="o">%</span> <span class="n">myd</span> <span class="p">,</span> <span class="p">]</span> <span class="p">,</span><span class="n">hjust</span><span class="o">=</span><span class="n">tf</span><span class="p">[</span><span class="n">date</span> <span class="o">%</span><span class="k">in</span><span class="o">%</span> <span class="n">myd</span> <span class="p">,</span> <span class="p">]</span><span class="o">$</span><span class="n">myjust</span><span class="p">)</span><span class="o">+</span>
  <span class="n">labs</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">"Contributions to Percent Change in Real Gross Domestic Product"</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span>
       <span class="n">subtitle</span><span class="o">=</span><span class="s2">"Seasonally adjusted at annual rates"</span><span class="p">,</span>
       <span class="n">caption</span><span class="o">=</span><span class="s2">"@lenkiefer Source: U.S. Bureau of Economic Analysis, Table 1.1.2, accessed 8/26/2016."</span><span class="p">)</span><span class="o">+</span>
  <span class="n">scale_fill_manual</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span><span class="n">values</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="s2">"red"</span><span class="p">,</span><span class="s2">"lightblue"</span><span class="p">,</span><span class="s2">"gray"</span><span class="p">))</span><span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">plot.title</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">12</span><span class="p">))</span><span class="o">+</span>
  <span class="n">geom_text</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">tf</span><span class="p">[</span><span class="n">cont</span><span class="o">==</span><span class="s2">"total"</span> <span class="p">,</span>  <span class="p">]</span> <span class="p">,</span><span class="n">aes</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="m">7.25</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">dlabel</span><span class="p">),</span><span class="n">hjust</span><span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="m">4</span><span class="p">,</span><span class="n">fontface</span><span class="o">=</span><span class="s2">"bold"</span><span class="p">)</span>  <span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">plot.caption</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">hjust</span><span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="n">vjust</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="m">10</span><span class="p">),</span><span class="n">size</span><span class="o">=</span><span class="m">10</span><span class="p">))</span><span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">legend.justification</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">0</span><span class="p">),</span> <span class="n">legend.position</span><span class="o">=</span><span class="s2">"none"</span><span class="p">)</span>

<span class="n">gg_animate</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s2">"contributions to gdp 2016q2.gif"</span><span class="p">,</span> <span class="n">title_frame</span> <span class="o">=</span> <span class="n">F</span><span class="p">,</span> <span class="n">ani.width</span> <span class="o">=</span> <span class="m">740</span><span class="p">,</span> 
           <span class="n">ani.height</span> <span class="o">=</span> <span class="m">550</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="m">.1</span><span class="p">)</span>


<span class="c1">#### GDP contributions time series @gdp ####
</span>
<span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">gdata</span><span class="p">[</span><span class="n">year</span><span class="o">&gt;</span><span class="m">1980</span> <span class="o">&amp;</span> <span class="n">cont</span><span class="o">!=</span><span class="s2">"total"</span><span class="p">,])</span><span class="o">+</span><span class="n">facet_wrap</span><span class="p">(</span><span class="o">~</span><span class="n">var</span><span class="p">)</span><span class="o">+</span>
  <span class="n">theme_minimal</span><span class="p">()</span><span class="o">+</span> <span class="n">theme</span><span class="p">(</span><span class="n">plot.title</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">12</span><span class="p">))</span><span class="o">+</span>
  <span class="n">scale_color_viridis</span><span class="p">(</span><span class="n">discrete</span><span class="o">=</span><span class="n">T</span><span class="p">,</span><span class="n">direction</span><span class="o">=</span><span class="m">-1</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="m">0.85</span><span class="p">)</span><span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">plot.caption</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">hjust</span><span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="n">vjust</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="m">10</span><span class="p">),</span><span class="n">size</span><span class="o">=</span><span class="m">10</span><span class="p">))</span><span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">legend.justification</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">0</span><span class="p">),</span> <span class="n">legend.position</span><span class="o">=</span><span class="s2">"none"</span><span class="p">)</span><span class="o">+</span>
  <span class="n">geom_rect</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">subset</span><span class="p">(</span><span class="n">recessions.df</span><span class="p">,</span><span class="n">Peak</span><span class="o">&gt;=</span><span class="s2">"1980-01-01"</span><span class="p">),</span> 
            <span class="n">aes</span><span class="p">(</span><span class="n">xmin</span><span class="o">=</span><span class="n">Peak</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="n">Trough</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=-</span><span class="n">Inf</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=+</span><span class="n">Inf</span><span class="p">),</span> <span class="n">fill</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="m">0.35</span><span class="p">)</span><span class="o">+</span>
  <span class="n">geom_line</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">date</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">value</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">var</span><span class="p">),</span><span class="n">size</span><span class="o">=</span><span class="m">1.1</span><span class="p">)</span><span class="o">+</span>
  <span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="s2">"Contributions to Percent Change in Real Gross Domestic Product"</span><span class="p">,</span>
       <span class="n">subtitle</span><span class="o">=</span><span class="s2">"Seasonally adjusted at annual rates"</span><span class="p">,</span>
       <span class="n">caption</span><span class="o">=</span><span class="s2">"@lenkiefer Source: U.S. Bureau of Economic Analysis, Table 1.1.2, accessed 8/26/2016.\nShaded area NBER Recession dates"</span><span class="p">)</span>
  

<span class="c1">######  Home sales charts @sales  ######
</span>
<span class="n">mydata</span><span class="o">&lt;-</span><span class="n">read_excel</span><span class="p">(</span><span class="s2">"data/chartbook aug 2016.xlsx"</span><span class="p">,</span><span class="n">sheet</span><span class="o">=</span><span class="s2">"sales"</span><span class="p">)</span>
<span class="n">mydata</span><span class="o">$</span><span class="n">date</span><span class="o">&lt;-</span><span class="n">as.Date</span><span class="p">(</span><span class="n">mydata</span><span class="o">$</span><span class="n">date</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s2">"%m/%d/%Y"</span><span class="p">)</span>

<span class="n">mydata</span><span class="o">$</span><span class="n">date</span><span class="o">&lt;-</span><span class="n">as.Date</span><span class="p">(</span><span class="n">mydata</span><span class="o">$</span><span class="n">date</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s2">"%m/%d/%Y"</span><span class="p">)</span>
<span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">mydata</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">date</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">nhs.sa</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">nhs.sa</span><span class="p">))</span><span class="o">+</span><span class="n">geom_line</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">mydata</span><span class="p">)</span><span class="o">+</span>
  <span class="n">scale_y_continuous</span><span class="p">(</span><span class="n">limits</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="m">200</span><span class="p">,</span> <span class="m">1600</span><span class="p">),</span> <span class="n">breaks</span><span class="o">=</span><span class="n">seq</span><span class="p">(</span><span class="m">200</span><span class="p">,</span><span class="m">1600</span><span class="p">,</span><span class="m">200</span><span class="p">))</span> <span class="o">+</span> 
  <span class="n">geom_point</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">tail</span><span class="p">(</span><span class="n">mydata</span><span class="p">,</span><span class="m">1</span><span class="p">),</span><span class="n">colour</span> <span class="o">=</span> <span class="n">plasma</span><span class="p">(</span><span class="m">5</span><span class="p">)[</span><span class="m">1</span><span class="p">],</span> <span class="n">size</span> <span class="o">=</span> <span class="m">3</span><span class="p">)</span><span class="o">+</span>
  <span class="n">scale_x_date</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span> <span class="n">date_format</span><span class="p">(</span><span class="s2">"%b-%Y"</span><span class="p">),</span> <span class="n">limits</span> <span class="o">=</span> <span class="n">as.Date</span><span class="p">(</span><span class="n">c</span><span class="p">(</span><span class="s1">'2000-01-01'</span><span class="p">,</span><span class="s1">'2016-08-31'</span><span class="p">)))</span> <span class="o">+</span>
  <span class="n">geom_ribbon</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">mydata</span><span class="p">,</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">date</span><span class="p">,</span><span class="n">ymin</span><span class="o">=</span><span class="n">down</span><span class="p">,</span><span class="n">ymax</span><span class="o">=</span><span class="n">up</span><span class="p">),</span><span class="n">fill</span><span class="o">=</span><span class="n">plasma</span><span class="p">(</span><span class="m">5</span><span class="p">)[</span><span class="m">5</span><span class="p">],</span><span class="n">alpha</span><span class="o">=</span><span class="m">0.5</span><span class="p">)</span>  <span class="o">+</span>
  <span class="n">geom_hline</span><span class="p">(</span><span class="n">yintercept</span><span class="o">=</span><span class="n">tail</span><span class="p">(</span><span class="n">mydata</span><span class="p">,</span><span class="m">1</span><span class="p">)</span><span class="o">$</span><span class="n">nhs.sa</span><span class="p">,</span><span class="n">linetype</span><span class="o">=</span><span class="m">2</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">plasma</span><span class="p">(</span><span class="m">5</span><span class="p">)[</span><span class="m">1</span><span class="p">])</span><span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">axis.title.x</span> <span class="o">=</span> <span class="n">element_blank</span><span class="p">())</span> <span class="o">+</span>   <span class="c1"># Remove x-axis label
</span>  <span class="n">ylab</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span><span class="o">+</span><span class="n">xlab</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span><span class="o">+</span>
  <span class="n">theme_minimal</span><span class="p">()</span><span class="o">+</span>
  <span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">NULL</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">NULL</span><span class="p">,</span>
       <span class="n">title</span><span class="o">=</span><span class="s2">"New Home Sales (Ths. SAAR)"</span><span class="p">,</span>
       <span class="n">subtitle</span><span class="o">=</span><span class="n">paste</span><span class="p">(</span><span class="n">as.character</span><span class="p">(</span><span class="n">tail</span><span class="p">(</span><span class="n">mydata</span><span class="p">,</span><span class="m">1</span><span class="p">)</span><span class="o">$</span><span class="n">date</span><span class="p">,</span><span class="n">format</span><span class="o">=</span><span class="s2">"%b-%Y"</span><span class="p">),</span><span class="s2">":"</span><span class="p">,</span><span class="n">tail</span><span class="p">(</span><span class="n">mydata</span><span class="p">,</span><span class="m">1</span><span class="p">)</span><span class="o">$</span><span class="n">nhs.sa</span><span class="p">),</span>
       <span class="n">caption</span><span class="o">=</span><span class="s2">"@lenkiefer Source: Census/HUD, shaded area denotes confidence interval"</span><span class="p">)</span><span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">plot.caption</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">hjust</span><span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="n">vjust</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="m">10</span><span class="p">)))</span><span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">plot.subtitle</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">plasma</span><span class="p">(</span><span class="m">5</span><span class="p">)[</span><span class="m">1</span><span class="p">]))</span><span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">plot.margin</span><span class="o">=</span><span class="n">unit</span><span class="p">(</span><span class="n">c</span><span class="p">(</span><span class="m">0.5</span><span class="p">,</span><span class="m">0.5</span><span class="p">,</span><span class="m">0.5</span><span class="p">,</span><span class="m">0.75</span><span class="p">),</span><span class="s2">"cm"</span><span class="p">))</span>

<span class="n">mydata</span><span class="o">&lt;-</span><span class="n">data.table</span><span class="p">(</span><span class="n">mydata</span><span class="p">)</span>    
<span class="n">mydata</span><span class="p">[,</span> <span class="n">ehsc</span><span class="o">:=</span><span class="n">cumsum</span><span class="p">(</span><span class="n">ehs</span><span class="p">),</span> <span class="n">by</span><span class="o">=</span><span class="n">year</span><span class="p">]</span>  <span class="c1">#computer cumulative sales YTD
</span>
<span class="c1">#Make plot
</span><span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">mydata</span><span class="p">[</span><span class="n">year</span><span class="o">&gt;</span><span class="m">2006</span> <span class="o">&amp;</span> <span class="n">month</span><span class="o">&lt;</span><span class="m">8</span><span class="p">],</span> 
       <span class="n">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">factor</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="n">y</span> <span class="o">=</span> <span class="n">ehs</span><span class="p">,</span><span class="n">fill</span><span class="o">=</span><span class="n">reorder</span><span class="p">(</span><span class="n">mname</span><span class="p">,</span><span class="n">month</span><span class="p">),</span><span class="n">label</span><span class="o">=</span><span class="n">mname</span><span class="p">))</span> <span class="o">+</span>
  <span class="n">geom_bar</span><span class="p">(</span><span class="n">color</span> <span class="o">=</span> <span class="s2">"gray"</span><span class="p">,</span> <span class="n">stat</span> <span class="o">=</span> <span class="s2">"identity"</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="m">0.75</span><span class="p">)</span><span class="o">+</span>
  <span class="n">scale_fill_viridis</span><span class="p">(</span><span class="n">discrete</span><span class="o">=</span><span class="n">T</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="m">0.95</span><span class="p">,</span><span class="n">direction</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="n">option</span><span class="o">=</span><span class="s2">"D"</span><span class="p">)</span><span class="o">+</span>  <span class="c1">#use viridis color scale
</span>  <span class="n">theme_minimal</span><span class="p">()</span><span class="o">+</span> 
  <span class="n">geom_text</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">mydata</span><span class="p">[</span><span class="n">month</span><span class="o">==</span><span class="m">7</span> <span class="o">&amp;</span> <span class="n">year</span><span class="o">==</span><span class="m">2016</span><span class="p">],</span><span class="n">aes</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">ehsc</span><span class="p">),</span><span class="n">nudge_y</span><span class="o">=</span><span class="m">0.25</span><span class="p">,</span><span class="n">hjust</span><span class="o">=</span><span class="m">-.2</span><span class="p">)</span><span class="o">+</span>
  <span class="n">geom_hline</span><span class="p">(</span><span class="n">yintercept</span><span class="o">=</span><span class="n">mydata</span><span class="p">[</span> <span class="n">month</span><span class="o">==</span><span class="m">7</span> <span class="o">&amp;</span> <span class="n">year</span><span class="o">==</span><span class="m">2016</span><span class="p">]</span><span class="o">$</span><span class="n">ehsc</span><span class="p">,</span><span class="n">linetype</span><span class="o">=</span><span class="m">2</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">"black"</span><span class="p">)</span><span class="o">+</span>
  <span class="n">xlab</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span><span class="o">+</span><span class="n">ylab</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span><span class="o">+</span>
  <span class="n">labs</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">"Existing Home Sales (Ths. NSA)"</span><span class="p">,</span>
       <span class="n">subtitle</span><span class="o">=</span><span class="s2">"dotted line 2016 YTD"</span><span class="p">,</span>
       <span class="n">caption</span><span class="o">=</span><span class="s2">"@lenkiefer Source:NAR"</span><span class="p">)</span><span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">plot.title</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">14</span><span class="p">))</span><span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">legend.justification</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">0</span><span class="p">),</span> <span class="n">legend.position</span><span class="o">=</span><span class="s2">"none"</span><span class="p">)</span><span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">plot.caption</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">hjust</span><span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="n">vjust</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="m">10</span><span class="p">)))</span><span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">plot.margin</span><span class="o">=</span><span class="n">unit</span><span class="p">(</span><span class="n">c</span><span class="p">(</span><span class="m">0.25</span><span class="p">,</span><span class="m">0.25</span><span class="p">,</span><span class="m">0.25</span><span class="p">,</span><span class="m">0.25</span><span class="p">),</span><span class="s2">"cm"</span><span class="p">))</span><span class="o">+</span>
  <span class="n">coord_flip</span><span class="p">()</span>  <span class="c1">#flip so that the bars are horizontal rather than vertical    
</span>
<span class="c1">## Make animated home sales chart: ##
</span>
<span class="n">myf3</span><span class="o">&lt;-</span><span class="k">function</span><span class="p">(</span><span class="n">m</span><span class="p">){</span>
  <span class="n">DT</span><span class="o">&lt;-</span><span class="n">copy</span><span class="p">(</span><span class="n">mydata</span><span class="p">)</span>
  <span class="n">DT</span><span class="o">&lt;-</span><span class="n">DT</span><span class="p">[</span><span class="n">month</span><span class="o">&gt;</span><span class="n">m</span><span class="p">,</span><span class="n">ehs</span><span class="o">:=</span><span class="m">0</span><span class="p">]</span>
  <span class="n">DT</span><span class="o">$</span><span class="n">mm</span><span class="o">&lt;-</span><span class="n">m</span>
  <span class="n">DT</span> <span class="o">%&gt;%</span> <span class="n">map_if</span><span class="p">(</span><span class="n">is.character</span><span class="p">,</span> <span class="n">as.factor</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="n">as.data.frame</span><span class="p">()</span> <span class="o">-&gt;</span><span class="n">DT</span> 
  <span class="n">as.data.frame</span><span class="p">(</span><span class="n">DT</span><span class="p">)}</span>



<span class="n">my.list3</span><span class="o">&lt;-</span><span class="n">lapply</span><span class="p">(</span><span class="n">c</span><span class="p">(</span><span class="n">seq</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">7</span><span class="p">,</span><span class="m">1</span><span class="p">),</span><span class="m">0</span><span class="p">),</span><span class="n">myf3</span><span class="p">)</span>  <span class="c1">#the animation will loop through each of the first five months of the year an then meet back at 0.
</span><span class="n">tf</span> <span class="o">&lt;-</span> <span class="n">tween_states</span><span class="p">(</span><span class="n">my.list3</span><span class="p">,</span> <span class="n">tweenlength</span><span class="o">=</span> <span class="m">2</span><span class="p">,</span> <span class="n">statelength</span><span class="o">=</span><span class="m">3</span><span class="p">,</span> <span class="n">ease</span><span class="o">=</span><span class="n">rep</span><span class="p">(</span><span class="s1">'cubic-in-out'</span><span class="p">,</span><span class="m">17</span><span class="p">),</span><span class="n">nframes</span><span class="o">=</span><span class="m">70</span><span class="p">)</span>
<span class="n">tf</span><span class="o">&lt;-</span><span class="n">data.table</span><span class="p">(</span><span class="n">tf</span><span class="p">)</span>  


<span class="n">oopt</span> <span class="o">=</span> <span class="n">ani.options</span><span class="p">(</span><span class="n">interval</span> <span class="o">=</span> <span class="m">0.125</span><span class="p">)</span>
<span class="n">saveGIF</span><span class="p">({</span><span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="k">in</span> <span class="m">1</span><span class="o">:</span><span class="n">max</span><span class="p">(</span><span class="n">tf</span><span class="o">$</span><span class="n">.frame</span><span class="p">))</span> <span class="p">{</span>
  <span class="n">g</span><span class="o">&lt;-</span>
    <span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">tf</span><span class="p">[</span><span class="n">year</span><span class="o">&gt;</span><span class="m">2006</span> <span class="o">&amp;</span> <span class="n">.frame</span><span class="o">==</span><span class="n">i</span> <span class="o">&amp;</span> <span class="n">month</span><span class="o">&lt;</span><span class="m">8</span><span class="p">],</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">factor</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="n">y</span> <span class="o">=</span> <span class="n">ehs</span><span class="p">,</span><span class="n">fill</span><span class="o">=</span><span class="n">reorder</span><span class="p">(</span><span class="n">mname</span><span class="p">,</span><span class="n">month</span><span class="p">),</span><span class="n">label</span><span class="o">=</span><span class="n">mname</span><span class="p">))</span> <span class="o">+</span> <span class="n">geom_bar</span><span class="p">(</span><span class="n">color</span> <span class="o">=</span> <span class="s2">"gray"</span><span class="p">,</span> <span class="n">stat</span> <span class="o">=</span> <span class="s2">"identity"</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="m">0.75</span><span class="p">)</span><span class="o">+</span>
    <span class="n">scale_fill_viridis</span><span class="p">(</span><span class="n">discrete</span><span class="o">=</span><span class="n">T</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="m">0.95</span><span class="p">,</span><span class="n">direction</span><span class="o">=</span><span class="m">-1</span><span class="p">,</span><span class="n">option</span><span class="o">=</span><span class="s2">"D"</span><span class="p">)</span><span class="o">+</span>  <span class="c1">#use viridis color scale
</span>    <span class="n">theme_minimal</span><span class="p">()</span><span class="o">+</span> 
    <span class="n">geom_text</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">tf</span><span class="p">[</span><span class="n">month</span><span class="o">==</span><span class="n">mm</span><span class="o">&amp;</span> <span class="n">year</span><span class="o">==</span><span class="m">2016</span> <span class="o">&amp;</span> <span class="n">.frame</span><span class="o">==</span><span class="n">i</span><span class="p">],</span><span class="n">aes</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">ehsc</span><span class="p">),</span><span class="n">nudge_y</span><span class="o">=</span><span class="m">0.25</span><span class="p">,</span><span class="n">hjust</span><span class="o">=</span><span class="m">-.2</span><span class="p">)</span><span class="o">+</span>
    <span class="n">geom_hline</span><span class="p">(</span><span class="n">yintercept</span><span class="o">=</span><span class="n">tf</span><span class="p">[</span><span class="n">.frame</span><span class="o">==</span><span class="n">i</span> <span class="o">&amp;</span> <span class="n">month</span><span class="o">==</span><span class="n">mm</span> <span class="o">&amp;</span> <span class="n">year</span><span class="o">==</span><span class="m">2016</span><span class="p">]</span><span class="o">$</span><span class="n">ehsc</span><span class="p">,</span><span class="n">linetype</span><span class="o">=</span><span class="m">2</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">"black"</span><span class="p">)</span><span class="o">+</span>
    <span class="n">xlab</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span><span class="o">+</span><span class="n">ylab</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span><span class="o">+</span>
    <span class="n">labs</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">"Existing Home Sales (Ths. NSA)"</span><span class="p">,</span>
         <span class="n">subtitle</span><span class="o">=</span><span class="s2">"dotted line 2016 YTD"</span><span class="p">,</span>
         <span class="n">caption</span><span class="o">=</span><span class="s2">"@lenkiefer Source:NAR"</span><span class="p">)</span><span class="o">+</span>
    <span class="n">theme</span><span class="p">(</span><span class="n">plot.title</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">14</span><span class="p">))</span><span class="o">+</span>
    <span class="n">theme</span><span class="p">(</span><span class="n">legend.justification</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">0</span><span class="p">),</span> <span class="n">legend.position</span><span class="o">=</span><span class="s2">"none"</span><span class="p">)</span><span class="o">+</span>
    <span class="n">theme</span><span class="p">(</span><span class="n">plot.caption</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">hjust</span><span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="n">vjust</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="m">10</span><span class="p">)))</span><span class="o">+</span>
    <span class="n">theme</span><span class="p">(</span><span class="n">plot.margin</span><span class="o">=</span><span class="n">unit</span><span class="p">(</span><span class="n">c</span><span class="p">(</span><span class="m">0.25</span><span class="p">,</span><span class="m">0.25</span><span class="p">,</span><span class="m">0.25</span><span class="p">,</span><span class="m">0.25</span><span class="p">),</span><span class="s2">"cm"</span><span class="p">))</span><span class="o">+</span>
    
    <span class="n">scale_y_continuous</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">3500</span><span class="p">),</span><span class="n">labels</span><span class="o">=</span><span class="n">comma</span><span class="p">)</span><span class="o">+</span><span class="n">coord_flip</span><span class="p">()</span>
  <span class="n">print</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
  <span class="n">ani.pause</span><span class="p">()</span>
<span class="p">}</span>
<span class="p">},</span><span class="n">movie.name</span><span class="o">=</span><span class="s2">"ehs ytd july 2016.gif"</span><span class="p">,</span><span class="n">ani.width</span> <span class="o">=</span> <span class="m">600</span><span class="p">,</span> <span class="n">ani.height</span> <span class="o">=</span> <span class="m">450</span><span class="p">)</span>


<span class="c1">###### Housing starts @starts ######
</span>
<span class="n">mydata</span><span class="o">&lt;-</span><span class="n">read_excel</span><span class="p">(</span><span class="s2">"data/chartbook aug 2016.xlsx"</span><span class="p">,</span><span class="n">sheet</span><span class="o">=</span><span class="s2">"startserr"</span><span class="p">)</span>
<span class="n">mydata</span><span class="o">$</span><span class="n">date</span><span class="o">&lt;-</span><span class="n">as.Date</span><span class="p">(</span><span class="n">mydata</span><span class="o">$</span><span class="n">date</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s2">"%m/%d/%Y"</span><span class="p">)</span>
<span class="n">mydata</span><span class="o">$</span><span class="n">sales</span><span class="o">&lt;-</span><span class="n">mydata</span><span class="o">$</span><span class="n">nsales</span>
<span class="n">mydata</span><span class="o">$</span><span class="n">slabel</span><span class="o">&lt;-</span><span class="n">round</span><span class="p">(</span><span class="n">mydata</span><span class="o">$</span><span class="n">starts</span><span class="p">,</span><span class="m">0</span><span class="p">)</span>
<span class="n">mydata</span><span class="o">$</span><span class="n">slabel2</span><span class="o">&lt;-</span><span class="n">round</span><span class="p">(</span><span class="n">mydata</span><span class="o">$</span><span class="n">hmi</span><span class="p">,</span><span class="m">0</span><span class="p">)</span>
<span class="n">mydata</span><span class="o">&lt;-</span><span class="n">data.table</span><span class="p">(</span><span class="n">mydata</span><span class="p">)</span>
<span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">mydata</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">date</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">starts</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">slabel</span><span class="p">))</span><span class="o">+</span><span class="n">geom_line</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">mydata</span><span class="p">)</span><span class="o">+</span>
  <span class="n">scale_y_continuous</span><span class="p">(</span><span class="n">limits</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="m">400</span><span class="p">,</span> <span class="m">2300</span><span class="p">),</span> <span class="n">breaks</span><span class="o">=</span><span class="n">seq</span><span class="p">(</span><span class="m">400</span><span class="p">,</span><span class="m">2300</span><span class="p">,</span><span class="m">200</span><span class="p">))</span> <span class="o">+</span> 
  <span class="n">geom_point</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">tail</span><span class="p">(</span><span class="n">mydata</span><span class="p">,</span><span class="m">2</span><span class="p">),</span><span class="n">colour</span> <span class="o">=</span> <span class="n">viridis</span><span class="p">(</span><span class="m">5</span><span class="p">)[</span><span class="m">1</span><span class="p">],</span> <span class="n">size</span> <span class="o">=</span> <span class="m">3</span><span class="p">)</span><span class="o">+</span>
  <span class="n">scale_x_date</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span> <span class="n">date_format</span><span class="p">(</span><span class="s2">"%b-%Y"</span><span class="p">),</span>
               <span class="n">limits</span> <span class="o">=</span> <span class="n">as.Date</span><span class="p">(</span><span class="n">c</span><span class="p">(</span><span class="s1">'2000-01-01'</span><span class="p">,</span><span class="s1">'2016-12-31'</span><span class="p">)))</span> <span class="o">+</span>
  <span class="n">geom_ribbon</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">mydata</span><span class="p">,</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">date</span><span class="p">,</span><span class="n">ymin</span><span class="o">=</span><span class="n">down</span><span class="p">,</span><span class="n">ymax</span><span class="o">=</span><span class="n">up</span><span class="p">),</span><span class="n">fill</span><span class="o">=</span><span class="n">viridis</span><span class="p">(</span><span class="m">5</span><span class="p">)[</span><span class="m">5</span><span class="p">],</span><span class="n">alpha</span><span class="o">=</span><span class="m">0.5</span><span class="p">)</span>  <span class="o">+</span>
  <span class="n">coord_cartesian</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="n">as.Date</span><span class="p">(</span><span class="n">c</span><span class="p">(</span><span class="s1">'2000-01-01'</span><span class="p">,</span><span class="s1">'2016-08-31'</span><span class="p">)))</span><span class="o">+</span>
  <span class="n">geom_hline</span><span class="p">(</span><span class="n">yintercept</span><span class="o">=</span><span class="n">tail</span><span class="p">(</span><span class="n">mydata</span><span class="p">,</span><span class="m">2</span><span class="p">)</span><span class="o">$</span><span class="n">starts</span><span class="p">,</span><span class="n">linetype</span><span class="o">=</span><span class="m">2</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">viridis</span><span class="p">(</span><span class="m">5</span><span class="p">)[</span><span class="m">5</span><span class="p">])</span><span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">axis.title.x</span> <span class="o">=</span> <span class="n">element_blank</span><span class="p">())</span> <span class="o">+</span>   <span class="c1"># Remove x-axis label
</span>  <span class="n">ylab</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span><span class="o">+</span><span class="n">xlab</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span><span class="o">+</span>
  <span class="n">theme_minimal</span><span class="p">()</span><span class="o">+</span>
  <span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">NULL</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">NULL</span><span class="p">,</span>
       <span class="n">title</span><span class="o">=</span><span class="s2">"Housing Starts (Ths. SAAR)"</span><span class="p">,</span>
       <span class="c1">#subtitle=paste(as.character(mydata$date[i],format="%b-%Y"),":",tail(mydata$slabel[i]),
</span>       <span class="n">caption</span><span class="o">=</span><span class="s2">"@lenkiefer Source: Census/HUD, shaded area denotes confidence interval"</span><span class="p">)</span><span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">plot.caption</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">hjust</span><span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="n">vjust</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="m">10</span><span class="p">)))</span><span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">plot.subtitle</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">plasma</span><span class="p">(</span><span class="m">5</span><span class="p">)[</span><span class="m">1</span><span class="p">]))</span><span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">plot.margin</span><span class="o">=</span><span class="n">unit</span><span class="p">(</span><span class="n">c</span><span class="p">(</span><span class="m">0.5</span><span class="p">,</span><span class="m">0.5</span><span class="p">,</span><span class="m">0.5</span><span class="p">,</span><span class="m">0.75</span><span class="p">),</span><span class="s2">"cm"</span><span class="p">))</span>


<span class="c1">######  House price chart @price  ###### 
</span>
<span class="c1">#read data:
</span><span class="n">fhfa.data</span><span class="o">&lt;-</span><span class="n">fread</span><span class="p">(</span><span class="s2">"http://www.fhfa.gov/DataTools/Downloads/Documents/HPI/HPI_PO_state.txt"</span><span class="p">)</span>

<span class="n">fhfa.data</span><span class="p">[,</span><span class="n">hpa12</span><span class="o">:=</span><span class="n">index_sa</span><span class="o">/</span><span class="n">shift</span><span class="p">(</span><span class="n">index_sa</span><span class="p">,</span><span class="m">4</span><span class="p">)</span><span class="m">-1</span><span class="p">,</span><span class="n">by</span><span class="o">=</span><span class="n">state</span><span class="p">]</span>
<span class="n">fhfa.data</span><span class="p">[,</span><span class="n">lag4</span><span class="o">:=</span><span class="n">shift</span><span class="p">(</span><span class="n">index_sa</span><span class="p">,</span><span class="m">4</span><span class="p">)</span><span class="m">-1</span><span class="p">,</span><span class="n">by</span><span class="o">=</span><span class="n">state</span><span class="p">]</span>


<span class="n">fhfa.data</span><span class="p">[,</span><span class="n">iso_3166_2</span><span class="o">:=</span><span class="n">state</span><span class="p">]</span>
<span class="n">fhfa.data</span><span class="p">[,</span><span class="n">date</span><span class="o">:=</span><span class="n">as.Date</span><span class="p">(</span><span class="n">ISOdate</span><span class="p">(</span><span class="n">yr</span><span class="p">,</span><span class="n">qtr</span><span class="o">*</span><span class="m">3</span><span class="p">,</span><span class="m">1</span><span class="p">))]</span>
<span class="n">fhfa.data</span><span class="p">[,</span><span class="n">map.color</span><span class="o">:=</span><span class="n">min</span><span class="p">(</span><span class="m">0.2</span><span class="p">,</span><span class="n">max</span><span class="p">(</span><span class="m">-0.2</span><span class="p">,</span><span class="n">hpa12</span><span class="p">)),</span><span class="n">by</span><span class="o">=</span><span class="n">list</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="n">date</span><span class="p">)]</span>

<span class="c1">#reset index so that Q1 2000 =100
</span><span class="n">b.data</span><span class="o">&lt;-</span><span class="n">fhfa.data</span><span class="p">[</span><span class="n">yr</span><span class="o">==</span><span class="m">2001</span> <span class="o">&amp;</span> <span class="n">qtr</span><span class="o">==</span><span class="m">1</span><span class="p">,</span><span class="n">list</span><span class="p">(</span><span class="n">hpi00Q1</span><span class="o">=</span><span class="n">index_sa</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="n">state</span><span class="p">]</span>

<span class="n">fhfa.data</span><span class="o">&lt;-</span><span class="n">merge</span><span class="p">(</span><span class="n">fhfa.data</span><span class="p">,</span><span class="n">b.data</span><span class="p">,</span><span class="n">by</span><span class="o">=</span><span class="s2">"state"</span><span class="p">)</span>
<span class="n">fhfa.data</span><span class="p">[,</span><span class="n">index_sa2</span><span class="o">:=</span><span class="m">100</span><span class="o">*</span><span class="n">index_sa</span><span class="o">/</span><span class="n">hpi00Q1</span><span class="p">]</span>
<span class="n">fhfa.data</span><span class="p">[,</span><span class="n">max4</span><span class="o">:=</span><span class="n">rollapply</span><span class="p">(</span><span class="n">index_sa2</span><span class="p">,</span><span class="m">4</span><span class="p">,</span><span class="n">max</span><span class="p">,</span><span class="n">align</span><span class="o">=</span><span class="s2">"right"</span><span class="p">,</span><span class="n">fill</span><span class="o">=</span><span class="n">NA</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="n">state</span><span class="p">]</span>
<span class="n">fhfa.data</span><span class="p">[,</span><span class="n">min4</span><span class="o">:=</span><span class="n">rollapply</span><span class="p">(</span><span class="n">index_sa2</span><span class="p">,</span><span class="m">4</span><span class="p">,</span><span class="n">min</span><span class="p">,</span><span class="n">align</span><span class="o">=</span><span class="s2">"right"</span><span class="p">,</span><span class="n">fill</span><span class="o">=</span><span class="n">NA</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="n">state</span><span class="p">]</span>

<span class="n">states</span><span class="o">&lt;-</span><span class="n">usa_composite</span><span class="p">()</span>
<span class="n">smap</span><span class="o">&lt;-</span><span class="n">fortify</span><span class="p">(</span><span class="n">states</span><span class="p">,</span><span class="n">region</span><span class="o">=</span><span class="s2">"fips_state"</span><span class="p">)</span>
<span class="n">smap.all</span><span class="o">&lt;-</span><span class="n">smap</span>

<span class="n">states</span><span class="o">@</span><span class="n">data</span> <span class="o">&lt;-</span> <span class="n">left_join</span><span class="p">(</span><span class="n">states</span><span class="o">@</span><span class="n">data</span><span class="p">,</span> <span class="n">fhfa.data</span><span class="p">,</span> <span class="n">by</span> <span class="o">=</span> <span class="s2">"iso_3166_2"</span><span class="p">)</span>


<span class="c1">### Function for preparing graph data ###
</span><span class="n">make_graph_data</span><span class="o">&lt;-</span><span class="k">function</span><span class="p">(</span><span class="n">d</span><span class="p">){</span>
  <span class="n">yy</span><span class="o">&lt;-</span><span class="n">year</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
  <span class="n">qq</span><span class="o">&lt;-</span><span class="n">quarter</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
  <span class="n">start.date</span><span class="o">&lt;-</span> <span class="n">as.Date</span><span class="p">(</span><span class="n">ISOdate</span><span class="p">(</span><span class="n">yy</span><span class="m">-2</span><span class="p">,</span><span class="n">qq</span><span class="o">*</span><span class="m">3</span><span class="p">,</span><span class="m">1</span><span class="p">)</span> <span class="p">)</span>
  <span class="n">end.date</span><span class="o">&lt;-</span> <span class="n">as.Date</span><span class="p">(</span><span class="n">ISOdate</span><span class="p">(</span><span class="n">yy</span><span class="p">,</span><span class="n">qq</span><span class="o">*</span><span class="m">3</span><span class="p">,</span><span class="m">1</span><span class="p">)</span> <span class="p">)</span>
  <span class="n">mygraph.data</span><span class="o">&lt;-</span><span class="n">subset</span><span class="p">(</span><span class="n">fhfa.data</span><span class="p">,</span><span class="n">date</span><span class="o">==</span><span class="n">d</span><span class="p">)</span>
  <span class="n">mygraph.data</span> <span class="o">%&gt;%</span> <span class="n">map_if</span><span class="p">(</span><span class="n">is.character</span><span class="p">,</span> <span class="n">as.factor</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="n">as.data.frame</span><span class="p">()</span> <span class="o">-&gt;</span><span class="n">mygraph.data</span>  
  <span class="k">return</span><span class="p">(</span><span class="n">mygraph.data</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">### Function for creating plot ###
</span><span class="n">mycombo</span><span class="o">&lt;-</span><span class="k">function</span><span class="p">(</span><span class="n">indata</span><span class="p">){</span>
  <span class="n">states</span><span class="o">&lt;-</span><span class="n">usa_composite</span><span class="p">()</span>
  <span class="n">states</span><span class="o">@</span><span class="n">data</span> <span class="o">&lt;-</span> <span class="n">left_join</span><span class="p">(</span><span class="n">states</span><span class="o">@</span><span class="n">data</span><span class="p">,</span> <span class="n">indata</span><span class="p">,</span> <span class="n">by</span> <span class="o">=</span> <span class="s2">"iso_3166_2"</span><span class="p">)</span>
  <span class="n">d</span><span class="o">&lt;-</span><span class="n">max</span><span class="p">(</span><span class="n">indata</span><span class="o">$</span><span class="n">date</span><span class="p">)</span>
  <span class="n">yy</span><span class="o">&lt;-</span><span class="n">year</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
  <span class="n">qq</span><span class="o">&lt;-</span><span class="n">quarter</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
<span class="n">map1</span><span class="o">&lt;-</span>
    <span class="n">ggplot</span><span class="p">()</span> <span class="o">+</span>
    <span class="n">geom_map</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">smap.all</span><span class="p">,</span> <span class="n">map</span> <span class="o">=</span> <span class="n">smap.all</span><span class="p">,</span>
             <span class="n">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">long</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">lat</span><span class="p">,</span> <span class="n">map_id</span> <span class="o">=</span> <span class="n">id</span><span class="p">),</span>
             <span class="n">color</span> <span class="o">=</span> <span class="s2">"#2b2b2b"</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="m">0.05</span><span class="p">,</span> <span class="n">fill</span> <span class="o">=</span> <span class="n">NA</span><span class="p">)</span> <span class="o">+</span>
    <span class="n">geom_map</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span>  <span class="n">states</span><span class="o">@</span><span class="n">data</span><span class="p">,</span> <span class="n">map</span> <span class="o">=</span> <span class="n">smap.all</span><span class="p">,</span>
             <span class="n">aes</span><span class="p">(</span> <span class="n">map_id</span> <span class="o">=</span> <span class="n">fips_state</span><span class="p">,</span><span class="n">fill</span><span class="o">=</span><span class="n">map.color</span><span class="p">),</span>
             <span class="n">color</span> <span class="o">=</span> <span class="s2">"gray"</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="m">.25</span><span class="p">)</span> <span class="o">+</span>
    <span class="n">theme_map</span><span class="p">(</span> <span class="n">base_size</span> <span class="o">=</span> <span class="m">12</span><span class="p">)</span> <span class="o">+</span>
    <span class="n">theme</span><span class="p">(</span><span class="n">plot.title</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span> <span class="n">size</span> <span class="o">=</span> <span class="m">12</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">(</span><span class="n">b</span><span class="o">=</span><span class="m">10</span><span class="p">)))</span> <span class="o">+</span>
    <span class="n">theme</span><span class="p">(</span><span class="n">plot.subtitle</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="m">10</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">(</span><span class="n">b</span><span class="o">=</span><span class="m">-20</span><span class="p">)))</span> <span class="o">+</span>
    <span class="n">theme</span><span class="p">(</span><span class="n">plot.caption</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="m">9</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="m">-15</span><span class="p">)))</span> <span class="o">+</span>
    <span class="n">coord_proj</span><span class="p">(</span><span class="n">us_laea_proj</span><span class="p">)</span> <span class="o">+</span>   <span class="n">labs</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span><span class="n">subtitle</span><span class="o">=</span><span class="s2">""</span> <span class="p">)</span> <span class="o">+</span>
    <span class="n">scale_fill_viridis</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s2">" "</span><span class="p">,</span> <span class="n">discrete</span><span class="o">=</span><span class="n">F</span><span class="p">,</span><span class="n">option</span><span class="o">=</span><span class="s2">"C"</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="m">1</span><span class="p">,</span>
                       <span class="n">direction</span><span class="o">=</span><span class="m">-1</span><span class="p">,</span>         <span class="n">limits</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="m">-0.2</span><span class="p">,</span><span class="m">0.2</span><span class="p">),</span><span class="n">label</span><span class="o">=</span><span class="n">percent</span><span class="p">)</span><span class="o">+</span>
    <span class="n">theme</span><span class="p">(</span><span class="n">legend.position</span> <span class="o">=</span> <span class="s2">"top"</span><span class="p">)</span> <span class="o">+</span><span class="n">theme</span><span class="p">(</span><span class="n">plot.caption</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">hjust</span><span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="n">vjust</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="m">10</span><span class="p">)))</span><span class="o">+</span>
    <span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span>
         <span class="n">title</span><span class="o">=</span><span class="n">paste0</span><span class="p">(</span><span class="s2">"Annual House Price Growth (Y/Y %) Q"</span><span class="p">,</span><span class="n">qq</span><span class="p">,</span><span class="s2">":"</span><span class="p">,</span><span class="n">yy</span><span class="p">),</span>
         <span class="n">caption</span><span class="o">=</span><span class="s2">"@lenkiefer Source: FHFA Purchase-Only House Price Index (SA)"</span><span class="p">)</span>
  
  <span class="n">graph1</span><span class="o">&lt;-</span>
    <span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">indata</span><span class="p">,</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">index_sa2</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">state</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">map.color</span><span class="p">))</span><span class="o">+</span><span class="n">geom_point</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">2</span><span class="p">)</span><span class="o">+</span>
    <span class="n">theme_minimal</span><span class="p">()</span><span class="o">+</span> <span class="n">theme</span><span class="p">(</span><span class="n">legend.position</span> <span class="o">=</span> <span class="s2">"none"</span><span class="p">)</span> <span class="o">+</span>
    <span class="n">scale_x_log10</span><span class="p">(</span><span class="n">breaks</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="m">100</span><span class="p">,</span><span class="m">150</span><span class="p">,</span><span class="m">200</span><span class="p">,</span><span class="m">300</span><span class="p">,</span><span class="m">400</span><span class="p">),</span><span class="n">limits</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="m">75</span><span class="p">,</span><span class="m">400</span><span class="p">))</span><span class="o">+</span>
    <span class="n">scale_color_viridis</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s2">""</span><span class="p">,</span> <span class="n">discrete</span><span class="o">=</span><span class="n">F</span><span class="p">,</span><span class="n">option</span><span class="o">=</span><span class="s2">"C"</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="m">1</span><span class="p">,</span>
                        <span class="n">direction</span><span class="o">=</span><span class="m">-1</span><span class="p">,</span>         <span class="n">limits</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="m">-0.2</span><span class="p">,</span><span class="m">0.2</span><span class="p">),</span><span class="n">label</span><span class="o">=</span><span class="n">percent</span><span class="p">)</span><span class="o">+</span>
    <span class="n">geom_segment</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">min4</span><span class="p">,</span><span class="n">xend</span><span class="o">=</span><span class="n">max4</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">state</span><span class="p">,</span><span class="n">yend</span><span class="o">=</span><span class="n">state</span><span class="p">),</span><span class="n">size</span><span class="o">=</span><span class="m">1.05</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="m">0.6</span><span class="p">)</span><span class="o">+</span>  <span class="n">theme</span><span class="p">(</span><span class="n">axis.text</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">8</span><span class="p">))</span><span class="o">+</span>
    <span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"House Price Index\nlog scale,Q1:2001=100"</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="n">paste0</span><span class="p">(</span><span class="s2">"House Price Index Q"</span><span class="p">,</span><span class="n">qq</span><span class="p">,</span><span class="s2">":"</span><span class="p">,</span><span class="n">yy</span><span class="p">),</span>
         <span class="n">caption</span><span class="o">=</span><span class="s2">"dot is value, line 4 trailing quarter min/max"</span><span class="p">)</span><span class="o">+</span>
    <span class="n">theme</span><span class="p">(</span><span class="n">plot.caption</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">hjust</span><span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="n">vjust</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="m">10</span><span class="p">)))</span>
  
  <span class="n">multiplot</span><span class="p">(</span><span class="n">graph1</span><span class="p">,</span><span class="n">map1</span><span class="p">,</span><span class="n">cols</span><span class="o">=</span><span class="m">2</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">mycombo</span><span class="p">(</span><span class="n">make_graph_data</span><span class="p">(</span><span class="s2">"2016-06-01"</span><span class="p">))</span>

<span class="c1">#### Make the animated gif  ####
</span>

<span class="n">d.list</span><span class="o">&lt;-</span><span class="n">unique</span><span class="p">(</span><span class="n">subset</span><span class="p">(</span><span class="n">fhfa.data</span><span class="p">,</span><span class="n">yr</span><span class="o">&gt;</span><span class="m">2000</span><span class="p">)</span><span class="o">$</span><span class="n">date</span><span class="p">)</span>
<span class="c1"># d.list&lt;-unique(subset(fhfa.data,yr&gt;2000 &amp; qtr==2)$date)  # alternative if you want to go 4 quarters at a time
</span><span class="n">my.list</span><span class="o">&lt;-</span><span class="n">lapply</span><span class="p">(</span><span class="n">c</span><span class="p">(</span><span class="n">d.list</span><span class="p">,</span><span class="n">d.list</span><span class="p">[</span><span class="m">1</span><span class="p">]),</span><span class="n">make_graph_data</span><span class="p">)</span>
<span class="n">tf</span> <span class="o">&lt;-</span> <span class="n">tween_states</span><span class="p">(</span><span class="n">my.list</span><span class="p">,</span><span class="n">tweenlength</span><span class="o">=</span> <span class="m">3</span><span class="p">,</span> <span class="n">statelength</span><span class="o">=</span><span class="m">2</span><span class="p">,</span> <span class="n">ease</span><span class="o">=</span><span class="n">rep</span><span class="p">(</span><span class="s1">'cubic-in-out'</span><span class="p">,</span><span class="m">2</span><span class="p">),</span><span class="n">nframes</span><span class="o">=</span><span class="n">length</span><span class="p">(</span><span class="n">d.list</span><span class="p">)</span><span class="o">*</span><span class="m">8</span><span class="p">)</span>
<span class="n">tf</span><span class="o">&lt;-</span><span class="n">data.table</span><span class="p">(</span><span class="n">tf</span><span class="p">)</span> <span class="c1">#data.table useful for subsetting
</span><span class="n">N</span><span class="o">&lt;-</span><span class="n">max</span><span class="p">(</span><span class="n">tf</span><span class="o">$</span><span class="n">.frame</span><span class="p">)</span>  <span class="c1">#number of frames
</span>
<span class="c1">#create the animation
</span><span class="n">oopt</span> <span class="o">=</span> <span class="n">ani.options</span><span class="p">(</span><span class="n">interval</span> <span class="o">=</span> <span class="m">0.15</span><span class="p">)</span>
<span class="n">saveGIF</span><span class="p">({</span><span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="k">in</span> <span class="m">1</span><span class="o">:</span><span class="n">N</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">mycombo</span><span class="p">(</span><span class="n">tf</span><span class="p">[</span><span class="n">.frame</span><span class="o">==</span><span class="n">i</span><span class="p">])</span>
  <span class="n">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
  <span class="n">ani.pause</span><span class="p">()</span>  <span class="p">}</span>
<span class="p">},</span><span class="n">movie.name</span><span class="o">=</span><span class="s2">"fhfa hpa4.gif"</span><span class="p">,</span><span class="n">ani.width</span> <span class="o">=</span> <span class="m">800</span><span class="p">,</span> <span class="n">ani.height</span> <span class="o">=</span> <span class="m">450</span><span class="p">)</span></code></pre></figure>


    </div>

    

    
  
    <hr>
    <ul class="pagination">
    
      <li class="prev"><a href="/2016/08/26/more-on-pop-distribution" title="Density squared">&laquo; Previous</a></li>
    
      <li><a href="/archive.html">Archive</a></li>
    
      <li class="next"><a href="/2016/09/02/consumer-spend" title="What we spend: Consumer Expenditures in 2015">Next &raquo;</a></li>
    
    </ul>
    <hr>
    
  </div>
</div>



      </div>

    </div>

    <div id="footer">
      <div class="container">
        <p>&copy; 2017 Len Kiefer
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>
       
    • <span vertical-align:bottom> <a href="https://twitter.com/lenkiefer" class="twitter-follow-button" data-show-count="false">•   Follow @lenkiefer</a>
  
 <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
</span>
• <script src="//platform.linkedin.com/in.js" type="text/javascript"></script>
<script type="IN/MemberProfile" data-id="https://www.linkedin.com/pub/leonard-kiefer/31/753/511" data-format="click" data-related="false" data-text="Leonard Kiefer"></script>
  • lenkiefer@hotmail.com
           </p>
      </div>
    </div>
    





<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-66905937-1', 'auto');
  ga('send', 'pageview');

</script>

    <!-- Latest compiled and minified JavaScript, requires jQuery 1.x (2.x not supported in IE8) -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="/assets/themes/lentheme/bootstrap/js/bootstrap.min.js"></script>
  </body>
</html>





