
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Density squared</title>
    
    <meta name="author" content="Len Kiefer">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Bootstrap styles -->
    <link href="/assets/themes/lentheme/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <!-- Optional theme -->
    <link href="/assets/themes/lentheme/bootstrap/css/bootstrap-theme.min.css" rel="stylesheet">
    <!-- Sticky Footer -->
    <link href="/assets/themes/lentheme/bootstrap/css/bs-sticky-footer.css" rel="stylesheet">
    
    <!-- Custom styles -->
    <link href="/assets/themes/lentheme/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!-- Update these with your own images
      <link rel="shortcut icon" href="images/favicon.ico">
      <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
      <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
      <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
    -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

  </head>

  <body>
    <div id="wrap">
      <nav class="navbar navbar-default" role="navigation">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#jb-navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/"><span class="icon-home3" style="font-size:24px"> Len Kiefer</a></span>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="jb-navbar-collapse" style="font-size:24px">
          <ul class="nav navbar-nav" >
        <li><a href="/archive.html"><span class="icon-newspaper"> Posts</a></span></li>
            <!-- li><a href="/chartbook/index.html"><span class="icon-display"> Chartbook</a></span></li-->
         <li><a href="/resume.html"><span class="icon-profile"> Resume</span></a></li>
        <li><a href="/about.html"><span class="icon-user-tie"> About</span></a></li>
          </ul>
        </div><!-- /.navbar-collapse -->
      </nav>

      <div class="container">
        
<div class="page-header">
  <h1>Density squared </h1>
</div>

<div class="row post-full">
  <div class="col-xs-12">
    <div class="date">
      <span>26 August 2016</span>
    </div>
    <div class="content">
      <p>WE ARE GOING TO EXAMINE THE DISTRIBUTION OF US POPULATION and make an animated gif combining a map and a kernel density estimate of the distribution of county population densities. Density of densities, or density squared.</p>

<p>We are going to use the same <a href="http://conservancy.umn.edu/handle/11299/181605">US County Population Estimates 1790-2010</a> we used in <a href="/2016/08/23/US-pop-map-1790-2010">my previous post</a>.</p>

<p>We’ll end up with this:</p>

<p><img src="/img/charts_aug_26_2016/pop density gif.gif" alt="population with distro" /></p>

<p>How do we do it?</p>

<h1 id="code">Code</h1>

<p>First, we’ll load the data and do some manipulations.  Then we’ll construct a composite plot combining the map of the United States with a distribution plot.  I’m going to focus on estimated population density (population per square mile) for counties in the United States.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># function for combining graphs see: http://www.cookbook-r.com/Graphs/Multiple_graphs_on_one_page_(ggplot2)/
</span><span class="n">source</span><span class="p">(</span><span class="s1">'code/multiplot.R'</span><span class="p">)</span>

<span class="c1">#load density data and 
</span><span class="n">densityDF</span><span class="o">&lt;-</span><span class="n">read_excel</span><span class="p">(</span><span class="s2">"data/county2010_hist_pops.xlsx"</span><span class="p">,</span><span class="n">sheet</span><span class="o">=</span><span class="s2">"densities"</span><span class="p">)</span>
<span class="n">densityDF</span><span class="o">&lt;-</span><span class="n">densityDF</span> <span class="o">%&gt;%</span> <span class="n">gather</span><span class="p">(</span><span class="n">year.of</span><span class="p">,</span><span class="s2">"density"</span><span class="p">,</span><span class="m">6</span><span class="o">:</span><span class="m">28</span><span class="p">)</span> 
<span class="n">densityDF</span><span class="o">&lt;-</span><span class="n">mutate</span><span class="p">(</span><span class="n">densityDF</span><span class="p">,</span><span class="n">year</span><span class="o">=</span><span class="n">substr</span><span class="p">(</span><span class="n">year.of</span><span class="p">,</span><span class="m">5</span><span class="p">,</span><span class="m">9</span><span class="p">))</span>
<span class="n">densityDF</span><span class="o">&lt;-</span><span class="n">data.table</span><span class="p">(</span><span class="n">densityDF</span><span class="p">)</span>
<span class="n">densityDF</span><span class="o">$</span><span class="n">fips</span><span class="o">&lt;-</span><span class="n">densityDF</span><span class="o">$</span><span class="n">GEOID10</span>

<span class="c1"># Map stuff
</span>
<span class="n">states</span><span class="o">&lt;-</span><span class="n">usa_composite</span><span class="p">()</span>
<span class="n">smap</span><span class="o">&lt;-</span><span class="n">fortify</span><span class="p">(</span><span class="n">states</span><span class="p">,</span><span class="n">region</span><span class="o">=</span><span class="s2">"fips_state"</span><span class="p">)</span>
<span class="n">smap.all</span><span class="o">&lt;-</span><span class="n">smap</span>
<span class="n">counties</span> <span class="o">&lt;-</span> <span class="n">counties_composite</span><span class="p">()</span>
<span class="c1">#get data:
</span><span class="n">counties</span><span class="o">@</span><span class="n">data</span> <span class="o">&lt;-</span> <span class="n">left_join</span><span class="p">(</span><span class="n">counties</span><span class="o">@</span><span class="n">data</span><span class="p">,</span> <span class="n">densityDF</span><span class="p">,</span> <span class="n">by</span> <span class="o">=</span> <span class="s2">"fips"</span><span class="p">)</span>
<span class="n">cmap</span> <span class="o">&lt;-</span> <span class="n">fortify</span><span class="p">(</span><span class="n">counties_composite</span><span class="p">(),</span> <span class="n">region</span><span class="o">=</span><span class="s2">"fips"</span><span class="p">)</span>
<span class="n">cmap</span><span class="o">$</span><span class="n">state</span><span class="o">&lt;-</span><span class="n">substr</span><span class="p">(</span><span class="n">cmap</span><span class="o">$</span><span class="n">id</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">)</span>
<span class="n">cmap</span><span class="o">$</span><span class="n">county</span><span class="o">&lt;-</span><span class="n">substr</span><span class="p">(</span><span class="n">cmap</span><span class="o">$</span><span class="n">id</span><span class="p">,</span><span class="m">3</span><span class="p">,</span><span class="m">5</span><span class="p">)</span>
<span class="n">cmap</span><span class="o">$</span><span class="n">fips</span><span class="o">&lt;-</span><span class="n">paste0</span><span class="p">(</span><span class="n">cmap</span><span class="o">$</span><span class="n">state</span><span class="p">,</span><span class="n">cmap</span><span class="o">$</span><span class="n">county</span><span class="p">)</span>
<span class="n">cmap.all</span><span class="o">&lt;-</span><span class="n">cmap</span>


<span class="n">mycaption</span><span class="o">&lt;-</span><span class="s2">"@lenkiefer Source: Schroeder, Jonathan P. (2016). Historical Population Estimates for 2010 U.S. States, Counties and Metro/Micro Areas, 1790-2010. Retrieved from the Data Repository for the University of Minnesota, http://doi.org/10.13020/D6XW2H."</span>
<span class="n">mycaption</span> <span class="o">&lt;-</span> <span class="n">paste0</span><span class="p">(</span><span class="n">strwrap</span><span class="p">(</span><span class="n">mycaption</span><span class="p">,</span> <span class="m">130</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span> <span class="n">collapse</span><span class="o">=</span><span class="s2">"\n"</span><span class="p">)</span>

<span class="c1"># create a function to wrap our graphs:
</span>
<span class="n">myplotf</span><span class="o">&lt;-</span><span class="k">function</span><span class="p">(</span><span class="n">indata</span><span class="p">){</span>
  <span class="n">indata</span><span class="o">$</span><span class="n">fips</span><span class="o">&lt;-</span><span class="n">as.character</span><span class="p">(</span><span class="n">indata</span><span class="o">$</span><span class="n">fips</span><span class="p">)</span>
  <span class="n">indata</span><span class="o">$</span><span class="n">year</span><span class="o">&lt;-</span><span class="n">as.character</span><span class="p">(</span><span class="n">indata</span><span class="o">$</span><span class="n">year</span><span class="p">)</span>
  <span class="n">counties</span> <span class="o">&lt;-</span> <span class="n">counties_composite</span><span class="p">()</span>
  <span class="c1">#merge indata to countyies@data:
</span>  <span class="n">counties</span><span class="o">@</span><span class="n">data</span> <span class="o">&lt;-</span> <span class="n">left_join</span><span class="p">(</span><span class="n">counties</span><span class="o">@</span><span class="n">data</span><span class="p">,</span> <span class="n">indata</span><span class="p">,</span> <span class="n">by</span> <span class="o">=</span> <span class="s2">"fips"</span><span class="p">)</span>
  

<span class="n">map1</span><span class="o">&lt;-</span>
  <span class="n">ggplot</span><span class="p">()</span> <span class="o">+</span>
  <span class="n">geom_map</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">cmap.all</span><span class="p">,</span> <span class="n">map</span> <span class="o">=</span> <span class="n">cmap.all</span><span class="p">,</span>
           <span class="n">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">long</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">lat</span><span class="p">,</span> <span class="n">map_id</span> <span class="o">=</span> <span class="n">id</span><span class="p">),</span>
           <span class="n">color</span> <span class="o">=</span> <span class="s2">"lightgray"</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="m">0.05</span><span class="p">,</span> <span class="n">fill</span> <span class="o">=</span> <span class="n">NA</span><span class="p">)</span> <span class="o">+</span>
 
    <span class="n">geom_map</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">counties</span><span class="o">@</span><span class="n">data</span><span class="p">,</span> <span class="n">map</span> <span class="o">=</span> <span class="n">cmap.all</span><span class="p">,</span>
           <span class="n">aes</span><span class="p">(</span><span class="n">fill</span> <span class="o">=</span><span class="n">log</span><span class="p">(</span><span class="n">density</span><span class="p">),</span> <span class="n">map_id</span> <span class="o">=</span> <span class="n">fips</span><span class="p">),</span>
           <span class="n">color</span> <span class="o">=</span> <span class="n">NA</span><span class="p">)</span> <span class="o">+</span>
     <span class="n">geom_map</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">smap.all</span><span class="p">,</span> <span class="n">map</span> <span class="o">=</span> <span class="n">smap.all</span><span class="p">,</span>
           <span class="n">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">long</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">lat</span><span class="p">,</span> <span class="n">map_id</span> <span class="o">=</span> <span class="n">id</span><span class="p">),</span>
           <span class="n">color</span> <span class="o">=</span> <span class="s2">"white"</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="m">.5</span><span class="p">,</span> <span class="n">fill</span> <span class="o">=</span> <span class="n">NA</span><span class="p">)</span> <span class="o">+</span>

  <span class="n">theme_map</span><span class="p">(</span> <span class="n">base_size</span> <span class="o">=</span> <span class="m">12</span><span class="p">)</span> <span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">plot.title</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span> <span class="n">size</span> <span class="o">=</span> <span class="m">16</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">(</span><span class="n">b</span><span class="o">=</span><span class="m">10</span><span class="p">)))</span> <span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">plot.subtitle</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="m">10</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">(</span><span class="n">b</span><span class="o">=</span><span class="m">-20</span><span class="p">)))</span> <span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">plot.caption</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="m">9</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="m">-15</span><span class="p">)))</span> <span class="o">+</span>
  <span class="n">coord_proj</span><span class="p">(</span><span class="n">us_laea_proj</span><span class="p">)</span> <span class="o">+</span>   <span class="n">labs</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span><span class="n">subtitle</span><span class="o">=</span><span class="s2">""</span> <span class="p">)</span> <span class="o">+</span>
  <span class="n">scale_fill_viridis</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"Population Density\nlog scale\npersons / sq. mile, land area\n"</span><span class="p">,</span>
                      <span class="n">discrete</span><span class="o">=</span><span class="n">F</span><span class="p">,</span><span class="n">option</span><span class="o">=</span><span class="s2">"D"</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="m">0.95</span><span class="p">,</span><span class="n">direction</span><span class="o">=</span><span class="m">-1</span><span class="p">,</span><span class="n">limits</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="m">.079</span><span class="p">),</span><span class="n">log</span><span class="p">(</span><span class="m">2e5</span><span class="p">)),</span>
                      <span class="n">breaks</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="m">1</span><span class="p">),</span><span class="n">log</span><span class="p">(</span><span class="m">10</span><span class="p">),</span><span class="n">log</span><span class="p">(</span><span class="m">100</span><span class="p">),</span><span class="n">log</span><span class="p">(</span><span class="m">1000</span><span class="p">),</span><span class="n">log</span><span class="p">(</span><span class="m">10000</span><span class="p">),</span><span class="n">log</span><span class="p">(</span><span class="m">1e5</span><span class="p">)),</span>
                      <span class="n">labels</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="s2">"1"</span><span class="p">,</span><span class="s2">"10"</span><span class="p">,</span><span class="s2">"100"</span><span class="p">,</span><span class="s2">"1,000"</span><span class="p">,</span><span class="s2">"10,000"</span><span class="p">,</span><span class="s2">"100,000"</span><span class="p">))</span> <span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">legend.position</span> <span class="o">=</span> <span class="s2">"right"</span><span class="p">)</span> <span class="o">+</span><span class="n">theme</span><span class="p">(</span><span class="n">plot.caption</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">hjust</span><span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="n">vjust</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="m">10</span><span class="p">)))</span><span class="o">+</span>
  <span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"Denisty(log scale)"</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span>
       <span class="n">subtitle</span><span class="o">=</span><span class="s2">"persons / sq. mile, land area"</span><span class="p">,</span>
       <span class="n">caption</span><span class="o">=</span><span class="n">mycaption</span> <span class="p">,</span>
       <span class="n">title</span><span class="o">=</span><span class="n">paste0</span><span class="p">(</span><span class="s2">"County Population Density in "</span><span class="p">,</span><span class="n">head</span><span class="p">(</span><span class="n">indata</span><span class="p">,</span><span class="m">1</span><span class="p">)</span><span class="o">$</span><span class="n">year</span><span class="p">))</span>

<span class="c1">#compute some states for chart
</span><span class="n">indata</span><span class="o">&lt;-</span><span class="n">data.table</span><span class="p">(</span><span class="n">indata</span><span class="p">)</span>
<span class="n">indata</span><span class="p">[,</span><span class="n">med.dens</span><span class="o">:=</span><span class="n">median</span><span class="p">(</span><span class="n">density</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="n">STATE</span><span class="p">]</span>  <span class="c1">#mean density across counties (unweighted)
</span><span class="n">indata</span><span class="p">[,</span><span class="n">us.med</span><span class="o">:=</span><span class="n">median</span><span class="p">(</span><span class="n">density</span><span class="p">)]</span>           <span class="c1">#median density for the U.S.
</span><span class="n">graph1</span><span class="o">&lt;-</span>
  <span class="n">ggplot</span><span class="p">(</span><span class="n">indata</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">log</span><span class="p">(</span><span class="n">density</span><span class="p">)))</span> <span class="o">+</span> 
  <span class="c1">#the fill will depend on a value we'll feed to the data my.alpha, defined below
</span>  <span class="n">geom_density</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="n">head</span><span class="p">(</span><span class="n">indata</span><span class="p">,</span><span class="m">1</span><span class="p">)</span><span class="o">$</span><span class="n">my.alpha</span><span class="p">,</span><span class="n">aes</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="n">STATE</span><span class="p">,</span><span class="n">fill</span><span class="o">=</span><span class="n">log</span><span class="p">(</span><span class="n">med.dens</span><span class="p">)),</span><span class="n">color</span><span class="o">=</span><span class="n">NA</span><span class="p">)</span><span class="o">+</span>
  <span class="n">geom_density</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">.75</span><span class="p">,</span><span class="n">aes</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="n">log</span><span class="p">(</span><span class="n">us.med</span><span class="p">)),</span><span class="n">alpha</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">"darkgray"</span><span class="p">)</span><span class="o">+</span>
  <span class="n">theme_minimal</span><span class="p">()</span><span class="o">+</span>
  <span class="n">scale_fill_viridis</span><span class="p">(</span><span class="n">discrete</span><span class="o">=</span><span class="n">F</span><span class="p">,</span><span class="n">option</span><span class="o">=</span><span class="s2">"D"</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="m">0.95</span><span class="p">,</span><span class="n">direction</span><span class="o">=</span><span class="m">-1</span><span class="p">,</span><span class="n">limits</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="m">.079</span><span class="p">),</span><span class="n">log</span><span class="p">(</span><span class="m">1.2e5</span><span class="p">)),</span><span class="n">name</span><span class="o">=</span><span class="s2">"Median County Density"</span><span class="p">)</span><span class="o">+</span>
   <span class="n">scale_color_viridis</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s2">"Population Density"</span><span class="p">,</span> <span class="n">discrete</span><span class="o">=</span><span class="n">T</span><span class="p">,</span><span class="n">option</span><span class="o">=</span><span class="s2">"D"</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="m">0.95</span><span class="p">)</span><span class="o">+</span>
    <span class="n">theme</span><span class="p">(</span><span class="n">legend.justification</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">0</span><span class="p">),</span> <span class="n">legend.position</span><span class="o">=</span><span class="s2">"none"</span><span class="p">)</span><span class="o">+</span>
  <span class="n">facet_wrap</span><span class="p">(</span><span class="o">~</span><span class="n">year</span><span class="p">)</span><span class="o">+</span>
  <span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"Population density (log scale)"</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="s2">"Kernel density curve fit to county population density"</span><span class="p">,</span><span class="n">subtitle</span><span class="o">=</span><span class="s2">"distribution over population density for each county in the U.S."</span><span class="p">,</span><span class="n">caption</span><span class="o">=</span><span class="s2">"Line distribution for U.S.\nEach colored area shows distribution across counties for an individual state"</span><span class="p">)</span><span class="o">+</span>
  <span class="n">scale_x_continuous</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="m">.079</span><span class="p">),</span><span class="n">log</span><span class="p">(</span><span class="m">1.2e5</span><span class="p">)),</span>
                      <span class="n">breaks</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="m">1</span><span class="p">),</span><span class="n">log</span><span class="p">(</span><span class="m">10</span><span class="p">),</span><span class="n">log</span><span class="p">(</span><span class="m">100</span><span class="p">),</span><span class="n">log</span><span class="p">(</span><span class="m">1000</span><span class="p">),</span><span class="n">log</span><span class="p">(</span><span class="m">10000</span><span class="p">),</span><span class="n">log</span><span class="p">(</span><span class="m">1e5</span><span class="p">)),</span>
                      <span class="n">labels</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="s2">"1"</span><span class="p">,</span><span class="s2">"10"</span><span class="p">,</span><span class="s2">"100"</span><span class="p">,</span><span class="s2">"1,000"</span><span class="p">,</span><span class="s2">"10,000"</span><span class="p">,</span><span class="s2">"100,000"</span><span class="p">))</span><span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">plot.caption</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">hjust</span><span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="n">vjust</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="m">10</span><span class="p">)))</span><span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">axis.title.y</span><span class="o">=</span><span class="n">element_blank</span><span class="p">(),</span>
        <span class="n">axis.text.y</span><span class="o">=</span><span class="n">element_blank</span><span class="p">(),</span>
        <span class="n">axis.ticks.y</span><span class="o">=</span><span class="n">element_blank</span><span class="p">())</span>
<span class="n">m</span><span class="o">&lt;-</span><span class="n">multiplot</span><span class="p">(</span><span class="n">map1</span><span class="p">,</span><span class="n">graph1</span><span class="p">,</span><span class="n">layout</span><span class="o">=</span><span class="n">matrix</span><span class="p">(</span><span class="n">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">,</span><span class="m">2</span><span class="p">),</span> <span class="n">nrow</span><span class="o">=</span><span class="m">2</span><span class="p">,</span> <span class="n">byrow</span><span class="o">=</span><span class="n">TRUE</span><span class="p">))</span>
<span class="c1">#return(m)  
</span><span class="p">}</span>

<span class="c1">#This function will plot each state individually (my.alpha&gt;0)
#we need the alpha because when we use tween for the animation we'll want to fade in and out
</span><span class="n">myf</span> <span class="o">&lt;-</span> <span class="k">function</span><span class="p">(</span><span class="n">yy</span><span class="p">,</span><span class="n">my.a</span><span class="o">=</span><span class="m">0.5</span><span class="p">){</span>
  <span class="n">my.out</span><span class="o">&lt;-</span><span class="n">densityDF</span><span class="p">[</span><span class="n">year</span><span class="o">==</span><span class="n">yy</span><span class="p">,]</span>
  <span class="n">my.out</span><span class="o">$</span><span class="n">my.alpha</span><span class="o">&lt;-</span><span class="n">my.a</span>
  <span class="n">my.out</span> <span class="o">%&gt;%</span> <span class="n">map_if</span><span class="p">(</span><span class="n">is.character</span><span class="p">,</span> <span class="n">as.factor</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="n">as.data.frame</span><span class="p">()</span> <span class="o">-&gt;</span><span class="n">my.out</span> 
  <span class="k">return</span><span class="p">(</span><span class="n">data.frame</span><span class="p">(</span><span class="n">my.out</span><span class="p">))</span>   <span class="p">}</span>

<span class="n">myplotf</span><span class="p">(</span><span class="n">myf</span><span class="p">(</span><span class="s2">"2010"</span><span class="p">))</span></code></pre></figure>

<p><img src="/img/Rfig/fig-density-plot-1-1.svg" alt="plot of chunk fig-density-plot-1" /></p>

<h2 id="discussion">Discussion</h2>

<p>This is a complex plot, even without the animation.  The map shows population density for each county in the U.S. in 2010. The darker the color (or purpler), the higher the density. You can pretty easily make out major population centers (New York, Los Angeles, Chicago) on the map.</p>

<p>The plot below shows a density curve of county level population density. The gray line is for the entire United States.  Each overlaid hump is a density fie for each state. It might be easier if we break it down with facets for each state:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">indata</span><span class="o">&lt;-</span><span class="n">myf</span><span class="p">(</span><span class="s2">"2010"</span><span class="p">)</span>  <span class="c1">#use our function to make a plot
</span><span class="n">indata</span><span class="o">&lt;-</span><span class="n">data.table</span><span class="p">(</span><span class="n">indata</span><span class="p">)[</span><span class="n">STATE</span> <span class="o">!=</span> <span class="s2">"District Of Columbia"</span><span class="p">]</span> <span class="c1">#exclude DC so we have 50 states
</span><span class="n">indata</span><span class="p">[,</span><span class="n">med.dens</span><span class="o">:=</span><span class="n">median</span><span class="p">(</span><span class="n">density</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="n">STATE</span><span class="p">]</span>  <span class="c1">#mean density across counties (unweighted)
</span><span class="n">indata</span><span class="p">[,</span><span class="n">us.med</span><span class="o">:=</span><span class="n">median</span><span class="p">(</span><span class="n">density</span><span class="p">)]</span>           <span class="c1">#median density for the U.S.
</span>
<span class="n">ggplot</span><span class="p">(</span><span class="n">indata</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">log</span><span class="p">(</span><span class="n">density</span><span class="p">)))</span> <span class="o">+</span> 
  <span class="c1">#the fill will depend on a value we'll feed to the data my.alpha, defined below
</span>  <span class="n">geom_density</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="m">.9</span><span class="p">,</span><span class="n">aes</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="n">STATE</span><span class="p">,</span><span class="n">fill</span><span class="o">=</span><span class="n">log</span><span class="p">(</span><span class="n">med.dens</span><span class="p">)),</span><span class="n">color</span><span class="o">=</span><span class="n">NA</span><span class="p">)</span><span class="o">+</span>
 <span class="c1"># geom_density(size=.75,aes(fill=log(us.med)),alpha=1,color="darkgray")+
</span>  <span class="n">theme_minimal</span><span class="p">()</span><span class="o">+</span>
  <span class="n">scale_fill_viridis</span><span class="p">(</span><span class="n">discrete</span><span class="o">=</span><span class="n">F</span><span class="p">,</span><span class="n">option</span><span class="o">=</span><span class="s2">"D"</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="m">0.95</span><span class="p">,</span><span class="n">direction</span><span class="o">=</span><span class="m">-1</span><span class="p">,</span><span class="n">limits</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="m">.079</span><span class="p">),</span><span class="n">log</span><span class="p">(</span><span class="m">1.2e5</span><span class="p">)),</span><span class="n">name</span><span class="o">=</span><span class="s2">"Median County Density"</span><span class="p">)</span><span class="o">+</span>
   <span class="n">scale_color_viridis</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s2">"Population Density"</span><span class="p">,</span> <span class="n">discrete</span><span class="o">=</span><span class="n">T</span><span class="p">,</span><span class="n">option</span><span class="o">=</span><span class="s2">"D"</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="m">0.95</span><span class="p">)</span><span class="o">+</span>
    <span class="n">theme</span><span class="p">(</span><span class="n">legend.justification</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">0</span><span class="p">),</span> <span class="n">legend.position</span><span class="o">=</span><span class="s2">"none"</span><span class="p">)</span><span class="o">+</span>
  <span class="n">facet_wrap</span><span class="p">(</span><span class="o">~</span><span class="n">year</span><span class="p">)</span><span class="o">+</span>
  <span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"Population density (log scale)"</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="s2">"Kernel density curve fit to county population density"</span><span class="p">,</span><span class="n">subtitle</span><span class="o">=</span><span class="s2">"distribution over population density for each county in the U.S. (2010)"</span><span class="p">,</span><span class="n">caption</span><span class="o">=</span><span class="n">paste0</span><span class="p">(</span><span class="s2">"Each colored area shows distribution across counties for an individual state\n"</span><span class="p">,</span><span class="n">mycaption</span><span class="p">))</span><span class="o">+</span>
  <span class="n">scale_x_continuous</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="m">.079</span><span class="p">),</span><span class="n">log</span><span class="p">(</span><span class="m">1.2e5</span><span class="p">)),</span>
                      <span class="n">breaks</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="m">1</span><span class="p">),</span><span class="n">log</span><span class="p">(</span><span class="m">1e5</span><span class="p">)),</span>
                      <span class="n">labels</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="s2">"1"</span><span class="p">,</span><span class="s2">"100,000"</span><span class="p">))</span><span class="o">+</span>
      <span class="n">theme</span><span class="p">(</span><span class="n">axis.text.x</span> <span class="o">=</span> <span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">6</span><span class="p">))</span><span class="o">+</span>  <span class="c1">#shrink axis text size
</span>  <span class="n">theme</span><span class="p">(</span><span class="n">strip.text.x</span> <span class="o">=</span> <span class="n">element_text</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="m">7</span><span class="p">))</span><span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">plot.caption</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">hjust</span><span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="n">vjust</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="m">10</span><span class="p">)))</span><span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">axis.title.y</span><span class="o">=</span><span class="n">element_blank</span><span class="p">(),</span>
        <span class="n">axis.text.y</span><span class="o">=</span><span class="n">element_blank</span><span class="p">(),</span>
        <span class="n">axis.ticks.y</span><span class="o">=</span><span class="n">element_blank</span><span class="p">())</span><span class="o">+</span><span class="n">facet_wrap</span><span class="p">(</span><span class="o">~</span><span class="n">STATE</span><span class="p">,</span><span class="n">ncol</span><span class="o">=</span><span class="m">10</span><span class="p">,</span><span class="n">scales</span><span class="o">=</span><span class="s2">"free_y"</span><span class="p">)</span></code></pre></figure>

<p><img src="/img/Rfig/fig-density-plot-2-1.svg" alt="plot of chunk fig-density-plot-2" /></p>

<p>This plot lets you compare the distribution of county population density by state in 2010. Some states, like New Jersey, are very urban and have concentrated density at the high end of the scale (purpler). Other states, like Alaska have low levels of population density.</p>

<h2 id="animation">Animation</h2>

<p>We can now animate this using tweenr to get the plot above (code below).  <em>See my earlier <a href="/2016/05/29/improving-R-animated-gifs-with-tweenr">post about tweenr</a> for an introduction to tweenr, and more examples <a href="/2016/05/30/more-tweenr-animations">here</a> and <a href="/2016/06/26/week-in-review">here</a>.</em></p>

<p><em>For more on mapping, see my earlier posts: <a href="/2016/08/21/maps-mortgages-and-me">Maps Mortgages and Me</a>, <a href="/2016/08/23/US-pop-map-1790-2010">U.S. county population: 1790-2010</a> and <a href="/2016/08/24/more-maps">More map visualizations</a>.</em></p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">y.list</span><span class="o">&lt;-</span><span class="n">unique</span><span class="p">(</span><span class="n">densityDF</span><span class="o">$</span><span class="n">year</span><span class="p">)</span>  <span class="c1">#get list of years
</span>
<span class="n">tf</span> <span class="o">&lt;-</span> <span class="n">tween_states</span><span class="p">(</span><span class="n">list</span><span class="p">(</span>
                        <span class="n">myf</span><span class="p">(</span><span class="s2">"1830"</span><span class="p">,</span><span class="m">0</span><span class="p">),</span><span class="n">myf</span><span class="p">(</span><span class="s2">"1830"</span><span class="p">,</span><span class="m">0.5</span><span class="p">),</span>
                        <span class="n">myf</span><span class="p">(</span><span class="s2">"1860"</span><span class="p">,</span><span class="m">0</span><span class="p">),</span><span class="n">myf</span><span class="p">(</span><span class="s2">"1860"</span><span class="p">,</span><span class="m">0.5</span><span class="p">),</span>
                        <span class="n">myf</span><span class="p">(</span><span class="s2">"1890"</span><span class="p">,</span><span class="m">0</span><span class="p">),</span><span class="n">myf</span><span class="p">(</span><span class="s2">"1890"</span><span class="p">,</span><span class="m">0.5</span><span class="p">),</span>
                        <span class="n">myf</span><span class="p">(</span><span class="s2">"1920"</span><span class="p">,</span><span class="m">0</span><span class="p">),</span><span class="n">myf</span><span class="p">(</span><span class="s2">"1920"</span><span class="p">,</span><span class="m">0.5</span><span class="p">),</span>
                        <span class="n">myf</span><span class="p">(</span><span class="s2">"1950"</span><span class="p">,</span><span class="m">0</span><span class="p">),</span><span class="n">myf</span><span class="p">(</span><span class="s2">"1950"</span><span class="p">,</span><span class="m">0.5</span><span class="p">),</span>
                        <span class="n">myf</span><span class="p">(</span><span class="s2">"1980"</span><span class="p">,</span><span class="m">0</span><span class="p">),</span><span class="n">myf</span><span class="p">(</span><span class="s2">"1980"</span><span class="p">,</span><span class="m">0.5</span><span class="p">),</span>
                        <span class="n">myf</span><span class="p">(</span><span class="s2">"2010"</span><span class="p">,</span><span class="m">0</span><span class="p">),</span><span class="n">myf</span><span class="p">(</span><span class="s2">"2010"</span><span class="p">,</span><span class="m">0.5</span><span class="p">),</span>
                        <span class="n">myf</span><span class="p">(</span><span class="s2">"1830"</span><span class="p">)),</span>  <span class="c1">#close the animation loop
</span>                   <span class="n">tweenlength</span><span class="o">=</span> <span class="m">2</span><span class="p">,</span> <span class="n">statelength</span><span class="o">=</span><span class="m">1</span><span class="p">,</span> <span class="n">ease</span><span class="o">=</span><span class="n">rep</span><span class="p">(</span><span class="s1">'cubic-in-out'</span><span class="p">,</span><span class="m">2</span><span class="p">),</span><span class="n">nframes</span><span class="o">=</span><span class="m">170</span><span class="p">)</span>
<span class="n">tf</span><span class="o">&lt;-</span><span class="n">data.table</span><span class="p">(</span><span class="n">tf</span><span class="p">)</span>
<span class="n">N</span><span class="o">&lt;-</span><span class="n">max</span><span class="p">(</span><span class="n">tf</span><span class="o">$</span><span class="n">.frame</span><span class="p">)</span>
<span class="c1">#N&lt;-5
</span>
<span class="n">oopt</span> <span class="o">=</span> <span class="n">ani.options</span><span class="p">(</span><span class="n">interval</span> <span class="o">=</span> <span class="m">0.15</span><span class="p">)</span>
<span class="n">saveGIF</span><span class="p">({</span><span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="k">in</span> <span class="m">1</span><span class="o">:</span><span class="n">N</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">g</span><span class="o">&lt;-</span><span class="n">myplotf</span><span class="p">(</span><span class="n">tf</span><span class="p">[</span><span class="n">.frame</span><span class="o">==</span><span class="n">i</span><span class="p">])</span>
  <span class="n">print</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
  <span class="n">ani.pause</span><span class="p">()</span>
  <span class="n">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="p">}</span>  <span class="p">},</span><span class="n">movie.name</span><span class="o">=</span><span class="s2">"pop density gif.gif"</span><span class="p">,</span><span class="n">ani.width</span> <span class="o">=</span> <span class="m">700</span><span class="p">,</span> <span class="n">ani.height</span> <span class="o">=</span> <span class="m">600</span><span class="p">)</span></code></pre></figure>


    </div>

    

    
  
    <hr>
    <ul class="pagination">
    
      <li class="prev"><a href="/2016/08/24/more-maps" title="More map visualizations">&laquo; Previous</a></li>
    
      <li><a href="/archive.html">Archive</a></li>
    
      <li class="next"><a href="/2016/08/27/housing-market-update" title="Recent economic and housing market trends: August 2016">Next &raquo;</a></li>
    
    </ul>
    <hr>
    
  </div>
</div>



      </div>

    </div>

    <div id="footer">
      <div class="container">
        <p>&copy; 2017 Len Kiefer
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>
       
    • <span vertical-align:bottom> <a href="https://twitter.com/lenkiefer" class="twitter-follow-button" data-show-count="false">•   Follow @lenkiefer</a>
  
 <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
</span>
• <script src="//platform.linkedin.com/in.js" type="text/javascript"></script>
<script type="IN/MemberProfile" data-id="https://www.linkedin.com/pub/leonard-kiefer/31/753/511" data-format="click" data-related="false" data-text="Leonard Kiefer"></script>
  • lenkiefer@hotmail.com
           </p>
      </div>
    </div>
    





<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-66905937-1', 'auto');
  ga('send', 'pageview');

</script>

    <!-- Latest compiled and minified JavaScript, requires jQuery 1.x (2.x not supported in IE8) -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="/assets/themes/lentheme/bootstrap/js/bootstrap.min.js"></script>
  </body>
</html>





