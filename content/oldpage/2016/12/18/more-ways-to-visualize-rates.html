
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Even more mortgage rate visualizations</title>
    
    <meta name="author" content="Len Kiefer">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Bootstrap styles -->
    <link href="/assets/themes/lentheme/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <!-- Optional theme -->
    <link href="/assets/themes/lentheme/bootstrap/css/bootstrap-theme.min.css" rel="stylesheet">
    <!-- Sticky Footer -->
    <link href="/assets/themes/lentheme/bootstrap/css/bs-sticky-footer.css" rel="stylesheet">
    
    <!-- Custom styles -->
    <link href="/assets/themes/lentheme/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!-- Update these with your own images
      <link rel="shortcut icon" href="images/favicon.ico">
      <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
      <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
      <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
    -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

  </head>

  <body>
    <div id="wrap">
      <nav class="navbar navbar-default" role="navigation">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#jb-navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/"><span class="icon-home3" style="font-size:24px"> Len Kiefer</a></span>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="jb-navbar-collapse" style="font-size:24px">
          <ul class="nav navbar-nav" >
        <li><a href="/archive.html"><span class="icon-newspaper"> Posts</a></span></li>
            <!-- li><a href="/chartbook/index.html"><span class="icon-display"> Chartbook</a></span></li-->
         <li><a href="/resume.html"><span class="icon-profile"> Resume</span></a></li>
        <li><a href="/about.html"><span class="icon-user-tie"> About</span></a></li>
          </ul>
        </div><!-- /.navbar-collapse -->
      </nav>

      <div class="container">
        
<div class="page-header">
  <h1>Even more mortgage rate visualizations </h1>
</div>

<div class="row post-full">
  <div class="col-xs-12">
    <div class="date">
      <span>18 December 2016</span>
    </div>
    <div class="content">
      <h1 id="introduction">Introduction</h1>

<p>WE ARE BACK WITH EVEN MORE WAYS TO VISUALIZE mortgage rates. A few days ago, I <a href="/2016/12/08/10-ways-to-visualize-rates">shared</a> some ways to visualize mortgage rate trends and <a href="/2016/12/15/more-amazing-mortgage-viz">here</a> I posted some additional gifs without the code.  I’m going to expand on that last post with <a href="https://www.r-project.org/">R</a> code for one those charts, and give you a totally new one.</p>

<h2 id="the-data">The data</h2>

<p>The data I’m going to use are estimates of weekly U.S. average 30-year fixed mortgage rates from the <a href="http://www.freddiemac.com/pmms/index.html">Primary Mortgage Market Survey</a> from Freddie Mac. These data can be easily downloaded from the St. Louis Fred database <a href="http://bit.ly/2hli7Sh">here</a>.</p>

<p>I have the data saved in a simple text file with a column for data, the mortgage rate, and helper columns week, month, and year, where week is the week number starting with the first week of the year.</p>

<p>Let’s load the data and take a peek.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1">#load libraries
</span><span class="n">library</span><span class="p">(</span><span class="n">data.table</span><span class="p">,</span> <span class="n">warn.conflicts</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">quietly</span><span class="o">=</span><span class="n">TRUE</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">,</span> <span class="n">warn.conflicts</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">quietly</span><span class="o">=</span><span class="n">TRUE</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">,</span> <span class="n">warn.conflicts</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">quietly</span><span class="o">=</span><span class="n">TRUE</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">zoo</span><span class="p">,</span> <span class="n">warn.conflicts</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">quietly</span><span class="o">=</span><span class="n">TRUE</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">ggrepel</span><span class="p">,</span> <span class="n">warn.conflicts</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">quietly</span><span class="o">=</span><span class="n">TRUE</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">ggthemes</span><span class="p">,</span> <span class="n">warn.conflicts</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">quietly</span><span class="o">=</span><span class="n">TRUE</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">scales</span><span class="p">,</span> <span class="n">warn.conflicts</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">quietly</span><span class="o">=</span><span class="n">TRUE</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">tidyr</span><span class="p">,</span> <span class="n">warn.conflicts</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">quietly</span><span class="o">=</span><span class="n">TRUE</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">zoo</span><span class="p">,</span><span class="n">warn.conflicts</span><span class="o">=</span><span class="n">F</span><span class="p">,</span><span class="n">quietly</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">purrr</span><span class="p">,</span><span class="n">warn.conflicts</span><span class="o">=</span><span class="n">F</span><span class="p">,</span><span class="n">quietly</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">xts</span><span class="p">,</span><span class="n">warn.conflicts</span><span class="o">=</span><span class="n">F</span><span class="p">,</span><span class="n">quietly</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">lubridate</span><span class="p">,</span><span class="n">warn.conflicts</span><span class="o">=</span><span class="n">F</span><span class="p">,</span><span class="n">quietly</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">viridis</span><span class="p">,</span><span class="n">warn.conflicts</span> <span class="o">=</span> <span class="n">F</span><span class="p">,</span><span class="n">quietly</span> <span class="o">=</span> <span class="n">F</span><span class="p">)</span> <span class="c1">#for the colorz
</span><span class="n">library</span><span class="p">(</span><span class="s2">"htmlTable"</span><span class="p">)</span>
<span class="c1">#load data from text file
</span><span class="n">pmms30yr</span> <span class="o">&lt;-</span> <span class="n">fread</span><span class="p">(</span><span class="s2">"data/pmms30yr.txt"</span><span class="p">)</span>
<span class="c1">#set up date variable
</span><span class="n">pmms30yr</span><span class="o">$</span><span class="n">date</span><span class="o">&lt;-</span><span class="n">as.Date</span><span class="p">(</span><span class="n">pmms30yr</span><span class="o">$</span><span class="n">date</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s2">"%m/%d/%Y"</span><span class="p">)</span>

<span class="c1"># make tables for viewing formatting dates with purr %&gt;% operations
</span><span class="n">htmlTable</span><span class="p">(</span><span class="n">tail</span><span class="p">(</span><span class="n">pmms30yr</span> <span class="o">%&gt;%</span> <span class="n">map_if</span><span class="p">(</span><span class="n">is.Date</span><span class="p">,</span> <span class="n">as.character</span><span class="p">,</span><span class="n">format</span><span class="o">=</span><span class="s2">"%b %d,%Y"</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="n">map_if</span><span class="p">(</span><span class="n">is.numeric</span><span class="p">,</span> <span class="n">round</span><span class="p">,</span><span class="m">3</span><span class="p">)</span> <span class="o">%&gt;%</span><span class="n">as.data.frame</span><span class="p">()</span> <span class="p">,</span><span class="m">10</span><span class="p">),</span> <span class="n">col.rgroup</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="s2">"none"</span><span class="p">,</span> <span class="s2">"#F7F7F7"</span><span class="p">),</span><span class="n">caption</span><span class="o">=</span><span class="s2">"30-year Fixed Mortgage Rate (%)"</span><span class="p">,</span>
          <span class="n">tfoot</span><span class="o">=</span><span class="s2">"Source: Freddie Mac Primary Mortgage Market Survey"</span><span class="p">)</span></code></pre></figure>

<table class="gmisc_table" style="border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;">
<thead>
<tr><td colspan="6" style="text-align: left;">
30-year Fixed Mortgage Rate (%)</td></tr>
<tr>
<th style="border-bottom: 1px solid grey; border-top: 2px solid grey;"> </th>
<th style="border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;">date</th>
<th style="border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;">rate</th>
<th style="border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;">year</th>
<th style="border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;">month</th>
<th style="border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;">week</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">2377</td>
<td style="text-align: center;">Oct 13,2016</td>
<td style="text-align: center;">3.47</td>
<td style="text-align: center;">2016</td>
<td style="text-align: center;">10</td>
<td style="text-align: center;">41</td>
</tr>
<tr style="background-color: #f7f7f7;">
<td style="background-color: #f7f7f7; text-align: left;">2378</td>
<td style="background-color: #f7f7f7; text-align: center;">Oct 20,2016</td>
<td style="background-color: #f7f7f7; text-align: center;">3.52</td>
<td style="background-color: #f7f7f7; text-align: center;">2016</td>
<td style="background-color: #f7f7f7; text-align: center;">10</td>
<td style="background-color: #f7f7f7; text-align: center;">42</td>
</tr>
<tr>
<td style="text-align: left;">2379</td>
<td style="text-align: center;">Oct 27,2016</td>
<td style="text-align: center;">3.47</td>
<td style="text-align: center;">2016</td>
<td style="text-align: center;">10</td>
<td style="text-align: center;">43</td>
</tr>
<tr style="background-color: #f7f7f7;">
<td style="background-color: #f7f7f7; text-align: left;">2380</td>
<td style="background-color: #f7f7f7; text-align: center;">Nov 03,2016</td>
<td style="background-color: #f7f7f7; text-align: center;">3.54</td>
<td style="background-color: #f7f7f7; text-align: center;">2016</td>
<td style="background-color: #f7f7f7; text-align: center;">11</td>
<td style="background-color: #f7f7f7; text-align: center;">44</td>
</tr>
<tr>
<td style="text-align: left;">2381</td>
<td style="text-align: center;">Nov 10,2016</td>
<td style="text-align: center;">3.57</td>
<td style="text-align: center;">2016</td>
<td style="text-align: center;">11</td>
<td style="text-align: center;">45</td>
</tr>
<tr style="background-color: #f7f7f7;">
<td style="background-color: #f7f7f7; text-align: left;">2382</td>
<td style="background-color: #f7f7f7; text-align: center;">Nov 17,2016</td>
<td style="background-color: #f7f7f7; text-align: center;">3.94</td>
<td style="background-color: #f7f7f7; text-align: center;">2016</td>
<td style="background-color: #f7f7f7; text-align: center;">11</td>
<td style="background-color: #f7f7f7; text-align: center;">46</td>
</tr>
<tr>
<td style="text-align: left;">2383</td>
<td style="text-align: center;">Nov 23,2016</td>
<td style="text-align: center;">4.03</td>
<td style="text-align: center;">2016</td>
<td style="text-align: center;">11</td>
<td style="text-align: center;">47</td>
</tr>
<tr style="background-color: #f7f7f7;">
<td style="background-color: #f7f7f7; text-align: left;">2384</td>
<td style="background-color: #f7f7f7; text-align: center;">Dec 01,2016</td>
<td style="background-color: #f7f7f7; text-align: center;">4.08</td>
<td style="background-color: #f7f7f7; text-align: center;">2016</td>
<td style="background-color: #f7f7f7; text-align: center;">12</td>
<td style="background-color: #f7f7f7; text-align: center;">48</td>
</tr>
<tr>
<td style="text-align: left;">2385</td>
<td style="text-align: center;">Dec 08,2016</td>
<td style="text-align: center;">4.13</td>
<td style="text-align: center;">2016</td>
<td style="text-align: center;">12</td>
<td style="text-align: center;">49</td>
</tr>
<tr style="background-color: #f7f7f7;">
<td style="background-color: #f7f7f7; border-bottom: 2px solid grey; text-align: left;">2386</td>
<td style="background-color: #f7f7f7; border-bottom: 2px solid grey; text-align: center;">Dec 15,2016</td>
<td style="background-color: #f7f7f7; border-bottom: 2px solid grey; text-align: center;">4.16</td>
<td style="background-color: #f7f7f7; border-bottom: 2px solid grey; text-align: center;">2016</td>
<td style="background-color: #f7f7f7; border-bottom: 2px solid grey; text-align: center;">12</td>
<td style="background-color: #f7f7f7; border-bottom: 2px solid grey; text-align: center;">50</td>
</tr>
</tbody>
<tfoot><tr><td colspan="6">
Source: Freddie Mac Primary Mortgage Market Survey</td></tr></tfoot>
</table>

<p>The data are weekly observations on mortgage rates running from April 2, 1971 through December 15, 2016 (we added one week since last time).</p>

<h1 id="distribution-bars">Distribution bars</h1>

<p>Let’s start by creating this chart:</p>

<p><img src="/img/charts_dec_15_2016/pmms share bars dec 2016.gif" alt="pmms bars" /></p>

<p>This chart shows how the distribution of weekly mortgage rates has changed since the year 2000.  Even though rates have been heading higher recently, they are still quite low, even judging by the standards of this century.</p>

<p>To make this chart we need to first take our data and bin the data into buckets. We can easily do this using the <a href="https://www.r-bloggers.com/r-function-of-the-day-cut-2/">cut</a> function to “cut” up the data weekly interest rates into non-overlapping intervals.  Then we can use the data.table() structure to easily compute summary statistics by cuts.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># cut data into 50 basis points(bp), or 1/2 percentage point buckets
# in originatl I cut into 25 bp buckets but that's hard to fit, so I coarsened the cut
</span><span class="n">pmms30yr</span><span class="p">[,</span><span class="n">rc</span><span class="o">:=</span><span class="n">cut</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span><span class="n">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">10</span><span class="p">,</span><span class="m">.5</span><span class="p">))]</span>
<span class="c1"># count up total observations
</span><span class="n">pmms30yr</span><span class="p">[,</span><span class="n">numN</span><span class="o">:=</span><span class="n">.N</span><span class="p">]</span>
<span class="c1"># count up total observations by year
</span><span class="n">pmms30yr</span><span class="p">[,</span><span class="n">numY</span><span class="o">:=</span><span class="n">.N</span><span class="p">,</span><span class="n">by</span><span class="o">=</span><span class="n">year</span><span class="p">]</span>
<span class="c1"># comput summary table by year and cut
</span><span class="n">dt</span><span class="o">&lt;-</span><span class="n">pmms30yr</span><span class="p">[,</span><span class="n">list</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="n">.N</span><span class="p">,</span>  <span class="c1"># of obs in year/cut 
</span>                   <span class="n">numy</span><span class="o">=</span><span class="n">mean</span><span class="p">(</span><span class="n">numY</span><span class="p">)</span> <span class="c1"># of obs per year
</span>                   <span class="p">),</span>
             <span class="n">by</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="s2">"year"</span><span class="p">,</span><span class="s2">"rc"</span><span class="p">)]</span>

<span class="c1"># comput share as % of weeks within range
</span><span class="n">dt</span><span class="p">[,</span><span class="n">share</span><span class="o">:=</span><span class="n">num</span><span class="o">/</span><span class="n">numy</span><span class="p">]</span>

<span class="n">N</span><span class="o">&lt;-</span><span class="n">nrow</span><span class="p">(</span><span class="n">pmms30yr</span><span class="p">)</span> <span class="c1">#total number of obs
</span>
<span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dt</span><span class="p">[</span><span class="n">year</span><span class="o">==</span><span class="m">2016</span><span class="p">,],</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">rc</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">share</span><span class="p">,</span><span class="n">fill</span><span class="o">=</span><span class="n">factor</span><span class="p">(</span><span class="n">year</span><span class="p">),</span><span class="n">label</span><span class="o">=</span><span class="n">max</span><span class="p">(</span><span class="n">year</span><span class="p">),</span><span class="n">color</span><span class="o">=</span><span class="n">factor</span><span class="p">(</span><span class="n">year</span><span class="p">)))</span><span class="o">+</span>
  <span class="n">geom_bar</span><span class="p">(</span><span class="n">stat</span><span class="o">=</span><span class="s2">"identity"</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">dt</span><span class="p">[</span><span class="n">year</span><span class="o">&gt;</span><span class="m">1999</span><span class="p">,</span><span class="n">list</span><span class="p">(</span><span class="n">share</span><span class="o">=</span><span class="n">sum</span><span class="p">(</span><span class="n">num</span><span class="p">)</span><span class="o">/</span><span class="n">N</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="n">list</span><span class="p">(</span><span class="n">year</span><span class="p">,</span><span class="n">rc</span><span class="p">)],</span> <span class="n">alpha</span><span class="o">=</span><span class="m">0.5</span><span class="p">,</span><span class="n">fill</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">NA</span><span class="p">)</span>  <span class="o">+</span>
  <span class="n">theme_minimal</span><span class="p">()</span><span class="o">+</span>
  <span class="n">scale_fill_viridis</span><span class="p">(</span><span class="n">discrete</span><span class="o">=</span><span class="s2">"T"</span><span class="p">)</span><span class="o">+</span>
  <span class="n">scale_color_viridis</span><span class="p">(</span><span class="n">discrete</span><span class="o">=</span><span class="s2">"T"</span><span class="p">)</span><span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">legend.position</span><span class="o">=</span><span class="s2">"none"</span><span class="p">)</span><span class="o">+</span>
  <span class="c1"># need to have full data with colors in plot, but set alpha=0 so invisible
</span>  <span class="c1"># could also manuall assign colors, but this works
</span>  <span class="n">geom_text</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="m">4</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="m">0.6</span><span class="p">,</span><span class="n">family</span><span class="o">=</span><span class="s2">"Georgia"</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="m">20</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="n">hjust</span><span class="o">=</span><span class="m">0</span><span class="p">)</span><span class="o">+</span>  
  
  <span class="c1"># add a big fat label to the top of the chart
</span>  <span class="n">geom_text</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="m">4</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="m">0.6</span><span class="p">,</span><span class="n">family</span><span class="o">=</span><span class="s2">"Arial Black"</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="m">20</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="m">0.75</span><span class="p">,</span><span class="n">hjust</span><span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="n">vjust</span><span class="o">=</span><span class="m">0</span><span class="p">)</span><span class="o">+</span>
  <span class="n">geom_bar</span><span class="p">(</span><span class="n">stat</span><span class="o">=</span><span class="s2">"identity"</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">NA</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="m">0.6</span><span class="p">)</span><span class="o">+</span>
  <span class="n">scale_y_continuous</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">percent</span><span class="p">,</span><span class="n">limits</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">.75</span><span class="p">))</span><span class="o">+</span>
  <span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"30-year fixed mortgage rate (in 0.25pp increments)"</span><span class="p">,</span>
       <span class="n">y</span><span class="o">=</span><span class="s2">"percent of weeks in range"</span><span class="p">,</span>
       <span class="n">title</span><span class="o">=</span><span class="s2">"Distribution of 30-year fixed mortgage rates since 2000"</span><span class="p">,</span>
       <span class="n">subtitle</span><span class="o">=</span><span class="n">paste0</span><span class="p">(</span><span class="s2">"Gray bars all years 2000-2016, colored bar only 2016"</span><span class="p">))</span><span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span> <span class="n">family</span><span class="o">=</span><span class="s2">"Georgia"</span><span class="p">),</span>
        <span class="n">plot.caption</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">hjust</span><span class="o">=</span><span class="m">0</span> <span class="p">),</span>
        <span class="n">plot.subtitle</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">face</span><span class="o">=</span><span class="s2">"italic"</span><span class="p">),</span>
        <span class="n">axis.text.x</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">7</span><span class="p">))</span></code></pre></figure>

<p><img src="/img/Rfig/rate-viz1-dec-18-2016,-1.svg" alt="plot of chunk rate-viz1-dec-18-2016," /></p>

<h2 id="add-smooth-transitions">Add smooth transitions</h2>

<p>To add smooth transitions we use Tweenr.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># function to drop observations for all years by y
</span><span class="n">myf</span><span class="o">&lt;-</span><span class="k">function</span><span class="p">(</span><span class="n">y</span><span class="p">){</span>
  <span class="n">dt2</span><span class="o">&lt;-</span><span class="n">copy</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
  <span class="n">dt2</span><span class="o">&lt;-</span><span class="n">dt2</span><span class="p">[</span><span class="n">year</span> <span class="o">!=</span><span class="n">y</span> <span class="p">,</span><span class="n">num</span><span class="o">:=</span><span class="m">0</span><span class="p">]</span>
  <span class="n">dt2</span><span class="o">&lt;-</span><span class="n">dt2</span><span class="p">[</span><span class="n">year</span> <span class="o">!=</span><span class="n">y</span> <span class="p">,</span><span class="n">share</span><span class="o">:=</span><span class="m">0</span><span class="p">]</span>
  <span class="n">dt2</span><span class="o">$</span><span class="n">year</span><span class="o">&lt;-</span><span class="n">factor</span><span class="p">(</span><span class="n">dt2</span><span class="o">$</span><span class="n">year</span><span class="p">)</span>
  <span class="n">dt2</span><span class="o">$</span><span class="n">num</span><span class="o">&lt;-</span><span class="n">round</span><span class="p">(</span><span class="n">dt2</span><span class="o">$</span><span class="n">num</span><span class="p">,</span><span class="m">1</span><span class="p">)</span>
  <span class="k">return</span><span class="p">(</span><span class="n">as.data.frame</span><span class="p">(</span><span class="n">dt2</span><span class="p">))</span>
<span class="p">}</span>

<span class="n">library</span><span class="p">(</span><span class="n">animation</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">tweenr</span><span class="p">)</span>
<span class="c1">#use tweenr
</span><span class="n">my.list2</span><span class="o">&lt;-</span><span class="n">lapply</span><span class="p">(</span><span class="n">c</span><span class="p">(</span><span class="m">2016</span><span class="p">,</span><span class="n">seq</span><span class="p">(</span><span class="m">2000</span><span class="p">,</span><span class="m">2016</span><span class="p">,</span><span class="m">1</span><span class="p">)),</span><span class="n">myf</span><span class="p">)</span>

<span class="c1">#my.list2&lt;-lapply(c(2016,2008,2016),myf)
</span><span class="n">tf</span> <span class="o">&lt;-</span> <span class="n">tween_states</span><span class="p">(</span><span class="n">my.list2</span><span class="p">,</span> <span class="n">tweenlength</span><span class="o">=</span> <span class="m">2</span><span class="p">,</span> <span class="n">statelength</span><span class="o">=</span><span class="m">3</span><span class="p">,</span> <span class="n">ease</span><span class="o">=</span><span class="n">rep</span><span class="p">(</span><span class="s1">'cubic-in-out'</span><span class="p">,</span><span class="m">200</span><span class="p">),</span> <span class="n">nframes</span><span class="o">=</span><span class="m">240</span><span class="p">)</span>
<span class="n">tf</span><span class="o">&lt;-</span><span class="n">data.table</span><span class="p">(</span><span class="n">tf</span><span class="p">)</span>

<span class="c1">#create animation:
</span><span class="n">oopt</span> <span class="o">=</span> <span class="n">ani.options</span><span class="p">(</span><span class="n">interval</span> <span class="o">=</span> <span class="m">0.1</span><span class="p">)</span>
  <span class="n">saveGIF</span><span class="p">({</span><span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="k">in</span> <span class="m">1</span><span class="o">:</span><span class="n">max</span><span class="p">(</span><span class="n">tf</span><span class="o">$</span><span class="n">.frame</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">g</span><span class="o">&lt;-</span>
      <span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">tf</span><span class="p">[</span><span class="n">.frame</span><span class="o">==</span><span class="n">i</span><span class="p">,],</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">rc</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">share</span><span class="p">,</span><span class="n">fill</span><span class="o">=</span><span class="n">factor</span><span class="p">(</span><span class="n">year</span><span class="p">),</span><span class="n">color</span><span class="o">=</span><span class="n">factor</span><span class="p">(</span><span class="n">year</span><span class="p">),</span><span class="n">label</span><span class="o">=</span><span class="n">year</span><span class="p">))</span><span class="o">+</span>
      <span class="n">geom_bar</span><span class="p">(</span><span class="n">stat</span><span class="o">=</span><span class="s2">"identity"</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">dt</span><span class="p">[,</span><span class="n">list</span><span class="p">(</span><span class="n">share</span><span class="o">=</span><span class="n">sum</span><span class="p">(</span><span class="n">num</span><span class="p">)</span><span class="o">/</span><span class="n">N</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="n">list</span><span class="p">(</span><span class="n">year</span><span class="p">,</span><span class="n">rc</span><span class="p">)],</span>
               <span class="n">alpha</span><span class="o">=</span><span class="m">0.5</span><span class="p">,</span><span class="n">fill</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">NA</span><span class="p">)</span><span class="o">+</span>
      <span class="n">theme_minimal</span><span class="p">()</span><span class="o">+</span>
      <span class="n">geom_text</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">tf</span><span class="p">[</span><span class="n">.frame</span><span class="o">==</span><span class="n">i</span><span class="p">,],</span><span class="n">x</span><span class="o">=</span><span class="m">4</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="m">0.55</span><span class="p">,</span><span class="n">family</span><span class="o">=</span><span class="s2">"Georgia"</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="m">22</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="m">0</span><span class="p">)</span><span class="o">+</span>
      <span class="n">geom_text</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">head</span><span class="p">(</span><span class="n">tf</span><span class="p">[</span><span class="n">.frame</span><span class="o">==</span><span class="n">i</span> <span class="o">&amp;</span> <span class="n">num</span><span class="o">&gt;</span><span class="m">0</span><span class="p">,],</span><span class="m">1</span><span class="p">),</span><span class="n">x</span><span class="o">=</span><span class="m">4</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="m">0.6</span><span class="p">,</span><span class="n">family</span><span class="o">=</span><span class="s2">"Arial Black"</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="m">22</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="m">0.75</span><span class="p">)</span><span class="o">+</span>
      <span class="n">scale_fill_viridis</span><span class="p">(</span><span class="n">discrete</span><span class="o">=</span><span class="s2">"T"</span><span class="p">)</span><span class="o">+</span>
      <span class="n">scale_color_viridis</span><span class="p">(</span><span class="n">discrete</span><span class="o">=</span><span class="s2">"T"</span><span class="p">)</span><span class="o">+</span>
      <span class="n">geom_bar</span><span class="p">(</span><span class="n">stat</span><span class="o">=</span><span class="s2">"identity"</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">NA</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="m">0.6</span><span class="p">)</span><span class="o">+</span>
      <span class="n">theme</span><span class="p">(</span><span class="n">legend.position</span><span class="o">=</span><span class="s2">"none"</span><span class="p">)</span><span class="o">+</span>
      <span class="n">scale_y_continuous</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">percent</span><span class="p">,</span><span class="n">limits</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">.65</span><span class="p">))</span><span class="o">+</span>
      <span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"30-year fixed mortgage rate (in 0.25pp increments)"</span><span class="p">,</span>
           <span class="n">y</span><span class="o">=</span><span class="s2">"Percent of weeks in range"</span><span class="p">,</span>
           <span class="n">title</span><span class="o">=</span><span class="s2">"Distribution of weekly 30-year fixed mortgage rates since 2000"</span><span class="p">,</span>
           <span class="n">caption</span><span class="o">=</span><span class="s2">"@lenkiefer Source: Freddie Mac Primary Mortgage Market Survey"</span><span class="p">,</span>
           <span class="n">subtitle</span><span class="o">=</span><span class="s2">"Gray bars all years 2000-2016, colored bar only: "</span><span class="p">)</span><span class="o">+</span>
      <span class="n">theme</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span> <span class="n">family</span><span class="o">=</span><span class="s2">"Arial"</span><span class="p">),</span>
            <span class="n">plot.caption</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">hjust</span><span class="o">=</span><span class="m">0</span> <span class="p">),</span>
            <span class="n">plot.subtitle</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">face</span><span class="o">=</span><span class="s2">"italic"</span><span class="p">),</span>
            <span class="n">axis.text.x</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">8</span><span class="p">))</span>
    <span class="n">print</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
    <span class="n">ani.pause</span><span class="p">()</span>
    <span class="n">print</span><span class="p">(</span><span class="n">paste</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="s2">"out of"</span><span class="p">,</span><span class="n">max</span><span class="p">(</span><span class="n">tf</span><span class="o">$</span><span class="n">.frame</span><span class="p">)))</span>
  <span class="p">}</span>
  <span class="p">},</span><span class="n">movie.name</span><span class="o">=</span><span class="s2">"pmms share bars dec 2016.gif"</span><span class="p">,</span><span class="n">ani.width</span> <span class="o">=</span> <span class="m">840</span><span class="p">,</span> <span class="n">ani.height</span> <span class="o">=</span><span class="m">450</span><span class="p">)</span></code></pre></figure>

<h1 id="everything-is-a-tile">Everything is a tile</h1>

<p>Somehow I just stumbled upon <a href="http://docs.ggplot2.org/current/geom_tile.html"><em>geom_tile()</em></a>.  Now everything is a tile.</p>

<p><a href="/2016/12/08/10-ways-to-visualize-rates">Earlier</a> we made a strip chart.  If you don’t want to click here it is again (go to link for code):</p>

<p><img src="/img/Rfig/rate-viz2-dec-18-2016,-1.svg" alt="plot of chunk rate-viz2-dec-18-2016," /></p>

<h3 id="make-it-a-tile">Make it a tile</h3>

<p>The tile chart is very similar to the strip, but instead of having one left/right dimension we’ll add an up/down dimension. We’ll construct a week number variable indicating the week of the year and display that on the x axis.  Then on the y axis we’ll have years going down.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">pmms30yr</span><span class="p">[,</span><span class="n">id</span><span class="o">:=</span><span class="m">1</span><span class="o">:</span><span class="n">.N</span><span class="p">,</span><span class="n">by</span><span class="o">=</span><span class="n">year</span><span class="p">]</span>  <span class="c1">#construct week indicator
</span>
<span class="c1"># create a year indicator in reverse order
# we want it in reverse order so year will go down instead of up
</span><span class="n">pmms30yr</span><span class="o">$</span><span class="n">yearf</span><span class="o">&lt;-</span><span class="n">factor</span><span class="p">(</span><span class="n">pmms30yr</span><span class="o">$</span><span class="n">year</span><span class="p">,</span><span class="n">levels</span><span class="o">=</span><span class="n">seq</span><span class="p">(</span><span class="m">2016</span><span class="p">,</span><span class="m">1971</span><span class="p">,</span><span class="m">-1</span><span class="p">))</span>  

<span class="n">g.tile</span><span class="o">&lt;-</span>
  <span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">pmms30yr</span><span class="p">[</span><span class="n">year</span><span class="o">&gt;</span><span class="m">2000</span><span class="p">,],</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">id</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">yearf</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">d52</span><span class="p">,</span><span class="n">fill</span><span class="o">=</span><span class="n">d52</span><span class="p">))</span><span class="o">+</span>
  <span class="n">geom_tile</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">)</span><span class="o">+</span>
  <span class="n">scale_x_continuous</span><span class="p">(</span><span class="n">breaks</span><span class="o">=</span><span class="n">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">50</span><span class="p">,</span><span class="m">10</span><span class="p">))</span><span class="o">+</span>
  <span class="n">scale_fill_viridis</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"52-week\nChange (pp)"</span><span class="p">,</span><span class="n">discrete</span><span class="o">=</span><span class="n">F</span><span class="p">,</span><span class="n">option</span><span class="o">=</span><span class="s2">"B"</span><span class="p">)</span><span class="o">+</span>
  <span class="n">scale_color_viridis</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"52-week\nChange (pp)"</span><span class="p">,</span><span class="n">discrete</span><span class="o">=</span><span class="n">F</span><span class="p">,</span><span class="n">option</span><span class="o">=</span><span class="s2">"B"</span><span class="p">)</span><span class="o">+</span>
  <span class="n">theme_minimal</span><span class="p">()</span><span class="o">+</span><span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"week of year"</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="s2">"year"</span><span class="p">,</span>
                       <span class="n">title</span><span class="o">=</span><span class="s2">"Annual change in 30-year fixed mortgage rates"</span><span class="p">,</span>
                       <span class="n">subtitle</span><span class="o">=</span><span class="s2">"52-week change in rates"</span><span class="p">,</span>
                       <span class="n">caption</span><span class="o">=</span><span class="s2">"@lenkiefer Source: Freddie Mac Primary Mortgage Market Survey"</span><span class="p">)</span><span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">legend.position</span><span class="o">=</span><span class="s2">"top"</span><span class="p">,</span><span class="n">plot.caption</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">hjust</span><span class="o">=</span><span class="m">0</span><span class="p">))</span><span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">axis.text.y</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">6</span><span class="p">),</span>
        <span class="n">axis.text.x</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">6</span><span class="p">))</span>
<span class="n">g.tile</span></code></pre></figure>

<p><img src="/img/Rfig/rate-viz4-dec-18-2016,-1.svg" alt="plot of chunk rate-viz4-dec-18-2016," /></p>

<p>Now we can combine the tile chart with a column chart:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">source</span><span class="p">(</span><span class="s2">"code/multiplot.R"</span><span class="p">)</span>  <span class="c1">#code for combining separate ggplot graphs
# find multiplot code here: http://www.cookbook-r.com/Graphs/Multiple_graphs_on_one_page_(ggplot2)/
</span>
<span class="n">g.diff</span><span class="o">&lt;-</span>
    <span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">pmms30yr</span><span class="p">[</span><span class="n">year</span><span class="o">&gt;</span><span class="m">2000</span><span class="p">,],</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">date</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">d52</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">d52</span><span class="p">,</span><span class="n">fill</span><span class="o">=</span><span class="n">rate</span><span class="p">))</span><span class="o">+</span>
    <span class="n">geom_col</span><span class="p">()</span><span class="o">+</span>
    <span class="n">scale_fill_viridis</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"52-week\nChange (pp)"</span><span class="p">,</span><span class="n">discrete</span><span class="o">=</span><span class="n">F</span><span class="p">,</span><span class="n">option</span><span class="o">=</span><span class="s2">"B"</span><span class="p">)</span><span class="o">+</span>
    <span class="n">scale_color_viridis</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"52-week\nChange (pp)"</span><span class="p">,</span><span class="n">discrete</span><span class="o">=</span><span class="n">F</span><span class="p">,</span><span class="n">option</span><span class="o">=</span><span class="s2">"B"</span><span class="p">)</span><span class="o">+</span>
    <span class="n">theme_minimal</span><span class="p">()</span><span class="o">+</span>
    <span class="n">theme</span><span class="p">(</span><span class="n">axis.text.x</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">6</span><span class="p">))</span><span class="o">+</span>
    <span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span>
         <span class="n">title</span><span class="o">=</span><span class="s2">"52-week change in 30-year Fixed Mortgage Rate"</span><span class="p">,</span>
         <span class="c1">#subtitle="52-week change in mortgage rates",
</span>         <span class="n">caption</span><span class="o">=</span><span class="s2">"@lenkiefer Source: Freddie Mac Primary Mortgage Market Survey"</span><span class="p">)</span><span class="o">+</span>
    <span class="n">scale_x_date</span><span class="p">(</span><span class="n">date_breaks</span><span class="o">=</span><span class="s2">"1 year"</span><span class="p">,</span><span class="n">date_label</span><span class="o">=</span><span class="s2">"%Y"</span><span class="p">)</span><span class="o">+</span>
    <span class="n">theme</span><span class="p">(</span><span class="n">plot.title</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">14</span><span class="p">))</span><span class="o">+</span>
    <span class="n">theme</span><span class="p">(</span><span class="n">axis.text</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">8</span><span class="p">))</span><span class="o">+</span>
    <span class="n">theme</span><span class="p">(</span><span class="n">plot.caption</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">hjust</span><span class="o">=</span><span class="m">0</span><span class="p">),</span> <span class="n">legend.position</span><span class="o">=</span><span class="s2">"none"</span><span class="p">)</span>

<span class="n">multiplot</span><span class="p">(</span><span class="n">g.diff</span><span class="o">+</span><span class="n">labs</span><span class="p">(</span><span class="n">caption</span><span class="o">=</span><span class="s2">""</span><span class="p">),</span><span class="n">g.tile</span><span class="o">+</span><span class="n">theme</span><span class="p">(</span><span class="n">legend.position</span><span class="o">=</span><span class="s2">"none"</span><span class="p">))</span></code></pre></figure>

<p><img src="/img/Rfig/rate-viz5-dec-18-2016,-1.svg" alt="plot of chunk rate-viz5-dec-18-2016," /></p>

<p>And we can animate it. First, let’s create a function for the column chart of 52-week differences <em>diff.plot()</em> and a function for the tile plot <em>tile.plot()</em>.  Let’s examine the functions and see how they work when we give it a year, 2004 before the end of our sample:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">diff.plot</span><span class="o">&lt;-</span><span class="k">function</span><span class="p">(</span><span class="n">y</span><span class="p">){</span>
  <span class="n">g.diff</span><span class="o">&lt;-</span>
    <span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">pmms30yr</span><span class="p">[</span><span class="n">year</span><span class="o">&gt;</span><span class="m">2000</span> <span class="o">&amp;</span> <span class="n">year</span><span class="o">&lt;=</span><span class="n">y</span><span class="p">,],</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">date</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">d52</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">d52</span><span class="p">,</span><span class="n">fill</span><span class="o">=</span><span class="n">rate</span><span class="p">))</span><span class="o">+</span>
    <span class="n">geom_col</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">pmms30yr</span><span class="p">[</span><span class="n">year</span><span class="o">&gt;</span><span class="m">2000</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">NA</span><span class="p">)</span><span class="o">+</span>
    <span class="n">geom_col</span><span class="p">()</span><span class="o">+</span>
    <span class="n">scale_fill_viridis</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"52-week\nChange (pp)"</span><span class="p">,</span><span class="n">discrete</span><span class="o">=</span><span class="n">F</span><span class="p">,</span><span class="n">option</span><span class="o">=</span><span class="s2">"B"</span><span class="p">)</span><span class="o">+</span>
    <span class="n">scale_color_viridis</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"52-week\nChange (pp)"</span><span class="p">,</span><span class="n">discrete</span><span class="o">=</span><span class="n">F</span><span class="p">,</span><span class="n">option</span><span class="o">=</span><span class="s2">"B"</span><span class="p">)</span><span class="o">+</span>
    <span class="n">theme_minimal</span><span class="p">()</span><span class="o">+</span>
    <span class="n">theme</span><span class="p">(</span><span class="n">axis.text.x</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">6</span><span class="p">))</span><span class="o">+</span>
    <span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span>
         <span class="n">title</span><span class="o">=</span><span class="s2">"52-week change in 30-year Fixed Mortgage Rate"</span><span class="p">,</span>
         <span class="n">caption</span><span class="o">=</span><span class="s2">"@lenkiefer Source: Freddie Mac Primary Mortgage Market Survey"</span><span class="p">)</span><span class="o">+</span>
    <span class="n">scale_x_date</span><span class="p">(</span><span class="n">date_breaks</span><span class="o">=</span><span class="s2">"1 year"</span><span class="p">,</span><span class="n">date_label</span><span class="o">=</span><span class="s2">"%Y"</span><span class="p">)</span><span class="o">+</span>
    <span class="n">theme</span><span class="p">(</span><span class="n">plot.title</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">14</span><span class="p">))</span><span class="o">+</span>
    <span class="n">theme</span><span class="p">(</span><span class="n">axis.text</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">8</span><span class="p">))</span><span class="o">+</span>
    <span class="n">theme</span><span class="p">(</span><span class="n">plot.caption</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">hjust</span><span class="o">=</span><span class="m">0</span><span class="p">),</span> <span class="n">legend.position</span><span class="o">=</span><span class="s2">"none"</span><span class="p">)</span>
  <span class="k">return</span><span class="p">(</span><span class="n">g.diff</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">tile.plot</span><span class="o">&lt;-</span><span class="k">function</span><span class="p">(</span><span class="n">y</span><span class="p">){</span>
  <span class="n">g.tile</span><span class="o">&lt;-</span>  
    <span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">pmms30yr</span><span class="p">[</span><span class="n">year</span><span class="o">&gt;</span><span class="m">2000</span> <span class="o">&amp;</span> <span class="n">year</span><span class="o">&lt;=</span><span class="n">y</span><span class="p">,],</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">id</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">yearf</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">d52</span><span class="p">,</span><span class="n">fill</span><span class="o">=</span><span class="n">d52</span><span class="p">))</span><span class="o">+</span>
    <span class="n">geom_tile</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">pmms30yr</span><span class="p">[</span><span class="n">year</span><span class="o">&gt;</span><span class="m">2000</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">NA</span><span class="p">)</span><span class="o">+</span>
    <span class="n">geom_tile</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">)</span><span class="o">+</span>
    <span class="n">scale_fill_viridis</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"52-week\nChange (pp)"</span><span class="p">,</span><span class="n">discrete</span><span class="o">=</span><span class="n">F</span><span class="p">,</span><span class="n">option</span><span class="o">=</span><span class="s2">"B"</span><span class="p">)</span><span class="o">+</span>
    <span class="n">scale_color_viridis</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"52-week\nChange (pp)"</span><span class="p">,</span><span class="n">discrete</span><span class="o">=</span><span class="n">F</span><span class="p">,</span><span class="n">option</span><span class="o">=</span><span class="s2">"B"</span><span class="p">)</span><span class="o">+</span>
    <span class="n">theme_minimal</span><span class="p">()</span><span class="o">+</span><span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"week of year"</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="s2">"year"</span><span class="p">,</span>
                       <span class="n">title</span><span class="o">=</span><span class="s2">"Annual change in 30-year fixed mortgage rates"</span><span class="p">,</span>
                       <span class="n">subtitle</span><span class="o">=</span><span class="s2">"52-week change in rates"</span><span class="p">,</span>
                       <span class="n">caption</span><span class="o">=</span><span class="s2">"@lenkiefer Source: Freddie Mac Primary Mortgage Market Survey"</span><span class="p">)</span><span class="o">+</span>
    <span class="n">theme</span><span class="p">(</span><span class="n">legend.position</span><span class="o">=</span><span class="s2">"top"</span><span class="p">,</span><span class="n">plot.caption</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">hjust</span><span class="o">=</span><span class="m">0</span><span class="p">))</span><span class="o">+</span>
    <span class="n">theme</span><span class="p">(</span><span class="n">axis.text.y</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">6</span><span class="p">),</span>
          <span class="n">axis.text.x</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">6</span><span class="p">))</span>
  <span class="k">return</span><span class="p">(</span><span class="n">g.tile</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># test it:
</span><span class="n">multiplot</span><span class="p">(</span><span class="n">diff.plot</span><span class="p">(</span><span class="m">2004</span><span class="p">)</span><span class="o">+</span><span class="n">labs</span><span class="p">(</span><span class="n">caption</span><span class="o">=</span><span class="s2">""</span><span class="p">),</span><span class="n">tile.plot</span><span class="p">(</span><span class="m">2004</span><span class="p">)</span><span class="o">+</span><span class="n">theme</span><span class="p">(</span><span class="n">legend.position</span><span class="o">=</span><span class="s2">"none"</span><span class="p">))</span></code></pre></figure>

<p><img src="/img/Rfig/rate-viz6-dec-18-2016,-1.svg" alt="plot of chunk rate-viz6-dec-18-2016," /></p>

<p>This plot shows us what our plot will look like in after we get to year 2004.  By adding in the full data with alpha=0 (so it is transparent) our axis will be fully expanded.  We could do it by manually setting the axis, but I just did it this way.</p>

<p>Now we can loop through the data to create the animation:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">oopt</span> <span class="o">=</span> <span class="n">ani.options</span><span class="p">(</span><span class="n">interval</span> <span class="o">=</span> <span class="m">0.15</span><span class="p">)</span>
<span class="n">saveGIF</span><span class="p">({</span><span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="k">in</span> <span class="n">seq</span><span class="p">(</span><span class="m">2001</span><span class="p">,</span><span class="m">2016</span><span class="p">,</span><span class="m">1</span><span class="p">))</span> <span class="p">{</span>
  <span class="n">g</span><span class="o">&lt;-</span><span class="n">multiplot</span><span class="p">(</span><span class="n">diff.plot</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="n">labs</span><span class="p">(</span><span class="n">caption</span><span class="o">=</span><span class="s2">""</span><span class="p">),</span><span class="n">tile.plot</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="n">theme</span><span class="p">(</span><span class="n">legend.position</span><span class="o">=</span><span class="s2">"none"</span><span class="p">),</span>
               <span class="n">layout</span><span class="o">=</span><span class="n">matrix</span><span class="p">(</span><span class="n">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">,</span><span class="m">2</span><span class="p">),</span> <span class="n">nrow</span><span class="o">=</span><span class="m">3</span><span class="p">,</span> <span class="n">byrow</span><span class="o">=</span><span class="n">TRUE</span><span class="p">))</span>
  <span class="n">print</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
  <span class="n">ani.pause</span><span class="p">()</span>
<span class="p">}</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i2</span> <span class="k">in</span> <span class="m">1</span><span class="o">:</span><span class="m">10</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">g</span><span class="o">&lt;-</span> <span class="n">multiplot</span><span class="p">(</span><span class="n">diff.plot</span><span class="p">(</span><span class="m">2016</span><span class="p">)</span><span class="o">+</span><span class="n">labs</span><span class="p">(</span><span class="n">caption</span><span class="o">=</span><span class="s2">""</span><span class="p">),</span><span class="n">tile.plot</span><span class="p">(</span><span class="m">2016</span><span class="p">)</span><span class="o">+</span><span class="n">theme</span><span class="p">(</span><span class="n">legend.position</span><span class="o">=</span><span class="s2">"none"</span><span class="p">),</span>
               <span class="n">layout</span><span class="o">=</span><span class="n">matrix</span><span class="p">(</span><span class="n">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">,</span><span class="m">2</span><span class="p">),</span> <span class="n">nrow</span><span class="o">=</span><span class="m">3</span><span class="p">,</span> <span class="n">byrow</span><span class="o">=</span><span class="n">TRUE</span><span class="p">))</span>
    <span class="n">print</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
    <span class="n">ani.pause</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">},</span><span class="n">movie.name</span><span class="o">=</span><span class="s2">"tile_rates_12_18_2016.gif"</span><span class="p">,</span><span class="n">ani.width</span> <span class="o">=</span> <span class="m">650</span><span class="p">,</span> <span class="n">ani.height</span> <span class="o">=</span> <span class="m">800</span><span class="p">)</span></code></pre></figure>

<p><img src="/img/charts_dec_18_2016/tile_rates_12_18_2016.gif" alt="pmms tile col combo" /></p>

    </div>

    

    
  
    <hr>
    <ul class="pagination">
    
      <li class="prev"><a href="/2016/12/17/See-data-speak-data-part1" title="See Data, Speak Data Part 1: But I've go so much to say!">&laquo; Previous</a></li>
    
      <li><a href="/archive.html">Archive</a></li>
    
      <li class="next"><a href="/2016/12/19/more-tweenr-housing" title="Simple tweenr animations with ggplot2 ">Next &raquo;</a></li>
    
    </ul>
    <hr>
    
  </div>
</div>



      </div>

    </div>

    <div id="footer">
      <div class="container">
        <p>&copy; 2017 Len Kiefer
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>
       
    • <span vertical-align:bottom> <a href="https://twitter.com/lenkiefer" class="twitter-follow-button" data-show-count="false">•   Follow @lenkiefer</a>
  
 <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
</span>
• <script src="//platform.linkedin.com/in.js" type="text/javascript"></script>
<script type="IN/MemberProfile" data-id="https://www.linkedin.com/pub/leonard-kiefer/31/753/511" data-format="click" data-related="false" data-text="Leonard Kiefer"></script>
  • lenkiefer@hotmail.com
           </p>
      </div>
    </div>
    





<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-66905937-1', 'auto');
  ga('send', 'pageview');

</script>

    <!-- Latest compiled and minified JavaScript, requires jQuery 1.x (2.x not supported in IE8) -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="/assets/themes/lentheme/bootstrap/js/bootstrap.min.js"></script>
  </body>
</html>





