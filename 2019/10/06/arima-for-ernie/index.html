<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="What structural time series analysis might tell us about plotting data.">
  <meta name="generator" content="Hugo 0.81.0" />

  <title>ARIMA for Ernie &middot; Len Kiefer</title>

  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="/css/blackburn.css">

  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

  
  <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet" type="text/css">

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

 
  

  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/androidstudio.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  
  <script>hljs.initHighlightingOnLoad();</script>
  

  <link rel="shortcut icon" href="http://lenkiefer.com/img/favicon.PNG" type="image/x-icon" />

  
  

</head>


<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  
  <a class="pure-menu-heading brand" href="/">Len Kiefer</a>


  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="/"><i class='fa fa-home fa-fw'></i>Home</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="/post/"><i class='fa fa-list fa-fw'></i>Archive</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="/about/"><i class='fa fa-user fa-fw'></i>About</a>
      
        </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://twitter.com/@lenkiefer" target="_blank"><i class="fa fa-twitter-square fa-fw"></i>Twitter</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://linkedin.com/in/leonard-kiefer-51175331" target="_blank"><i class="fa fa-linkedin-square fa-fw"></i>LinkedIn</a>
    </li>
    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://github.com/lenkiefer" target="_blank"><i class="fa fa-github-square fa-fw"></i>GitHub</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

  </ul>
</div>


  <div>
  <div class="small-print">
    <small>&copy; 2015-2018. All rights reserved.</small>
  </div>
  <div class="small-print">
    <small>Built with&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>


  <div id="main">


       <meta name="twitter:card" content="summary_large_image">
       <meta name="twitter:image" content="http://lenkiefer.com/img/charts_2019_10_06/ucm.png" >
     
    <meta property="og:title" content="ARIMA for Ernie">
    <meta property="og:description" content="What structural time series analysis might tell us about plotting data.">

<div class="header">
  <h1>ARIMA for Ernie</h1>
  <h2>What structural time series analysis might tell us about plotting data.</h2>
</div>
<div class="content">

  <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>2019/10/06</time>
  </div>

  

  

  
  
  
  <div>
    <i class="fa fa-tags fa-fw"></i>
    
      <a class="post-taxonomy-tag" href="http://lenkiefer.com/tags/dataviz">dataviz</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="http://lenkiefer.com/tags/economy">economy</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="http://lenkiefer.com/tags/r">R</a>
    
  </div>
  
  

</div>

  


<p>Early last Friday morning I was sitting in Palm Springs International Airport waiting to catch a flight back to Virginia. I had traveled out west to speak at the <a href="http://naglrep.com/2019/">2019 NAGLREP Conference</a>. This Friday happened to be jobs Friday, when the U.S. Bureau of Labor Statistics releases the <a href="https://www.bls.gov/news.release/empsit.nr0.htm">employment situation</a>. Jobs Fridays are busy on Twitter. Everybody seems eager to offer a perspective on what the latest jobs numbers mean for the U.S. economy.</p>
<p>As I scrolled through my feed one Tweet caught my attention. A lot of people have thoughts on jobs Friday. Ernie Tedeschi ( <span class="citation">[@ernietedeschi]</span>(<a href="https://twitter.com/ernietedeschi" class="uri">https://twitter.com/ernietedeschi</a>)) usually has something interesting to say. Though I believe both Ernie and I live in the D.C. metro area, we haven’t met. Maybe one day I’ll be lucky enough to meet with him, but in the meantime I get a lot out of his analysis on Twitter.</p>
<p>This Jobs Friday Ernie was replying to some other thread:</p>
<blockquote>
<p>I prefer looking Y-Y to eliminate more survey noise. Wage growth Y-Y has been flat or decelerating YTD. Something is either compositionally or fundamentally stunting wage growth this year. pic.twitter.com/HEE48rHFYU</p>
</blockquote>
<p>— Ernie Tedeschi (<span class="citation">@ernietedeschi</span>) October 4, 2019</p>
<p>What caught my attention was something that I often do: transform data. When looking at time series data, it’s often helpful to do some sort of filtering. Every chart has embedded within it an implicit model about how the world works. This is especially true of time series plots. Any transformation you make can radically alter what the chart seems to tell you about the world.</p>
<p>When my team brings me charts to help explain something they are working on, I try hard not to be pedantic or a chart scold, but sometimes I can’t just let it go. I’ve tried to mellow out and be clear that I’m being picky for a reason. But often, choices for time series plots are making strong claims about the world.</p>
<p>When I looked at Ernie’s tweet, I wondered: what sort of world makes a 12-month percent change a better signal than a 3-month percent change? Let’s take a look at it. Per usual we will use <a href="https://www.r-project.org/">R</a>.</p>
<p>The data is pretty easy to get. Ernie’s chart plotted two standard economic time series from the U.S. Bureau of Labor Statistics: average hourly earnings of all private sector employees and average hourly earnings of production and nonsupervisory employees.</p>
<details>
<p><Summary>R code to get data </Summary></p>
<pre class="r"><code># libraries
library(forecast)
library(tidyquant)
library(tidyverse)
library(KFAS)
library(rucm)

# get data via FRED
tickers &lt;- c(&quot;CES0500000003&quot;,&quot;AHETPI&quot;)
cnames &lt;- c(&quot;Total Private&quot;,&#39;Production and Nonsupervisory Employees&#39;)


df &lt;- 
  tidyquant::tq_get(tickers, 
                    get=&quot;economic.data&quot;,
                    from=&quot;2006-03-01&quot;) %&gt;%
  left_join( tibble(symbol=tickers,names=cnames), by=&quot;symbol&quot;) 

# create captions for plots

mycaption1 &lt;- paste0(&quot;@lenkiefer Source: U.S. Bureau of Labor Statistics, Average Hourly Earnings of All Employees: Total Private [CES0500000003],&quot;,
                     &quot;\nretrieved from FRED, Federal Reserve Bank of St. Louis; https://fred.stlouisfed.org/series/CES0500000003, October 6, 2019&quot;)

mycaption2 &lt;- paste0(&quot;@lenkiefer Source: U.S. Bureau of Labor Statistics, Average Hourly Earnings of Production and Nonsupervisory Employees, Total Private [AHETPI],&quot;,
                     &quot;\nretrieved from FRED, Federal Reserve Bank of St. Louis; https://fred.stlouisfed.org/series/AHETPI, October 6, 2019.&quot;)


str(df)</code></pre>
<pre><code>## Classes &#39;tbl_df&#39;, &#39;tbl&#39; and &#39;data.frame&#39;:    326 obs. of  4 variables:
##  $ symbol: chr  &quot;CES0500000003&quot; &quot;CES0500000003&quot; &quot;CES0500000003&quot; &quot;CES0500000003&quot; ...
##  $ date  : Date, format: &quot;2006-03-01&quot; &quot;2006-04-01&quot; ...
##  $ price : num  20 20.2 20.1 20.2 20.3 ...
##  $ names : chr  &quot;Total Private&quot; &quot;Total Private&quot; &quot;Total Private&quot; &quot;Total Private&quot; ...</code></pre>
</details>
<p>Now that we have the data let’s take a look. It will be convenient to work with these data as times series, so we’ll convert them. We’ll also make some transformations we can use below. Let’s focus on the earnings for all private sector employees.</p>
<details>
<p><Summary>Wrangle data, basic plots </Summary></p>
<pre class="r"><code>ts1 &lt;- filter(df,symbol==&quot;CES0500000003&quot;) %&gt;% pull(price) %&gt;% ts(start=2006+2/12,frequency=12)
ts2 &lt;- filter(df,symbol==&quot;AHETPI&quot;) %&gt;% pull(price) %&gt;% ts(start=2006+2/12,frequency=12)

# 1-month log difference, annualized growth rate
ts1m &lt;- diff(log(ts1))*12
ts2m &lt;- diff(log(ts2))*12

# 3-month log difference, annualized growth rate (3-month moving average)
ts1ma3 &lt;- zoo::rollapply(ts1,3,  mean,  align=&quot;right&quot;)
ts2ma3 &lt;- zoo::rollapply(ts2,3,  mean,  align=&quot;right&quot;)

# 3-month log difference, annualized growth rate
ts1q &lt;- diff(log(ts1ma3),3)*4
ts2q &lt;- diff(log(ts2ma3),3)*4

# 12-month log difference
ts1y &lt;- diff(log(ts1),12)
ts2y &lt;- diff(log(ts2),12)

# use the forecast package autoplot
# make plots (printed outside the details tab)
g1 &lt;- 
  autoplot(ts1) + 
  labs(x=&quot;&quot;,
       y=&quot;&quot;,
       title=&quot;Average Hourly Earnings: All Private Sector Employees&quot;,
       subtitle=&quot;$/Hour&quot;,
       caption=mycaption1)+
  theme_minimal()+
  theme(plot.caption=element_text(hjust=0))

g2&lt;- 
  autoplot(ts2) + 
  labs(x=&quot;&quot;,
       y=&quot;&quot;,
       title=&quot;Average Hourly Earnings: Private Sector Production and Nonsupervisory Employees&quot;,
       subtitle=&quot;$/Hour&quot;,
       caption=mycaption2)+
  theme_minimal()+
  theme(plot.caption=element_text(hjust=0))</code></pre>
</details>
<pre class="r"><code>cowplot::plot_grid(g1,g2, ncol=1)</code></pre>
<p><img src="/post/2019-10-06-arima-for-ernie_files/figure-html/2019-10-6-data-wrangle-2-1.png" width="864" /></p>
<p>These plots reveal that average hourly earning typically rise, but how much? Let’s consider some transformations:</p>
<pre class="r"><code># inari colors!  http://lenkiefer.com/2019/09/23/theme-inari/
inari  &lt;- &quot;#fe5305&quot;

ggplot(data=ts1y, 
       aes(x=time(ts1y), y=ts1y, color=&quot;12-month log difference&quot;))+
  geom_line(data=ts1m, aes(x=time(ts1m), y=ts1m, color=&quot;01-month log difference&quot;),alpha=0.75)+
  geom_line(data=ts1q, aes(x=time(ts1q), y=ts1q, color=&quot;03-month log difference&quot;),alpha=0.75)+
  geom_line()+
  scale_color_manual(name=&quot;transformation&quot;, values=c(&quot;gray&quot;,&quot;dodgerblue&quot;,inari))+
  labs(x=&quot;&quot;,y=&quot;&quot;,
       title=&quot;Average Hourly Earnings: All Private Sector Employees&quot;,
       subtitle=&quot;Annualized growth rate&quot;,
       caption=mycaption1)+
  scale_y_continuous(labels=scales::percent,sec.axis=dup_axis())+
  theme_minimal()+
  theme(plot.caption=element_text(hjust=0),
        legend.position=&quot;top&quot;)</code></pre>
<pre><code>## Don&#39;t know how to automatically pick scale for object of type ts. Defaulting to continuous.</code></pre>
<div class="figure"><span id="fig:2019-10-06-plot-1"></span>
<img src="/post/2019-10-06-arima-for-ernie_files/figure-html/2019-10-06-plot-1-1.png" alt="Trends in wages" width="864" />
<p class="caption">
Figure 1: Trends in wages
</p>
</div>
<p>Here we plot three transformations: 1-month (monthly) growth rate, 3-month (quarterly) growth rate, and 12-month (annual) growth rate. The monthly growth rates look quite noisy, so some smoothing seems warranted. But should we use a 3-month or 12-month percent change? Does it matter?</p>
<div id="structural-time-series-approach" class="section level1">
<h1>Structural time series approach</h1>
<p>One way to approach this problem is to ask the following question. What is the underlying trend driving average hourly earnings, and has that trend changed? I believe that’s the spirit of the Twitter conversation up above.</p>
<div id="seasonality" class="section level2">
<h2>Seasonality?</h2>
<p>There’s also a nastier problem about seasonal adjustment that I’m going to avoid here.</p>
<details>
<p><Summary>An observation on seasonality </Summary></p>
<p>The underlying data is seasonally adjusted, but there could be residual seasonality in the data. We won’t be exploring that here in great detail.</p>
<p>If we restrict ourselves to ARIMA models of max non-seasonal differences of 1 we get.</p>
<pre class="r"><code># set lambda=0 implies log transform of underlying series
auto.arima(ts1,lambda=0,max.d=1)</code></pre>
<pre><code>## Series: ts1 
## ARIMA(2,1,2)(1,0,2)[12] with drift 
## Box Cox transformation: lambda= 0 
## 
## Coefficients:
##          ar1      ar2      ma1     ma2    sar1     sma1     sma2   drift
##       0.9022  -0.0052  -1.3176  0.5268  0.3131  -0.3441  -0.3627  0.0021
## s.e.  0.1294   0.1572   0.1013  0.1298  0.2111   0.2074   0.0988  0.0001
## 
## sigma^2 estimated as 1.455e-06:  log likelihood=863.33
## AIC=-1708.67   AICc=-1707.48   BIC=-1680.88</code></pre>
<p>Even the seasonally adjusted data appears to possibly have some residual seasonality.</p>
</details>
<p>If we use the <a href="https://CRAN.R-project.org/package=forecast">forecast</a> package’s <code>auto.arima</code> function on the time series we get an ARIMA(2,2,1) model.</p>
<pre class="r"><code># set lambda=0 implies log transform of underlying series
auto.arima(ts1,lambda=0)</code></pre>
<pre><code>## Series: ts1 
## ARIMA(2,2,1) 
## Box Cox transformation: lambda= 0 
## 
## Coefficients:
##           ar1      ar2      ma1
##       -0.6348  -0.4037  -0.8255
## s.e.   0.0820   0.0830   0.0571
## 
## sigma^2 estimated as 1.625e-06:  log likelihood=850.5
## AIC=-1693   AICc=-1692.74   BIC=-1680.67</code></pre>
<p>An ARIMA (0,2,1) model is a close cousin of the local level model described by the following equations:</p>
<p><span class="math display">\[ y_t = \mu_t + \epsilon_t,\]</span></p>
<p><span class="math display">\[ \mu_t = \mu_{t-1} + \nu_t + \eta_t, \]</span></p>
<p><span class="math display">\[ \nu_t = \nu_{t-1} + u_t,\]</span></p>
<p>where <span class="math inline">\(y_t\)</span> is the time series, <span class="math inline">\(\mu_t\)</span> is the time-varying trend and <span class="math inline">\(\nu_t\)</span> is the slope.</p>
<p>We could estimate these models with good old <a href="http://support.sas.com/documentation/cdl/en/etsug/63939/HTML/default/viewer.htm#etsug_ucm_sect006.htm">SAS PROC UCM</a> or with the R wrapper for <a href="https://CRAN.R-project.org/package=KFAS">KFAS</a>, <a href="https://CRAN.R-project.org/package=rucm">rucm</a>.</p>
<pre class="r"><code>lts1 &lt;- log(ts1)

# estimate ucm model with time varying trend, slope

ss1 &lt;- ucm(lts1~1 ,data=lts1, slope=TRUE)

# combine data
ts1_all &lt;- ts.union(ts1,ts1m,ts1y,ts1q,ss1$s.slope)
# make a tibble
df1   &lt;- tibble(time=time(ts1_all),
                  ts1 = ts1_all[,&quot;ts1&quot;],
                  ts1m= ts1_all[,&quot;ts1m&quot;],
                  ts1q= ts1_all[,&quot;ts1q&quot;],
                  ts1y= ts1_all[,&quot;ts1y&quot;],
                  ss1 = ts1_all[,&quot;ss1$s.slope&quot;])

# plot data
ggplot(data=df1, 
       aes(x=time, y=ts1y, color=&quot;12-month log difference&quot;))+
  geom_line( aes(y=ts1q, color=&quot;03-month log difference&quot;),alpha=0.75)+
    geom_line(aes(y=12*ss1, color=&quot;Smoothed Trend&quot;),alpha=0.75,size=1.05)+
  geom_line()+
  scale_color_manual(name=&quot;transformation&quot;, values=c(&quot;dodgerblue&quot;,inari,&quot;red&quot;))+
  labs(x=&quot;&quot;,y=&quot;&quot;,
       title=&quot;Average Hourly Earnings: All Private Sector Employees&quot;,
       subtitle=&quot;Annualized growth rate&quot;,
       caption=mycaption1)+
  scale_y_continuous(labels=scales::percent,sec.axis=dup_axis())+
  theme_minimal()+
  theme(plot.caption=element_text(hjust=0),
        legend.position=&quot;top&quot;)</code></pre>
<div class="figure"><span id="fig:2019-10-06-ucm-1"></span>
<img src="/post/2019-10-06-arima-for-ernie_files/figure-html/2019-10-06-ucm-1-1.png" alt="Unobserved Components Model for Wages" width="672" />
<p class="caption">
Figure 2: Unobserved Components Model for Wages
</p>
</div>
<p>The UCM model gives an estimate of the trend that is smoother than both the 3-month and 12-month growth rates. The 3-month growth rate probably still has “too much” volatility, but it’s faster to track changes in the trend than the 12-month percent change.</p>
</div>
</div>
<div id="discussion" class="section level1">
<h1>Discussion</h1>
<p>After I saw Ernie’s tweet, <a href="https://twitter.com/lenkiefer/status/1180109721107230720?s=20">I asked</a> under what conditions the 12-month percent change was a better transformation than the 3-month percent change. I’m not completely sure, though I have an inutitive feel that a 12-month filter is often “about right” for a lot of U.S. macroeconomic time series I look at day to day.</p>
<p>I feel this framework might be a useful way to work through some of those conditions. Perhaps we’ll revisit it in future.</p>
</div>


  
<div class="prev-next-post pure-g">
  <div class="pure-u-1-24" style="text-align: left;">
    
    <a href="http://lenkiefer.com/2019/09/23/theme-inari/"><i class="fa fa-chevron-left"></i></a>
    
  </div>
  <div class="pure-u-10-24">
    
    <nav class="prev">
      <a href="http://lenkiefer.com/2019/09/23/theme-inari/">Theme Inari</a>
    </nav>
    
  </div>
  <div class="pure-u-2-24">
    &nbsp;
  </div>
  <div class="pure-u-10-24">
    
    <nav class="next">
      <a href="http://lenkiefer.com/2019/10/08/tiny-r-code-for-smoothing-data/">Tiny R Code for Smoothing Data</a>
    </nav>
    
  </div>
  <div class="pure-u-1-24" style="text-align: right;">
    
    <a href="http://lenkiefer.com/2019/10/08/tiny-r-code-for-smoothing-data/"><i class="fa fa-chevron-right"></i></a>
    
  </div>
</div>



  

</div>
<footer class="post-footer clearfix">
    
        <p class="post-tags">
            <span>Tagged:</span>
            
            
                <a href="/tags/dataviz/">dataviz</a>, 
            
                <a href="/tags/economy/">economy</a>, 
            
                <a href="/tags/r/">R</a>
            
        </p>
    

    <div class="share">
        
            <a class="icon-twitter" href="https://twitter.com/share?url=http://lenkiefer.comhttp%3a%2f%2flenkiefer.com%2f2019%2f10%2f06%2farima-for-ernie%2f&text=ARIMA%20for%20Ernie via %40lenkiefer"
                onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                <i class="fa fa-twitter"></i>
                <span class="hidden">Twitter</span>
            </a>
        

        
            <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://lenkiefer.comhttp%3a%2f%2flenkiefer.com%2f2019%2f10%2f06%2farima-for-ernie%2f"
                onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                <i class="fa fa-facebook"></i>
                <span class="hidden">Facebook</span>
            </a>
        


        
    </div>
</footer>
</div>
</div>
<script src="http://lenkiefer.com/js/ui.js"></script>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-66905937-1', 'auto');
  ga('send', 'pageview');

</script>






</body>
</html>

