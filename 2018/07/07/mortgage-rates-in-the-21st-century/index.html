<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Your chart versus the chart your boss told you not to worry about">
  <meta name="generator" content="Hugo 0.81.0" />

  <title>Mortgage rates in the 21st century &middot; Len Kiefer</title>

    

  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="http://lenkiefer.com/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="http://lenkiefer.com/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="http://lenkiefer.com/css/blackburn.css">

  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css">

  
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Raleway&display=swap" rel="stylesheet" type="text/css">

  
  <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

 
  

  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/styles/androidstudio.min.css">
  <script async src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/highlight.min.js"></script>
  
  <script>hljs.initHighlightingOnLoad();</script>
  

  <link rel="shortcut icon" href="http://lenkiefer.com/img/favicon.ico" type="image/x-icon" />

  
  

</head>


<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  
  <a class="pure-menu-heading brand" href="http://lenkiefer.com/">Len Kiefer</a>


  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="http://lenkiefer.com/"><i class='fa fa-home fa-fw'></i>Home</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="http://lenkiefer.com/post/"><i class='fa fa-list fa-fw'></i>Archive</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="http://lenkiefer.com/about/"><i class='fa fa-user fa-fw'></i>About</a>
      
        </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://twitter.com/@lenkiefer" rel="me" target="_blank"><i class="fab fa-twitter-square fa-fw"></i>Twitter</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://linkedin.com/in/leonard-kiefer-51175331" rel="me" target="_blank"><i class="fab fa-linkedin fa-fw"></i>LinkedIn</a>
    </li>
    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://github.com/lenkiefer" rel="me" target="_blank"><i class="fab fa-github-square fa-fw"></i>GitHub</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

  </ul>
</div>


  <div>
  <div class="small-print">
    <small>&copy; 2021. All rights reserved.</small>
  </div>
  <div class="small-print">
    <small>Built with&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>


  <div id="main">


       <meta name="twitter:card" content="summary_large_image">
       <meta name="twitter:image" content="http://lenkiefer.com//img/charts_jul_07_2018/compare.png" >
     
    <meta property="og:title" content="Mortgage rates in the 21st century">
    <meta property="og:description" content="Your chart versus the chart your boss told you not to worry about">

<div class="header">
  <h1>Mortgage rates in the 21st century</h1>
  <h2>Your chart versus the chart your boss told you not to worry about</h2>
</div>
<div class="content">

  <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>2018/07/07</time>
  </div>

  

  

  
  
  
  <div>
    <i class="fa fa-tags fa-fw"></i>
    
      <a class="post-taxonomy-tag" href="http://lenkiefer.com/tags/dataviz">dataviz</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="http://lenkiefer.com/tags/r">R</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="http://lenkiefer.com/tags/mortgage">mortgage</a>
    
  </div>
  
  

</div>

  


<p>Let’s compare two charts. “Your chart”, or a chart that might come virtually unedited from spreadsheet software versus the chart your boss told you not to worry about:</p>
<p><img src="../../../../img/charts_jul_07_2018/compare.png" width="740" height="330"></p>
<p>Your chart is perfectly serviceable and for a quick exploration might be perfectly fine. However, why routinely generate such charts if you have the ability to make something a bit more dynamic? Being able to produce more interesting charts might not be necessary, but it also probably doesn’t hurt.</p>
<p>Let’s build a chart like the one on the right and several variations. Per usual with <a href="https://www.r-project.org/">R</a>.</p>
<p>We’ll also try out some of the <a href="https://www.tidyverse.org/articles/2018/07/ggplot2-3-0-0/">new tidy evaluation feature</a> available in <a href="https://ggplot2.tidyverse.org/">ggplot2</a>’s latest version (3.0) ad some other fun tricks.</p>
<p>Let’s get to it.</p>
<div id="mortgage-rates-in-the-21st-century" class="section level1">
<h1>Mortgage rates in the 21st century</h1>
<p>In this post we’ll explore mortgage rates and other interest rates in the 21st century. We’ll look at trends in the level of rates, as well as compare some key spreads.</p>
<div id="data" class="section level2">
<h2>Data</h2>
<p>We can easily get the data via the Saint Louis Federal Reserve’s <a href="https://fred.stlouisfed.org/">FRED</a> database. If you followed <a href="../../../../2017/04/11/fred-plot">my post</a> from back in April of last year you know what we can do if we combine FRED with the <a href="https://cran.r-project.org/web/packages/quantmod/index.html">quantmod</a> package. It gets even easier if we use <a href="https://CRAN.R-project.org/package=tidyquant">tidyquant</a> like we did <a href="../../../../2017/09/18/a-tidyquant-um-of-solace/">here</a>.</p>
<p>I’m not going to load the tidyquant package, but call it via <code>tidyquant::tq_get</code>.</p>
<pre class="r"><code># Load Libraries ----
library(tidyverse)
library(scales)
library(cowplot)  #for arranging plots
library(lubridate)

# Import data
# Mortgage rates in the 21st century

tickers &lt;- c(&quot;DGS3MO&quot;,
             &quot;DGS1&quot;,
             &quot;DGS2&quot;,
             &quot;DGS3&quot;,
             &quot;DGS5&quot;,
             &quot;DGS7&quot;,
             &quot;DGS10&quot;, 
             &quot;MORTGAGE30US&quot;)

df.rates &lt;- tidyquant::tq_get(tickers,get=&quot;economic.data&quot;,from=&quot;2000-01-01&quot;)</code></pre>
<p>Our imported data is in a nice tidy format, but we’re going to need to widen it out to see what we have.</p>
<pre class="r"><code>df2 &lt;-  spread(df.rates, symbol,price)
knitr::kable(head(df2,10))</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">date</th>
<th align="right">DGS1</th>
<th align="right">DGS10</th>
<th align="right">DGS2</th>
<th align="right">DGS3</th>
<th align="right">DGS3MO</th>
<th align="right">DGS5</th>
<th align="right">DGS7</th>
<th align="right">MORTGAGE30US</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">2000-01-03</td>
<td align="right">6.09</td>
<td align="right">6.58</td>
<td align="right">6.38</td>
<td align="right">6.42</td>
<td align="right">5.48</td>
<td align="right">6.50</td>
<td align="right">6.65</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="left">2000-01-04</td>
<td align="right">6.00</td>
<td align="right">6.49</td>
<td align="right">6.30</td>
<td align="right">6.34</td>
<td align="right">5.43</td>
<td align="right">6.40</td>
<td align="right">6.56</td>
<td align="right">NA</td>
</tr>
<tr class="odd">
<td align="left">2000-01-05</td>
<td align="right">6.05</td>
<td align="right">6.62</td>
<td align="right">6.38</td>
<td align="right">6.43</td>
<td align="right">5.44</td>
<td align="right">6.51</td>
<td align="right">6.68</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="left">2000-01-06</td>
<td align="right">6.03</td>
<td align="right">6.57</td>
<td align="right">6.35</td>
<td align="right">6.39</td>
<td align="right">5.41</td>
<td align="right">6.46</td>
<td align="right">6.63</td>
<td align="right">NA</td>
</tr>
<tr class="odd">
<td align="left">2000-01-07</td>
<td align="right">6.00</td>
<td align="right">6.52</td>
<td align="right">6.31</td>
<td align="right">6.35</td>
<td align="right">5.38</td>
<td align="right">6.42</td>
<td align="right">6.58</td>
<td align="right">8.15</td>
</tr>
<tr class="even">
<td align="left">2000-01-10</td>
<td align="right">6.07</td>
<td align="right">6.57</td>
<td align="right">6.38</td>
<td align="right">6.42</td>
<td align="right">5.42</td>
<td align="right">6.49</td>
<td align="right">6.62</td>
<td align="right">NA</td>
</tr>
<tr class="odd">
<td align="left">2000-01-11</td>
<td align="right">6.13</td>
<td align="right">6.67</td>
<td align="right">6.45</td>
<td align="right">6.49</td>
<td align="right">5.43</td>
<td align="right">6.57</td>
<td align="right">6.72</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="left">2000-01-12</td>
<td align="right">6.16</td>
<td align="right">6.72</td>
<td align="right">6.49</td>
<td align="right">6.53</td>
<td align="right">5.45</td>
<td align="right">6.63</td>
<td align="right">6.76</td>
<td align="right">NA</td>
</tr>
<tr class="odd">
<td align="left">2000-01-13</td>
<td align="right">6.10</td>
<td align="right">6.63</td>
<td align="right">6.40</td>
<td align="right">6.45</td>
<td align="right">5.41</td>
<td align="right">6.54</td>
<td align="right">6.67</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="left">2000-01-14</td>
<td align="right">6.13</td>
<td align="right">6.69</td>
<td align="right">6.44</td>
<td align="right">6.49</td>
<td align="right">5.41</td>
<td align="right">6.59</td>
<td align="right">6.71</td>
<td align="right">8.18</td>
</tr>
</tbody>
</table>
<p>Here we have various Treasury yields (3-month, 1-year, 2-year, 3-year, 5-year, 7-year and 10-year) and the 30-year fixed mortgage rate. The Treasury yields are available daily, but the mortgage rate survey is weekly (published Thursdays). We could have asked for the weekly Treasury yields, but they would have been for Fridays. Instead, we can do a custom aggregation to compare weekly averages ending Thursday with the mortgage rates. The survey is really Monday to Wednesday so if we wanted to be extra precise we could adjust for that too, but for our purposes today the week-ending Thursday approach will be good enough.</p>
<p>What we’ll do is create a date2 variable that’s only present when the mortgage rate survey data is available.</p>
<pre class="r"><code>df2 &lt;- df2 %&gt;%   
  mutate(id=as.numeric(rel(!is.na(MORTGAGE30US))), id2=cumsum(id)+1*(id==0) )  %&gt;%
  mutate(date2=ifelse(id==1,date,NA)) %&gt;% 
                  fill(date2, .direction=&quot;up&quot;) %&gt;% 
                  mutate(date2=as.Date(date2,origin=&quot;1970-01-01&quot;))

knitr::kable(head(df2,10))</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">date</th>
<th align="right">DGS1</th>
<th align="right">DGS10</th>
<th align="right">DGS2</th>
<th align="right">DGS3</th>
<th align="right">DGS3MO</th>
<th align="right">DGS5</th>
<th align="right">DGS7</th>
<th align="right">MORTGAGE30US</th>
<th align="right">id</th>
<th align="right">id2</th>
<th align="left">date2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">2000-01-03</td>
<td align="right">6.09</td>
<td align="right">6.58</td>
<td align="right">6.38</td>
<td align="right">6.42</td>
<td align="right">5.48</td>
<td align="right">6.50</td>
<td align="right">6.65</td>
<td align="right">NA</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="left">2000-01-07</td>
</tr>
<tr class="even">
<td align="left">2000-01-04</td>
<td align="right">6.00</td>
<td align="right">6.49</td>
<td align="right">6.30</td>
<td align="right">6.34</td>
<td align="right">5.43</td>
<td align="right">6.40</td>
<td align="right">6.56</td>
<td align="right">NA</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="left">2000-01-07</td>
</tr>
<tr class="odd">
<td align="left">2000-01-05</td>
<td align="right">6.05</td>
<td align="right">6.62</td>
<td align="right">6.38</td>
<td align="right">6.43</td>
<td align="right">5.44</td>
<td align="right">6.51</td>
<td align="right">6.68</td>
<td align="right">NA</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="left">2000-01-07</td>
</tr>
<tr class="even">
<td align="left">2000-01-06</td>
<td align="right">6.03</td>
<td align="right">6.57</td>
<td align="right">6.35</td>
<td align="right">6.39</td>
<td align="right">5.41</td>
<td align="right">6.46</td>
<td align="right">6.63</td>
<td align="right">NA</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="left">2000-01-07</td>
</tr>
<tr class="odd">
<td align="left">2000-01-07</td>
<td align="right">6.00</td>
<td align="right">6.52</td>
<td align="right">6.31</td>
<td align="right">6.35</td>
<td align="right">5.38</td>
<td align="right">6.42</td>
<td align="right">6.58</td>
<td align="right">8.15</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="left">2000-01-07</td>
</tr>
<tr class="even">
<td align="left">2000-01-10</td>
<td align="right">6.07</td>
<td align="right">6.57</td>
<td align="right">6.38</td>
<td align="right">6.42</td>
<td align="right">5.42</td>
<td align="right">6.49</td>
<td align="right">6.62</td>
<td align="right">NA</td>
<td align="right">0</td>
<td align="right">2</td>
<td align="left">2000-01-14</td>
</tr>
<tr class="odd">
<td align="left">2000-01-11</td>
<td align="right">6.13</td>
<td align="right">6.67</td>
<td align="right">6.45</td>
<td align="right">6.49</td>
<td align="right">5.43</td>
<td align="right">6.57</td>
<td align="right">6.72</td>
<td align="right">NA</td>
<td align="right">0</td>
<td align="right">2</td>
<td align="left">2000-01-14</td>
</tr>
<tr class="even">
<td align="left">2000-01-12</td>
<td align="right">6.16</td>
<td align="right">6.72</td>
<td align="right">6.49</td>
<td align="right">6.53</td>
<td align="right">5.45</td>
<td align="right">6.63</td>
<td align="right">6.76</td>
<td align="right">NA</td>
<td align="right">0</td>
<td align="right">2</td>
<td align="left">2000-01-14</td>
</tr>
<tr class="odd">
<td align="left">2000-01-13</td>
<td align="right">6.10</td>
<td align="right">6.63</td>
<td align="right">6.40</td>
<td align="right">6.45</td>
<td align="right">5.41</td>
<td align="right">6.54</td>
<td align="right">6.67</td>
<td align="right">NA</td>
<td align="right">0</td>
<td align="right">2</td>
<td align="left">2000-01-14</td>
</tr>
<tr class="even">
<td align="left">2000-01-14</td>
<td align="right">6.13</td>
<td align="right">6.69</td>
<td align="right">6.44</td>
<td align="right">6.49</td>
<td align="right">5.41</td>
<td align="right">6.59</td>
<td align="right">6.71</td>
<td align="right">8.18</td>
<td align="right">1</td>
<td align="right">2</td>
<td align="left">2000-01-14</td>
</tr>
</tbody>
</table>
<p>Then we can group by this date variable and compute averages of the daily Treasury yields.</p>
<pre class="r"><code>df3 &lt;- 
  df2 %&gt;%
  group_by(date2) %&gt;% 
  select(-date,-id,-id2) %&gt;% 
  summarize_all(mean, na.rm=T) %&gt;% 
  rename(date=date2) %&gt;%
  mutate(year=year(date), 
         yearf=factor(year), #will use for color later
         spread10y2y=DGS10-DGS2)

knitr::kable(head(df3,10))</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">date</th>
<th align="right">DGS1</th>
<th align="right">DGS10</th>
<th align="right">DGS2</th>
<th align="right">DGS3</th>
<th align="right">DGS3MO</th>
<th align="right">DGS5</th>
<th align="right">DGS7</th>
<th align="right">MORTGAGE30US</th>
<th align="right">year</th>
<th align="left">yearf</th>
<th align="right">spread10y2y</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">2000-01-07</td>
<td align="right">6.0340</td>
<td align="right">6.556</td>
<td align="right">6.3440</td>
<td align="right">6.3860</td>
<td align="right">5.428</td>
<td align="right">6.4580</td>
<td align="right">6.6200</td>
<td align="right">8.15</td>
<td align="right">2000</td>
<td align="left">2000</td>
<td align="right">0.2120</td>
</tr>
<tr class="even">
<td align="left">2000-01-14</td>
<td align="right">6.1180</td>
<td align="right">6.656</td>
<td align="right">6.4320</td>
<td align="right">6.4760</td>
<td align="right">5.424</td>
<td align="right">6.5640</td>
<td align="right">6.6960</td>
<td align="right">8.18</td>
<td align="right">2000</td>
<td align="left">2000</td>
<td align="right">0.2240</td>
</tr>
<tr class="odd">
<td align="left">2000-01-21</td>
<td align="right">6.1300</td>
<td align="right">6.765</td>
<td align="right">6.4750</td>
<td align="right">6.5325</td>
<td align="right">5.505</td>
<td align="right">6.6525</td>
<td align="right">6.7825</td>
<td align="right">8.26</td>
<td align="right">2000</td>
<td align="left">2000</td>
<td align="right">0.2900</td>
</tr>
<tr class="even">
<td align="left">2000-01-28</td>
<td align="right">6.1700</td>
<td align="right">6.684</td>
<td align="right">6.4820</td>
<td align="right">6.5380</td>
<td align="right">5.588</td>
<td align="right">6.6320</td>
<td align="right">6.7180</td>
<td align="right">8.25</td>
<td align="right">2000</td>
<td align="left">2000</td>
<td align="right">0.2020</td>
</tr>
<tr class="odd">
<td align="left">2000-02-04</td>
<td align="right">6.2380</td>
<td align="right">6.584</td>
<td align="right">6.6060</td>
<td align="right">6.6280</td>
<td align="right">5.686</td>
<td align="right">6.6560</td>
<td align="right">6.6960</td>
<td align="right">8.25</td>
<td align="right">2000</td>
<td align="left">2000</td>
<td align="right">-0.0220</td>
</tr>
<tr class="even">
<td align="left">2000-02-11</td>
<td align="right">6.2040</td>
<td align="right">6.618</td>
<td align="right">6.6760</td>
<td align="right">6.7360</td>
<td align="right">5.680</td>
<td align="right">6.7640</td>
<td align="right">6.7980</td>
<td align="right">8.36</td>
<td align="right">2000</td>
<td align="left">2000</td>
<td align="right">-0.0580</td>
</tr>
<tr class="odd">
<td align="left">2000-02-18</td>
<td align="right">6.2300</td>
<td align="right">6.550</td>
<td align="right">6.6520</td>
<td align="right">6.7060</td>
<td align="right">5.730</td>
<td align="right">6.7380</td>
<td align="right">6.7600</td>
<td align="right">8.38</td>
<td align="right">2000</td>
<td align="left">2000</td>
<td align="right">-0.1020</td>
</tr>
<tr class="even">
<td align="left">2000-02-25</td>
<td align="right">6.2225</td>
<td align="right">6.380</td>
<td align="right">6.5375</td>
<td align="right">6.5675</td>
<td align="right">5.810</td>
<td align="right">6.5850</td>
<td align="right">6.6300</td>
<td align="right">8.31</td>
<td align="right">2000</td>
<td align="left">2000</td>
<td align="right">-0.1575</td>
</tr>
<tr class="odd">
<td align="left">2000-03-03</td>
<td align="right">6.1840</td>
<td align="right">6.394</td>
<td align="right">6.5080</td>
<td align="right">6.5520</td>
<td align="right">5.778</td>
<td align="right">6.5840</td>
<td align="right">6.6360</td>
<td align="right">8.27</td>
<td align="right">2000</td>
<td align="left">2000</td>
<td align="right">-0.1140</td>
</tr>
<tr class="even">
<td align="left">2000-03-10</td>
<td align="right">6.1800</td>
<td align="right">6.386</td>
<td align="right">6.5120</td>
<td align="right">6.5620</td>
<td align="right">5.840</td>
<td align="right">6.6000</td>
<td align="right">6.6200</td>
<td align="right">8.23</td>
<td align="right">2000</td>
<td align="left">2000</td>
<td align="right">-0.1260</td>
</tr>
</tbody>
</table>
</div>
<div id="mortgage-rate-plot" class="section level2">
<h2>mortgage rate plot</h2>
<p>Let’s focus on the 30-year mortgage rates and create a plot like the one above.</p>
<div id="colors" class="section level3">
<h3>colors</h3>
<p>For most of the plots below, we’ll use a custom color scale. We’ll follow this <a href="https://drsimonj.svbtle.com/creating-corporate-colour-palettes-for-ggplot2">post</a> by Simon Jackson that describes how to create custom color palettes for ggplot2.</p>
<pre class="r"><code>  # Function for colors ----
  #####################################################################################
  ## Make Color Scale ----  ##
  #####################################################################################
  my_colors &lt;- c(
    &quot;green&quot;      = rgb(103,180,75, maxColorValue = 256),
    &quot;green2&quot;      = rgb(147,198,44, maxColorValue = 256),
    &quot;lightblue&quot;  =  rgb(9, 177,240, maxColorValue = 256),
    &quot;lightblue2&quot; = rgb(173,216,230, maxColorValue = 256),
    &#39;blue&#39;       = &quot;#00aedb&quot;,
    &#39;red&#39;        = &quot;#d11141&quot;,
    &#39;orange&#39;     = &quot;#f37735&quot;,
    &#39;yellow&#39;     = &quot;#ffc425&quot;,
    &#39;gold&#39;       = &quot;#FFD700&quot;,
    &#39;light grey&#39; = &quot;#cccccc&quot;,
    &#39;purple&#39;     = &quot;#551A8B&quot;,
    &#39;dark grey&#39;  = &quot;#8c8c8c&quot;)
  
  
  my_cols &lt;- function(...) {
    cols &lt;- c(...)
    if (is.null(cols))
      return (my_colors)
    my_colors[cols]
  }
  
  
  my_palettes &lt;- list(
    `main`  = my_cols(&quot;blue&quot;, &quot;green&quot;, &quot;yellow&quot;),
    `cool`  = my_cols(&quot;blue&quot;, &quot;green&quot;),
    `hot`   = my_cols(&quot;yellow&quot;, &quot;orange&quot;, &quot;red&quot;),
    `mixed` = my_cols(&quot;lightblue&quot;, &quot;green&quot;, &quot;yellow&quot;, &quot;orange&quot;, &quot;red&quot;),
    `mixed2` = my_cols(&quot;lightblue2&quot;,&quot;lightblue&quot;, &quot;green&quot;, &quot;green2&quot;,&quot;yellow&quot;,&quot;gold&quot;, &quot;orange&quot;, &quot;red&quot;),
    `mixed3` = my_cols(&quot;lightblue2&quot;,&quot;lightblue&quot;, &quot;green&quot;, &quot;yellow&quot;,&quot;gold&quot;, &quot;orange&quot;, &quot;red&quot;),
    `mixed4` = my_cols(&quot;lightblue2&quot;,&quot;lightblue&quot;, &quot;green&quot;, &quot;green2&quot;,&quot;yellow&quot;,&quot;gold&quot;, &quot;orange&quot;, &quot;red&quot;,&quot;purple&quot;),
    `mixed5` = my_cols(&quot;lightblue&quot;,&quot;green&quot;, &quot;green2&quot;,&quot;yellow&quot;,&quot;gold&quot;, &quot;orange&quot;, &quot;red&quot;,&quot;purple&quot;,&quot;blue&quot;),
    `mixed6` = my_cols(&quot;green&quot;, &quot;gold&quot;, &quot;orange&quot;, &quot;red&quot;,&quot;purple&quot;,&quot;blue&quot;),
    `grey`  = my_cols(&quot;light grey&quot;, &quot;dark grey&quot;)
  )
  
  
  my_pal &lt;- function(palette = &quot;main&quot;, reverse = FALSE, ...) {
    pal &lt;- my_palettes[[palette]]
    
    if (reverse) pal &lt;- rev(pal)
    
    colorRampPalette(pal, ...)
  }
  
  
  scale_color_mycol &lt;- function(palette = &quot;main&quot;, discrete = TRUE, reverse = FALSE, ...) {
    pal &lt;- my_pal(palette = palette, reverse = reverse)
    
    if (discrete) {
      discrete_scale(&quot;colour&quot;, paste0(&quot;my_&quot;, palette), palette = pal, ...)
    } else {
      scale_color_gradientn(colours = pal(256), ...)
    }
  }
  
  
  
  scale_fill_mycol &lt;- function(palette = &quot;main&quot;, discrete = TRUE, reverse = FALSE, ...) {
    pal &lt;- my_pal(palette = palette, reverse = reverse)
    
    if (discrete) {
      discrete_scale(&quot;fill&quot;, paste0(&quot;my_&quot;, palette), palette = pal, ...)
    } else {
      scale_fill_gradientn(colours = pal(256), ...)
    }
  }</code></pre>
<p>Here’s the code that creates our plot. I’m going to present this code as is, but later on we’re going to improve it by removing some of the repetition and take advantage of new ggplot2 features.</p>
<pre class="r"><code>  df.mtg&lt;- filter(df.rates, symbol==&quot;MORTGAGE30US&quot;, year(date)&gt;=2000) %&gt;%
    mutate(year=year(date), 
           yearf=factor(year)) %&gt;% 
  group_by(year) %&gt;% 
  mutate(week=row_number()) %&gt;% 
  ungroup()
  
  df.mtg$year &lt;- year(df.mtg$date)
  dlist &lt;- unique(df.mtg$date)
  N &lt;- length(dlist)
  
  dlist &lt;- unique(df.mtg$date)
  N &lt;- length(dlist)
  W &lt;- max(df.mtg$week)
  
  lp&lt;- tail(df.mtg,1)$price
  g.line &lt;- 
    ggplot(data=df.mtg ,
           aes(x=date,y=price, fill=yearf,color=yearf))+
    geom_ribbon(alpha=0.4, color=NA, aes(ymin=lp,ymax=price))+
    geom_ribbon(alpha=0.05, color=NA, aes(ymin=3.5,ymax=price))+
    geom_ribbon(alpha=0.05,  color=NA, aes(ymin=3,ymax=price))+
    geom_ribbon(alpha=0.05, color=NA, aes(ymin=2.5,ymax=price))+
    geom_ribbon(alpha=0.05, color=NA, aes(ymin=1,ymax=price))+
    geom_ribbon(alpha=0.05, color=NA, aes(ymin=0,ymax=price))+
    geom_hline(yintercept=lp, linetype=2)+
    geom_line(size=1.1)+
    scale_color_mycol(&quot;mixed5&quot;)+
    scale_fill_mycol(&quot;mixed5&quot;)+
    theme_minimal(base_size=16)+
    theme(legend.position=&quot;none&quot;)+
    geom_text( data= filter(df.mtg, year&gt; 1999 &amp; week==26 &amp; year&lt;2018 | (year==2018 &amp; week==14)), 
               aes(y=3.25,label=yearf),size=3)+
    scale_y_continuous(limits=c(0,9.1),breaks=seq(0,9,1),sec.axis=dup_axis(),expand=c(0,0))+
    scale_x_date(limits=as.Date(c(&quot;2000-01-01&quot;,&quot;2018-07-15&quot;)),date_breaks=&quot;1 year&quot;,date_labels=&quot;%Y&quot;,expand=c(0,0))+
    labs(x=&quot;&quot;,y=&quot;30-year fixed mortgage rate (%)\n&quot;,
         subtitle=&quot;U.S. weekly average mortgage rates\ndotted line 4.52%, weekly average for July 05, 2018&quot;,
         title=&quot;Mortgage rate trends&quot;,
         caption=&quot;@lenkiefer Source: Freddie Mac Primary Mortgage Market Survey&quot;)+
    theme(plot.caption=element_text(hjust=0))
  g.line</code></pre>
<p><img src="http://lenkiefer.com/post/2018-07-07-mortgage-rates-in-the-21st-century_files/figure-html/07-07-2018-plot-1-1.png" width="960" /></p>
</div>
</div>
</div>
<div id="taking-advantage-of-new-ggplot2-features" class="section level1">
<h1>Taking advantage of new ggplot2 features</h1>
<p>Let’s see if we can’t streamline our code a bit. Notice that that we use multiple calls of <code>geom_ribbon</code>. Let’s eliminate that by creating a function:</p>
<pre class="r"><code>  myr0 &lt;- function(x, a=0.02){
    geom_ribbon(alpha=a, color=NA, aes(ymin=0,ymax=min(x, !!var )))    
  }
  myr &lt;- function(x, a=0.02){
  geom_ribbon(alpha=a, color=NA, aes(ymin=min(x, !!var )))    
  }</code></pre>
<p>Notice the <code>!! var1</code>? We’ll get back to that in a bit. The function s<code>myr0</code> hades up from 0 to the minimum of x and <code>!!var</code>. The function <code>myr</code> shades from x up (or down) to ymax (definied elsewhere). We can use <code>!!var</code> in another function call to pass variable names.</p>
<p>Read more about tidy evaluation and <code>!!</code> in this helpful tutorial <a href="https://dplyr.tidyverse.org/articles/programming.html" class="uri">https://dplyr.tidyverse.org/articles/programming.html</a>.</p>
<pre class="r"><code>  myf &lt;- function(var=DGS10, my.ylab=NULL){
    var &lt;-  enquo(var)

    if(missing(my.ylab)) {my.ylab=var} 
    
    myr0 &lt;- function(x, a=0.02){
    geom_ribbon(alpha=a, color=NA, aes(ymin=0,ymax=min(x, !!var )))    
      }
    
    myr &lt;- function(x, a=0.02){
      geom_ribbon(alpha=a, color=NA, aes(ymin=min(x, !!var )))    
      }
    
    ggplot(data=df3 ,
           aes(x=date,y=!!var, ymax= !! var , fill=yearf,color=yearf))+
      geom_line()+
      geom_ribbon(alpha=0.5, color=NA, aes(ymin=last(!!var)))+
      map(c(0,pull(df3,!!var) %&gt;% min()) %&gt;% pretty(12), myr0, a=0.01)+
      map(c(0,pull(df3,!!var) %&gt;% last()) %&gt;% pretty(12), myr, a=0.015)+
      
      geom_hline(aes(yintercept=last(!!var)), linetype=2)+
      geom_line(size=1.1)+
      scale_color_mycol(&quot;mixed5&quot;)+
      scale_fill_mycol(&quot;mixed5&quot;)+
      theme_minimal(base_size=14)  +
      theme(legend.position=&quot;none&quot;)+
      scale_y_continuous(breaks=seq(0,9,1),
                         #limits=c(0,9.1),
                         sec.axis=dup_axis(),expand=c(0,0))+
      scale_x_date(limits=as.Date(c(&quot;2000-01-01&quot;,&quot;2018-07-15&quot;)),date_breaks=&quot;1 year&quot;,date_labels=&quot;%Y&quot;,expand=c(0,0))+
      labs(x=&quot;&quot;,y=my.ylab,
           subtitle=&quot;Dotted line at last observation&quot;,
           title=&quot;Rate trends&quot;,
           caption=&quot;@lenkiefer Source: Federal Reserve H.15, Freddie Mac Primary Mortgage Market Survey\nWeekly averages (daily Treasury yields averaged over week ending Thursday)&quot;)+
      theme(plot.caption=element_text(hjust=0))
  }
  
  myf(var=DGS10, my.ylab=&quot;10-year Treasury Yield (%)&quot;)+ labs(title=&quot;U.S. Treasury Yields: 10-year Constant Maturity&quot;)</code></pre>
<p><img src="http://lenkiefer.com/post/2018-07-07-mortgage-rates-in-the-21st-century_files/figure-html/07-07-2018-plot-3-1.png" width="960" /></p>
<p>So how does this work? We pass a variable name (<em>e.g.</em> DGS10 for 10-year yield) and the tidy evaluation helpers in ggplot2 pass that as a variable to the ggplot2 function call. In my chart I want the ribbon shading to gradually fade to 0 so I map over a bunch of values (spaced via <code>pretty</code>). With alpha set to a small value for low transparency the shading fades with diminishing overlap near the bottom of the chart.</p>
<p>Then we can easily call our function for other variables.</p>
<pre class="r"><code>  myf(spread10y2y)+ labs(title=&quot;U.S. Treasury Yield Curve Slope: 10-year minus 2-year&quot;, y=&quot;10-year CMT - 2-year CMT (%)&quot;)</code></pre>
<p><img src="http://lenkiefer.com/post/2018-07-07-mortgage-rates-in-the-21st-century_files/figure-html/07-07-2018-plot-4-1.png" width="960" /></p>
<pre class="r"><code>  myf(DGS1)+ labs(title=&quot;U.S. Treasury Yields: 1-year Constant Maturity&quot;, y=&quot;1-year CMT (%)&quot;)</code></pre>
<p><img src="http://lenkiefer.com/post/2018-07-07-mortgage-rates-in-the-21st-century_files/figure-html/07-07-2018-plot-4-2.png" width="960" /></p>
<pre class="r"><code>  myf(DGS3MO)+ labs(title=&quot;U.S. Treasury Yields: 3-month Constant Maturity&quot;,  y=&quot;3-month CMT (%)&quot;)</code></pre>
<p><img src="http://lenkiefer.com/post/2018-07-07-mortgage-rates-in-the-21st-century_files/figure-html/07-07-2018-plot-4-3.png" width="960" /></p>
</div>
<div id="yield-curve-plot" class="section level1">
<h1>Yield Curve Plot</h1>
<p>While we have these data handy, how about we make a yield curve plot? It would be interesting to plot the time to maturity agains the yield and see how that has varied over time.</p>
<p>We’ve already got the data, we just need to wrangle it a bit.</p>
<pre class="r"><code># for yield curve ----
yc &lt;- data.frame(symbol=c(&quot;DGS3MO&quot;,
                          &quot;DGS1&quot;,
                          &quot;DGS2&quot;,
                          &quot;DGS3&quot;,
                          &quot;DGS5&quot;,
                          &quot;DGS7&quot;,
                          &quot;DGS10&quot;),
                 months=c(3,12,24,36,60,84,120),
                 ttm=c(&quot;3 months&quot;,&quot;1 year&quot;, &quot;2 years&quot;,&quot;3 years&quot;,&quot;5 years&quot;,&quot;7 years&quot;,&quot;10 years&quot;))

df.yc &lt;- left_join(df.rates,yc,by=&quot;symbol&quot;) %&gt;% 
  filter(symbol !=&quot;MORTGAGE30US&quot;) %&gt;%  # drop mortgage rate data 
  filter(!is.na(price))
knitr::kable(head(df.yc,10))</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">symbol</th>
<th align="left">date</th>
<th align="right">price</th>
<th align="right">months</th>
<th align="left">ttm</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">DGS3MO</td>
<td align="left">2000-01-03</td>
<td align="right">5.48</td>
<td align="right">3</td>
<td align="left">3 months</td>
</tr>
<tr class="even">
<td align="left">DGS3MO</td>
<td align="left">2000-01-04</td>
<td align="right">5.43</td>
<td align="right">3</td>
<td align="left">3 months</td>
</tr>
<tr class="odd">
<td align="left">DGS3MO</td>
<td align="left">2000-01-05</td>
<td align="right">5.44</td>
<td align="right">3</td>
<td align="left">3 months</td>
</tr>
<tr class="even">
<td align="left">DGS3MO</td>
<td align="left">2000-01-06</td>
<td align="right">5.41</td>
<td align="right">3</td>
<td align="left">3 months</td>
</tr>
<tr class="odd">
<td align="left">DGS3MO</td>
<td align="left">2000-01-07</td>
<td align="right">5.38</td>
<td align="right">3</td>
<td align="left">3 months</td>
</tr>
<tr class="even">
<td align="left">DGS3MO</td>
<td align="left">2000-01-10</td>
<td align="right">5.42</td>
<td align="right">3</td>
<td align="left">3 months</td>
</tr>
<tr class="odd">
<td align="left">DGS3MO</td>
<td align="left">2000-01-11</td>
<td align="right">5.43</td>
<td align="right">3</td>
<td align="left">3 months</td>
</tr>
<tr class="even">
<td align="left">DGS3MO</td>
<td align="left">2000-01-12</td>
<td align="right">5.45</td>
<td align="right">3</td>
<td align="left">3 months</td>
</tr>
<tr class="odd">
<td align="left">DGS3MO</td>
<td align="left">2000-01-13</td>
<td align="right">5.41</td>
<td align="right">3</td>
<td align="left">3 months</td>
</tr>
<tr class="even">
<td align="left">DGS3MO</td>
<td align="left">2000-01-14</td>
<td align="right">5.41</td>
<td align="right">3</td>
<td align="left">3 months</td>
</tr>
</tbody>
</table>
<pre class="r"><code>dlist.yc &lt;- unique(df.yc$date)
N &lt;- length(dlist.yc)
# dlist.yc[year(dlist.yc)==2018] find starting dates row number = 4504
i.start &lt;- 4504

myplotf &lt;- function(i=i.start){


in.df &lt;- filter(df.yc,date %in% dlist.yc[c(i-30,i)]) %&gt;% group_by(ttm) %&gt;% mutate(pmax=max(price), pmin=min(price)) %&gt;%
  mutate(p.up = ifelse(date==max(date),price, pmin),
         p.down = ifelse(date==max(date),price, pmax))

g.line &lt;- 
ggplot(data=in.df, aes(x=months,y=price, group=date, linetype=factor(date),color=factor(date)))+
  theme_minimal(base_size=14)+
  scale_x_continuous(breaks=yc$months, labels=yc$ttm)+
  geom_ribbon(aes(ymin=pmin, ymax=p.up, fill=&quot;up&quot;),alpha=0.25,color=NA)+
  geom_ribbon(aes(ymin=pmax, ymax=p.down, fill=&quot;down&quot;), alpha=0.25)+
  geom_point(size=4)+
  geom_path()+
  scale_color_mycol(&quot;mixed&quot;,reverse=T, name=&quot;Date&quot;)+
  scale_fill_mycol(&quot;mixed&quot;,reverse=T, name=&quot;Date&quot;)+
  guides(fill=F,linetype=F)+
  theme(legend.position=&quot;top&quot;)+
  labs(x=&quot;time to maturity&quot;,y=&quot;Yield (%)&quot;,
       title=&quot;U.S. Treasury Yield Curve&quot;,
       subtitle=&quot;Blue: current day, Red: 30 trading days prior&quot;)+
  scale_y_continuous(limits=c(0,3.5),breaks=seq(0,3.5,0.5))

g.bar &lt;- 
ggplot(data=in.df, aes(x=months,
                       y=p.down-price))+
  geom_col(aes(fill=&quot;yield up&quot;),alpha=0.5)+
  geom_col(aes(y=p.up-price,fill=&quot;yield down&quot;),alpha=0.5)+
  theme_minimal(base_size=14)+
  scale_x_continuous(breaks=yc$months, labels=yc$ttm)+
  scale_y_continuous(limits=c(-0.6,0.6))+
  scale_color_mycol(&quot;mixed&quot;,reverse=T, name=&quot;Change&quot;)+
  scale_fill_mycol(&quot;mixed&quot;,reverse=T, name=&quot;Change&quot;)+
  theme(legend.position=&quot;top&quot;,
        plot.caption=element_text(hjust=0))+
  labs(x=&quot;time to maturity&quot;,y=&quot;change in yield (%)&quot;,title=&quot;&quot;,
       caption=&quot;@lenkiefer Source: Board of Governors of the Federal Reserve System (US), H.15 Selected Interest Rates\nretrieved from FRED, Federal Reserve Bank of St. Louis; July 6, 2018 &quot;)

 g&lt;- cowplot::plot_grid(g.line,g.bar,ncol=1,rel_heights = c(2,1), align=&quot;hv&quot;)  # use cowplot for multiple plots
}


myplotf(N) %&gt;% print</code></pre>
<p><img src="http://lenkiefer.com/post/2018-07-07-mortgage-rates-in-the-21st-century_files/figure-html/07-07-2018-plot-5-1.png" width="960" /></p>
<p>If we wanted to have fun with this we could animate it:</p>
<pre class="r"><code>library(animation)
oopt&lt;-ani.options(interval=1/10)
suppressMessages(
  saveGIF({for (i in i.start:N){
  g&lt;- myplotf(i)
  print(g)
  print(paste(i-i.start+1,&quot;out of&quot;,N-i.start))
    ani.pause()
  }
    for (ii in 1:20){
      print(g)
      ani.pause()
      print(paste(ii,&quot;out of&quot;,20))
    }
  }, movie.name = &quot;YOURDIRECTORY/ycv2_2018.gif&quot;,  ani.width=1200, ani.height=1200)  # set YOURDIRECTORY where you want to save file
)</code></pre>
<p><img src="../../../../img/charts_jul_07_2018/ycv2_2018.gif"></p>
<p>We could also play with the code above along the lines of <a href="../../../../2018/05/21/pomological-plots/">this post</a> to generate some other animations:</p>
<p><img src="../../../../img/charts_jul_07_2018/rate_egg_line_v3d.gif"></p>
<p>Or if we wanted to be a little more intense:</p>
<p><img src="../../../../img/charts_jul_07_2018/rate_dist_july07_2018.gif"></p>
</div>
<div id="conclusion" class="section level1">
<h1>Conclusion</h1>
<p>We built a bunch of charts and tried out some new ggplot2 features. Could this work for you?</p>
</div>

  
  <h4><i class="fas fa-share-alt" aria-hidden="true"></i>&nbsp;Share!</h4>
<ul class="share-buttons">
	<li><a href="https://twitter.com/intent/tweet?url=http%3a%2f%2flenkiefer.com%2f2018%2f07%2f07%2fmortgage-rates-in-the-21st-century%2f" target="_blank" title="Tweet"><i class="fab fa-twitter" aria-hidden="true"></i><span class="sr-only">Tweet</span></a>
	</li>
</ul>


<style>
	ul.share-buttons{
	  list-style: none;
	  padding: 0;
	}

	ul.share-buttons li{
	  display: inline;
	}

	ul.share-buttons .sr-only{
	  position: absolute;
	  clip: rect(1px 1px 1px 1px);
	  clip: rect(1px, 1px, 1px, 1px);
	  padding: 0;
	  border: 0;
	  height: 1px;
	  width: 1px;
	  overflow: hidden;
	}
</style>


  
<div class="prev-next-post pure-g">
  <div class="pure-u-1-24" style="text-align: left;">
    
    <a href="http://lenkiefer.com/2018/07/01/exploring-housing-data-with-r-and-ipums-usa/"><i class="fa fa-chevron-left"></i></a>
    
  </div>
  <div class="pure-u-10-24">
    
    <nav class="prev">
      <a href="http://lenkiefer.com/2018/07/01/exploring-housing-data-with-r-and-ipums-usa/">Exploring housing data with R and IPUMS USA</a>
    </nav>
    
  </div>
  <div class="pure-u-2-24">
    &nbsp;
  </div>
  <div class="pure-u-10-24">
    
    <nav class="next">
      <a href="http://lenkiefer.com/2018/07/14/new-blog-style/">New Blog Style!</a>
    </nav>
    
  </div>
  <div class="pure-u-1-24" style="text-align: right;">
    
    <a href="http://lenkiefer.com/2018/07/14/new-blog-style/"><i class="fa fa-chevron-right"></i></a>
    
  </div>
</div>


  
  
  
  

  

</div>

</div>
</div>
<script src="http://lenkiefer.com/js/ui.js"></script>
<script src="http://lenkiefer.com/js/menus.js"></script>




<script>
  
  if (window.location.hostname != "localhost") {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-66905937-1', 'auto');
    ga('send', 'pageview');
  }
</script>





<script src="http://lenkiefer.com/js/math-code.js"></script>
  <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>
  


</body>
</html>

